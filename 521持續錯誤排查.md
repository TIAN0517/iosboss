# ğŸ” 521 éŒ¯èª¤æŒçºŒå­˜åœ¨ - æ·±åº¦æ’æŸ¥

## âœ… å·²ç¢ºèªçš„ç‹€æ…‹

- âœ… Token å·²è¨­ç½®
- âœ… Tunnel å®¹å™¨å·²å•Ÿå‹•
- âœ… é…ç½®æ­£ç¢ºï¼š`linebot.jytian.it.com` â†’ `http://nginx:80`
- âŒ å¤–ç¶²è¨ªå•ï¼šæŒçºŒ 521 éŒ¯èª¤

## ğŸ” æ·±åº¦æ’æŸ¥æ­¥é©Ÿ

### 1. æª¢æŸ¥ Cloudflare Dashboard ä¸­çš„å¯¦éš›é…ç½®

**æœ€é‡è¦**ï¼šåœ¨ Cloudflare Dashboard ä¸­æ‰‹å‹•æª¢æŸ¥é…ç½®ã€‚

1. è¨ªå•ï¼šhttps://one.dash.cloudflare.com/access/tunnels
2. é»æ“Š `jyt-gas-tunnel`
3. é€²å…¥ **Published Application Routes** æˆ– **Public Hostname**
4. **ç¢ºèªä»¥ä¸‹é…ç½®**ï¼š
   - âœ… Hostname: `linebot.jytian.it.com`
   - âœ… Service: `http://nginx:80`ï¼ˆå¿…é ˆæ˜¯é€™å€‹ï¼Œä¸èƒ½æ˜¯ `app:9999`ï¼‰
   - âœ… Path: `/` æˆ–ç©ºï¼ˆä¸æ‡‰è©²æœ‰è·¯å¾‘é™åˆ¶ï¼‰

### 2. æª¢æŸ¥ Cloudflare DNS è¨­ç½®

1. è¨ªå•ï¼šhttps://dash.cloudflare.com/
2. é¸æ“‡åŸŸåï¼š`jytian.it.com`
3. é€²å…¥ **DNS** è¨­ç½®
4. **æª¢æŸ¥æ˜¯å¦æœ‰ `linebot` çš„è¨˜éŒ„**ï¼š
   - å¦‚æœæ²’æœ‰ï¼Œéœ€è¦æ·»åŠ ï¼š
     - **Type**: CNAME
     - **Name**: `linebot`
     - **Target**: `jytian.it.com` æˆ– `@`
     - **Proxy status**: å·²ä»£ç†ï¼ˆæ©™è‰²é›²æœµï¼‰âœ…
   - å¦‚æœæœ‰ï¼Œç¢ºèªä»£ç†ç‹€æ…‹æ˜¯ **å·²ä»£ç†**

### 3. æª¢æŸ¥ SSL/TLS è¨­ç½®

1. é€²å…¥ **SSL/TLS** â†’ **Overview**
2. **å¿…é ˆæ˜¯ Full æˆ– Full (strict)**
3. ä¸èƒ½æ˜¯ Flexibleï¼ˆæœƒå°è‡´ 521ï¼‰

### 4. æª¢æŸ¥ Cloudflare ç·©å­˜

1. é€²å…¥ **Caching** â†’ **Configuration**
2. é»æ“Š **Purge Everything**
3. ç­‰å¾… 1-2 åˆ†é˜

### 5. æª¢æŸ¥ Tunnel é€£æ¥ç‹€æ…‹

åœ¨ Cloudflare Dashboard ä¸­ï¼š
1. é€²å…¥ Tunnel è©³æƒ…é 
2. æª¢æŸ¥ **Connectors** æ¨™ç±¤
3. ç¢ºèªæœ‰æ´»èºçš„ Connector
4. ç¢ºèª Connector ç‹€æ…‹æ˜¯ **Active** æˆ– **Connected**

## ğŸ› å¸¸è¦‹å•é¡Œ

### Q: é…ç½®éƒ½æ­£ç¢ºï¼Œç‚ºä»€éº¼é‚„æ˜¯ 521ï¼Ÿ

**A:** å¯èƒ½çš„åŸå› ï¼š
1. **Cloudflare è·¯ç”±æ›´æ–°éœ€è¦æ›´é•·æ™‚é–“**ï¼ˆ15-30 åˆ†é˜ï¼‰
2. **DNS è¨˜éŒ„ä¸å­˜åœ¨æˆ–æœªä»£ç†**
3. **SSL/TLS æ¨¡å¼è¨­ç½®éŒ¯èª¤**
4. **Cloudflare ç·©å­˜æœªæ¸…é™¤**

### Q: Service URL æ‡‰è©²æ˜¯ä»€éº¼ï¼Ÿ

**A:** å¿…é ˆæ˜¯ `http://nginx:80`ï¼Œå› ç‚ºï¼š
- Cloudflare Tunnel é€£æ¥åˆ° Docker å…§éƒ¨ç¶²çµ¡
- ä½¿ç”¨æœå‹™åç¨± `nginx`ï¼ˆä¸æ˜¯ `localhost` æˆ– IPï¼‰
- ä½¿ç”¨ç«¯å£ `80`ï¼ˆNginx ç›£è½çš„ç«¯å£ï¼‰

### Q: éœ€è¦æ·»åŠ  DNS è¨˜éŒ„å—ï¼Ÿ

**A:** é€šå¸¸ä¸éœ€è¦ï¼Œå› ç‚º Cloudflare Tunnel æœƒè‡ªå‹•è™•ç†ã€‚ä½†å¦‚æœ 521 æŒçºŒå­˜åœ¨ï¼Œå¯ä»¥å˜—è©¦ï¼š
1. æ·»åŠ  CNAME è¨˜éŒ„ï¼š`linebot` â†’ `jytian.it.com`ï¼ˆå·²ä»£ç†ï¼‰
2. æˆ–æ·»åŠ  A è¨˜éŒ„æŒ‡å‘ Cloudflare çš„ IP

## ğŸ”§ å¼·åˆ¶ä¿®å¾©æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šå®Œå…¨é‡å•Ÿ

```powershell
docker compose down
docker compose up -d
```

### æ­¥é©Ÿ 2ï¼šæª¢æŸ¥ Cloudflare Dashboard

1. ç¢ºèªæ‰€æœ‰é…ç½®æ­£ç¢º
2. æ¸…é™¤ç·©å­˜
3. æª¢æŸ¥ SSL/TLS æ¨¡å¼

### æ­¥é©Ÿ 3ï¼šç­‰å¾…ä¸¦æ¸¬è©¦

ç­‰å¾… **15-30 åˆ†é˜**ï¼Œç„¶å¾Œæ¸¬è©¦ï¼š

```powershell
curl -v https://linebot.jytian.it.com/api/webhook/line
```

ä½¿ç”¨ `-v` åƒæ•¸å¯ä»¥çœ‹åˆ°è©³ç´°çš„ HTTP éŸ¿æ‡‰é ­ã€‚

### æ­¥é©Ÿ 4ï¼šå¦‚æœé‚„æ˜¯ 521

å˜—è©¦åœ¨ Cloudflare Dashboard ä¸­ï¼š
1. **åˆªé™¤ç¾æœ‰çš„ Public Hostname/Route**
2. **é‡æ–°å‰µå»º**ï¼š
   - Hostname: `linebot.jytian.it.com`
   - Service: `http://nginx:80`
   - ä¿å­˜

## ğŸ“‹ å®Œæ•´æª¢æŸ¥æ¸…å–®

- [ ] Cloudflare Dashboard ä¸­ Service URL æ˜¯ `http://nginx:80`
- [ ] DNS è¨˜éŒ„å­˜åœ¨ï¼ˆå¯é¸ï¼Œä½†å»ºè­°æ·»åŠ ï¼‰
- [ ] SSL/TLS æ¨¡å¼æ˜¯ Full
- [ ] Cloudflare ç·©å­˜å·²æ¸…é™¤
- [ ] Tunnel Connector ç‹€æ…‹æ˜¯ Active
- [ ] æ‰€æœ‰ Docker æœå‹™é‹è¡Œæ­£å¸¸
- [ ] ç­‰å¾… 15-30 åˆ†é˜
- [ ] ä½¿ç”¨ `curl -v` æŸ¥çœ‹è©³ç´°éŸ¿æ‡‰

## ğŸ¯ æœ€çµ‚è§£æ±ºæ–¹æ¡ˆ

å¦‚æœæ‰€æœ‰é…ç½®éƒ½æ­£ç¢ºï¼Œä½†é‚„æ˜¯ 521ï¼š

1. **åœ¨ Cloudflare Dashboard ä¸­åˆªé™¤ä¸¦é‡æ–°å‰µå»º Route**
2. **æ·»åŠ  DNS è¨˜éŒ„**ï¼ˆCNAMEï¼š`linebot` â†’ `jytian.it.com`ï¼Œå·²ä»£ç†ï¼‰
3. **æ¸…é™¤æ‰€æœ‰ç·©å­˜**
4. **ç­‰å¾… 30 åˆ†é˜**
5. **å†æ¬¡æ¸¬è©¦**

---

**é‡è¦**ï¼šè«‹åœ¨ Cloudflare Dashboard ä¸­æ‰‹å‹•æª¢æŸ¥æ‰€æœ‰é…ç½®ï¼Œç¢ºä¿ Service URL æ˜¯ `http://nginx:80`ã€‚

