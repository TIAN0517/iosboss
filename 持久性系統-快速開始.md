# 九九瓦斯行管理系統 - 持久性系統快速開始指南

## 🎯 三種使用方式

### 方式 1：立即啟動（開發/測試）

**適合場景：** 開發調試、臨時啟動

```powershell
# 雙擊運行
.\start-with-monitor.bat
```

---

### 方式 2：設置開機自動啟動（生產推薦）

**適合場景：** 生產環境、7x24 運行

**步驟：**

1. **右鍵單擊 `install-scheduled-task.ps1`**
2. **選擇「以管理員身份運行」**
3. **等待安裝完成提示**
4. **重啟電腦測試**

**驗證安裝：**
```powershell
# 查看任務
taskschd.msc

# 或命令行
schtasks /query /tn "JYT-Gas-Services-Monitor"
```

---

### 方式 3：診斷和修復

**適合場景：** 系統出問題時快速排查

```powershell
# 基本診斷
.\diagnose-fix.ps1

# 診斷並自動修復
.\diagnose-fix.ps1 -AutoFix

# 僅檢查，不修復
.\diagnose-fix.ps1 -OnlyCheck
```

---

## 📋 關鍵文件清單

### 📜 核心腳本

| 文件名稱 | 功能 | 何時使用 |
|----------|------|----------|
| `start-with-monitor.bat` | 啟動服務 + 監控 | 日常啟動 |
| `monitor-services.ps1` | 持久性監控守護進程 | 自動運行 |
| `diagnose-fix.ps1` | 診斷和快速修復 | 排查問題 |
| `install-scheduled-task.ps1` | 安裝/卸載任務計劃器 | 生產部署 |

### 📋 輔助腳本

| 文件名稱 | 功能 |
|----------|------|
| `restart.bat` | 簡單重啟服務 |
| `stop.bat` | 停止所有服務 |
| `start.bat` | 一鍵啟動（不含監控） |

### 📘 配置文件

| 文件名稱 | 功能 |
|----------|------|
| `docker-compose.yml` | Docker 服務配置（已優化） |
| `.env.docker` | 環境變量 |
| `cloudflared.yml` | Cloudflare Tunnel 配置 |
| `nginx.cloudflare.conf` | Nginx 反向代理配置 |

### 📔 文檔

| 文件名稱 | 內容 |
|----------|------|
| `持久性部署完成總結.md` | 部署完成報告和詳細說明 |
| `持久性監控系統-使用指南.md` | 完整使用手冊 |

---

## 🚀 快速操作指南

### 啟動和停止

```powershell
# 啟動（含監控）
.\start-with-monitor.bat

# 停止
.\stop.bat

# 重啟
.\restart.bat
```

### 診斷問題

```powershell
# 運行診斷
.\diagnose-fix.ps1

# 診斷 + 自動修復
.\diagnose-fix.ps1 -AutoFix

# 查看日誌
Get-Content logs\monitor.log -Tail 50
```

### 查看服務狀態

```powershell
# 所有容器
docker compose ps

# 特定容器
docker logs jyt-gas-app --tail 50

# 實時日誌
docker compose logs -f
```

### 任務計劃器管理

```powershell
# 安裝任務
.\install-scheduled-task.ps1

# 卸載任務
.\install-scheduled-task.ps1 -Uninstall

# 手動運行
schtasks /run /tn "JYT-Gas-Services-Monitor"

# 查看任務
taskschd.msc
```

---

## ⚠️ 重要提醒

### 第一次使用時

1. **檢查 Docker** - 確保 Docker Desktop 已啟動
2. **配置環境** - 確認 `.env.docker` 中的配置正確
3. **測試啟動** - 先用手動方式測試，確保一切正常
4. **再安裝任務** - 驗證無誤後再安裝任務計劃器

### 日常使用時

1. **不要關閉監控窗口** - 關閉會停止服務
2. **定期檢查日誌** - 查看是否有異常
3. **定期備份數據** - 保護重要數據
4. **保持系統更新** - 定期更新 Docker 鏡像

---

## 🎯 系統組件說明

### 監控守護進程（monitor-services.ps1）

**功能：**
- ✅ 每 30 秒檢查一次所有服務
- ✅ 自動檢測並重啟停止的容器
- ✅ 自動啟動 Docker Desktop（如需要）
- ✅ 每天自動清理 7 天前的日誌
- ✅ 記錄所有操作到日誌文件

**監控的服務：**
- jyt-gas-app（Next.js 應用）
- jyt-gas-nginx（Nginx 代理）
- jyt-gas-postgres（PostgreSQL 資料庫）
- jyt-gas-cloudflared（Cloudflare Tunnel）

### 自動重啟機制

**Docker 層級：**
- `jyt-gas-app`: `unless-stopped` - 除非手動停止
- `jyt-gas-nginx`: `unless-stopped` - 除非手動停止
- `jyt-gas-postgres`: `unless-stopped` - 除非手動停止
- `jyt-gas-cloudflared`: `always` - **任何情況都會重啟**

**監控層級：**
- 檢查頻率：每 30 秒
- 異常處理：自動重啟 + 日誌記錄
- 失敗重試：最多 3 次，每次間隔 5 分鐘

### 任務計劃器（Windows Scheduled Task）

**觸發條件：**
1. 開機時（延遲 2 分鐘）
2. 用戶登錄時（延遲 30 秒）

**重試策略：**
- 失敗後每 5 分鐘重試
- 最多重試 3 次
- 確保網絡可用時運行

---

## 📊 監控指標

### 正常運行指標

| 指標 | 正常值 | 說明 |
|--------|--------|------|
| 容器運行數 | 4/4 | 所有服務都在運行 |
| 健康容器數 | 4/4 | 所有容器健康 |
| Webhook 狀態 | HTTP 200 | LINE 可正常推送訊息 |
| Tunnel 連接點 | 3-4 | Cloudflare 已連接 |
| 監控日誌 | < 100MB | 日誌大小正常 |

### 告警指標

| 指標 | 告警值 | 動作 |
|--------|--------|------|
| 容器運行數 | < 4 | 自動重啟停止的容器 |
| 健康容器數 | < 4 | 檢查不健康的容器 |
| Webhook 狀態 | != 200 | 記錄錯誤並告警 |
| Tunnel 連接點 | 0 | 記錄錯誤並告警 |
| 監控日誌 | > 100MB | 自動清理舊日誌 |

---

## 🔧 常見問題快速解決

### 問題 1：容器無法啟動

```powershell
# 診斷
.\diagnose-fix.ps1

# 重建
docker compose down
docker compose up -d
```

### 問題 2：監控進程無法啟動

```powershell
# 允許腳本執行
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process

# 重新啟動
.\start-with-monitor.bat
```

### 問題 3：任務計劃器不工作

```powershell
# 卸載重新安裝
.\install-scheduled-task.ps1 -Uninstall
# 右鍵 -> 以管理員身份運行 -> .\install-scheduled-task.ps1
```

### 問題 4：Webhook 連接失敗

```powershell
# 檢查服務狀態
.\diagnose-fix.ps1

# 檢查 Cloudflared 日誌
docker logs jyt-gas-cloudflared --tail 50

# 重啟 Tunnel
docker restart jyt-gas-cloudflared
```

---

## 📈 系統維護計劃

### 每日

- [ ] 檢查監控日誌
- [ ] 確認所有服務正常運行

### 每週

- [ ] 清理未使用的 Docker 鏡像
- [ ] 清理未使用的容器
- [ ] 檢查磁盤空間
- [ ] 備份資料庫

### 每月

- [ ] 更新 Docker 鏡像
- [ ] 更新系統依賴
- [ ] 檢查日誌文件大小
- [ ] 清理超過 7 天的舊日誌

### 每季度

- [ ] 完整系統備份
- [ ] 檢查安全配置
- [ ] 審查和優化配置
- [ ] 測試災難恢復流程

---

## ✅ 快速檢查清單

### 部署前檢查

- [ ] Docker Desktop 已安裝並運行
- [ ] `.env.docker` 文件已配置
- [ ] Cloudflare Tunnel Token 已設置
- [ ] LINE Bot Token 已設置
- [ ] PostgreSQL 密碼已配置

### 部署後驗證

- [ ] 所有 4 個容器都在運行
- [ ] 容器健康檢查通過
- [ ] Webhook 返回 HTTP 200
- [ ] Cloudflare Tunnel 已連接（3-4 個點）
- [ ] 監控日誌正常記錄
- [ ] 任務計劃器已安裝（生產環境）

### 持久性測試

- [ ] 重啟系統後服務自動啟動
- [ ] 停止某個容器後自動重啟
- [ ] Docker Desktop 重啟後自動恢復
- [ ] 監控日誌自動清理
- [ ] 系統穩定運行 24 小時無問題

---

## 📚 完整文檔索引

### 主文檔

1. `README.md` - 項目概述
2. `持久性系統-快速開始.md` - 本文件
3. `持久性部署完成總結.md` - 部署詳情
4. `持久性監控系統-使用指南.md` - 完整手冊

### 技術文檔

1. `521錯誤最終解決.md` - LINE Webhook 錯誤解決
2. `CLOUDFLARE_TUNNEL_SETUP.md` - Cloudflare Tunnel 配置
3. `SYSTEM_MANUAL.md` - 系統使用手冊
4. `docker-compose.yml` - Docker 服務配置

### 配置文檔

1. `.env.docker` - 環境變量（請勿上傳 Git）
2. `nginx.cloudflare.conf` - Nginx 配置
3. `cloudflared.yml` - Tunnel 配置

---

## 🎉 總結

您的九九瓦斯行管理系統現在具備：

### ✅ 完整的持久性運行能力

- 🔒 **自動監控** - 每 30 秒檢查所有服務
- 🔄 **自動恢復** - 停止的服務自動重啟
- 🚀 **開機自啟** - Windows 任務計劃器確保開機運行
- 📝 **日誌管理** - 自動清理舊日誌
- 🔍 **快速診斷** - 一鍵診斷和修復問題

### 🎯 使用場景

| 場景 | 推薦方式 | 說明 |
|--------|----------|------|
| 開發調試 | `start-with-monitor.bat` | 手動啟動，可查看日誌 |
| 生產環境 | 安裝任務計劃器 | 開機自動啟動，無需人工干预 |
| 系統故障 | `diagnose-fix.ps1 -AutoFix` | 快速診斷並自動修復 |
| 日常檢查 | `diagnose-fix.ps1` | 檢查系統健康狀態 |

### 🚀 立即開始

```powershell
# 選擇一種方式開始：

# 方式 1：立即啟動（含監控）
.\start-with-monitor.bat

# 方式 2：安裝開機自啟（生產推薦）
.\install-scheduled-task.ps1

# 方式 3：診斷當前狀態
.\diagnose-fix.ps1
```

---

**部署日期：** 2025-12-29  
**版本：** 1.0 (持久性系統版)  
**維護者：** Jy技術團隊

**祝您使用愉快！** 🎉
