# 521 éŒ¯èª¤ - æœ€çµ‚è§£æ±ºæ–¹æ¡ˆ

## ğŸ” å•é¡Œåˆ†æ

### ç•¶å‰ç‹€æ…‹
- âœ… é…ç½®å·²æ›´æ–°åˆ°ç‰ˆæœ¬ 9ï¼š`http://nginx:80`
- âœ… nginx ç›£è½æ­£å¸¸ï¼š`0.0.0.0:80`
- âœ… app ç›£è½æ­£å¸¸ï¼š`0.0.0.0:9999`
- âœ… nginx â†’ app é€£æ¥æ­£å¸¸
- âœ… Docker ç¶²çµ¡é…ç½®æ­£ç¢º
- âš ï¸ **ä½†é‚„æ˜¯ 521 éŒ¯èª¤**

### å¯èƒ½çš„åŸå› 

**521 éŒ¯èª¤è¡¨ç¤º Cloudflare ç„¡æ³•é€£æ¥åˆ°æºæœå‹™å™¨**

é›–ç„¶é…ç½®çœ‹èµ·ä¾†æ­£ç¢ºï¼Œä½† Cloudflare Tunnel å¯èƒ½ç„¡æ³•ï¼š
1. è§£æ `nginx` ä¸»æ©Ÿå
2. é€£æ¥åˆ° `nginx:80`

## ğŸ’¡ è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ IP åœ°å€ï¼ˆæ¨è–¦ï¼‰

åœ¨ Cloudflare Dashboard ä¸­ï¼Œå°‡ Service å¾ï¼š
```
http://nginx:80
```

æ”¹ç‚ºï¼š
```
http://172.18.0.4:80
```

**åŸå› ï¼š**
- `172.18.0.4` æ˜¯ nginx å®¹å™¨çš„å¯¦éš› IP åœ°å€
- ç›´æ¥ä½¿ç”¨ IP å¯ä»¥é¿å… DNS è§£æå•é¡Œ
- é€™æ˜¯ Docker ç¶²çµ¡ä¸­çš„å›ºå®š IP

**æ­¥é©Ÿï¼š**
1. ç™»å…¥ [Cloudflare Zero Trust Dashboard](https://one.dash.cloudflare.com/)
2. é€²å…¥ï¼š**Zero Trust** > **Networks** > **Tunnels**
3. æ‰¾åˆ°ï¼š`linebot-webhook-final`
4. é»æ“Šï¼š**Configure** æˆ– **Public Hostname**
5. ç·¨è¼¯è·¯ç”±ï¼Œå°‡ Service æ”¹ç‚ºï¼š`http://172.18.0.4:80`
6. ä¿å­˜

### æ–¹æ¡ˆ 2ï¼šæª¢æŸ¥ nginx é…ç½®

ç¢ºèª nginx é…ç½®ä¸­çš„ `server_name` åŒ…å«æ­£ç¢ºçš„åŸŸåï¼š
```nginx
server_name linebot.jytian.it.com bossai.jytian.it.com _;
```

### æ–¹æ¡ˆ 3ï¼šé‡å•Ÿæœå‹™

```bash
# é‡å•Ÿ Cloudflare Tunnel
docker compose restart cloudflared

# ç­‰å¾…å¹¾ç§’é˜
sleep 5

# æª¢æŸ¥æ—¥èªŒ
docker compose logs cloudflared --tail 20
```

### æ–¹æ¡ˆ 4ï¼šä½¿ç”¨ localhostï¼ˆä¸æ¨è–¦ï¼‰

å¦‚æœ IP åœ°å€ä¹Ÿä¸è¡Œï¼Œå¯ä»¥å˜—è©¦ï¼š
```
http://127.0.0.1:80
```

ä½†é€™é€šå¸¸ä¸æœƒå·¥ä½œï¼Œå› ç‚º cloudflared å’Œ nginx åœ¨ä¸åŒçš„å®¹å™¨ä¸­ã€‚

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

### 1. ä¿®æ”¹é…ç½®å¾Œ
ç­‰å¾… 10-30 ç§’ï¼Œç„¶å¾Œæª¢æŸ¥æ—¥èªŒï¼š
```bash
docker compose logs cloudflared --tail 20 | Select-String "Updated"
```

æ‡‰è©²çœ‹åˆ°æ–°çš„é…ç½®ç‰ˆæœ¬ï¼ˆversion 10ï¼‰ã€‚

### 2. æ¸¬è©¦å¤–ç¶²è¨ªå•
```bash
curl https://linebot.jytian.it.com/api/webhook/line
```

### 3. å¦‚æœé‚„æ˜¯ 521
æª¢æŸ¥ Cloudflare Tunnel æ—¥èªŒä¸­çš„éŒ¯èª¤ï¼š
```bash
docker compose logs cloudflared --tail 50 | Select-String "error|failed|refused"
```

## ğŸ“‹ ç•¶å‰ç¶²çµ¡é…ç½®

```
Docker Network: jyt-gas-network
â”œâ”€â”€ cloudflared: 172.18.0.5
â”œâ”€â”€ nginx:       172.18.0.4  â† ä½¿ç”¨é€™å€‹ IP
â””â”€â”€ app:        172.18.0.3
```

## ğŸ¯ æ¨è–¦æ“ä½œé †åº

1. **é¦–å…ˆå˜—è©¦æ–¹æ¡ˆ 1**ï¼ˆä½¿ç”¨ IP åœ°å€ï¼‰
   - æœ€ç›´æ¥ï¼Œé¿å… DNS å•é¡Œ
   - ä¿®æ”¹å¾Œç­‰å¾… 30 ç§’æ¸¬è©¦

2. **å¦‚æœé‚„æ˜¯ä¸è¡Œï¼Œå˜—è©¦æ–¹æ¡ˆ 3**ï¼ˆé‡å•Ÿæœå‹™ï¼‰
   - æ¸…é™¤å¯èƒ½çš„é€£æ¥å•é¡Œ

3. **æª¢æŸ¥æ—¥èªŒ**
   - æŸ¥çœ‹æ˜¯å¦æœ‰é€£æ¥éŒ¯èª¤
   - ç¢ºèªé…ç½®å·²æ›´æ–°

## âš ï¸ æ³¨æ„äº‹é …

- IP åœ°å€ `172.18.0.4` æ˜¯ Docker ç¶²çµ¡åˆ†é…çš„
- å¦‚æœå®¹å™¨é‡å•Ÿï¼ŒIP å¯èƒ½æœƒæ”¹è®Š
- ä½†é€šå¸¸åœ¨åŒä¸€å€‹ç¶²çµ¡ä¸­ï¼ŒIP æœƒä¿æŒç©©å®š
- å¦‚æœ IP æ”¹è®Šï¼Œéœ€è¦é‡æ–°é…ç½®

## ğŸ”„ é•·æœŸè§£æ±ºæ–¹æ¡ˆ

å¦‚æœä½¿ç”¨ IP åœ°å€å¯ä»¥å·¥ä½œï¼Œä½†æƒ³è¦æ›´ç©©å®šçš„é…ç½®ï¼Œå¯ä»¥ï¼š

1. **ä½¿ç”¨ Docker ç¶²çµ¡åˆ¥å**
   - åœ¨ docker-compose.yml ä¸­ç‚º nginx æ·»åŠ ç¶²çµ¡åˆ¥å
   - ä½†é€™éœ€è¦é‡æ–°é…ç½®

2. **ä½¿ç”¨æœå‹™ç™¼ç¾**
   - ç¢ºä¿ Docker çš„å…§å»º DNS æ­£å¸¸å·¥ä½œ
   - æª¢æŸ¥ `/etc/resolv.conf` é…ç½®

3. **æª¢æŸ¥ cloudflared ç‰ˆæœ¬**
   - ç•¶å‰ç‰ˆæœ¬ï¼š2025.11.1
   - ç¢ºä¿æ˜¯æœ€æ–°ç‰ˆæœ¬

---

**æœ€å¾Œæ›´æ–°**: 2025-12-28
**æ¨è–¦æ–¹æ¡ˆ**: ä½¿ç”¨ IP åœ°å€ `http://172.18.0.4:80`

