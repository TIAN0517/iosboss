# 521 éŒ¯èª¤ - ç¶²çµ¡é€£æ¥å•é¡Œåˆ†æ

## ğŸ” å•é¡Œåˆ†æ

### ç•¶å‰ç‹€æ…‹
- âœ… Dashboard é…ç½®ï¼š`http://172.18.0.4:80`
- âœ… Cloudflare Tunnel é…ç½®ï¼šç‰ˆæœ¬ 10
- âœ… Docker ç¶²çµ¡é…ç½®æ­£ç¢º
- âœ… nginx å¯ä»¥é€šé 172.18.0.4:80 è¨ªå•ï¼ˆå…§éƒ¨æ¸¬è©¦æˆåŠŸï¼‰
- âŒ **ä½† cloudflared å¯èƒ½ç„¡æ³•è¨ªå•é€™å€‹ IP**

### é—œéµç™¼ç¾

**ç”¨æˆ¶è§€å¯Ÿï¼š** "é›£é“æ˜¯è¢«å®‰è£åœ¨æœ¬åœ°ï¼Ÿ"

é€™æ˜¯ä¸€å€‹å¾ˆå¥½çš„è§€å¯Ÿï¼å•é¡Œå¯èƒ½æ˜¯ï¼š
1. **cloudflared å®¹å™¨ç„¡æ³•è¨ªå• Docker ç¶²çµ¡ä¸­çš„ IP åœ°å€**
2. **æ‡‰è©²ä½¿ç”¨æœå‹™åç¨±è€Œä¸æ˜¯ IP**
3. **Docker ç¶²çµ¡ DNS å¯èƒ½æ²’æœ‰æ­£å¸¸å·¥ä½œ**

## ğŸ’¡ è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šæ”¹å›ä½¿ç”¨æœå‹™åç¨±ï¼ˆæ¨è–¦ï¼‰

åœ¨ Cloudflare Dashboard ä¸­ï¼Œå°‡ Service æ”¹å›ï¼š
```
http://nginx:80
```

**ä½†é€™æ¬¡æˆ‘å€‘éœ€è¦ç¢ºä¿ï¼š**
1. Docker ç¶²çµ¡ DNS æ­£å¸¸å·¥ä½œ
2. cloudflared å’Œ nginx åœ¨åŒä¸€å€‹ç¶²çµ¡ä¸­ï¼ˆå·²ç¢ºèª âœ…ï¼‰
3. æª¢æŸ¥æ˜¯å¦æœ‰ç¶²çµ¡é…ç½®å•é¡Œ

### æ–¹æ¡ˆ 2ï¼šæª¢æŸ¥ Docker ç¶²çµ¡ DNS

```bash
# æª¢æŸ¥ç¶²çµ¡é…ç½®
docker network inspect jyt-gas-network

# æª¢æŸ¥ DNS è¨­ç½®
docker compose exec nginx cat /etc/resolv.conf
```

### æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ç¶²çµ¡åˆ¥å

åœ¨ docker-compose.yml ä¸­ç‚º nginx æ·»åŠ ç¶²çµ¡åˆ¥åï¼š

```yaml
nginx:
  networks:
    jyt-network:
      aliases:
        - nginx
        - web
```

### æ–¹æ¡ˆ 4ï¼šæª¢æŸ¥ cloudflared å¯¦éš›é€£æ¥

æŸ¥çœ‹ cloudflared æ—¥èªŒä¸­çš„å¯¦éš›é€£æ¥éŒ¯èª¤ï¼š
```bash
docker compose logs cloudflared --tail 100 | grep -i "error\|failed\|refused\|timeout"
```

## ğŸ” è¨ºæ–·æ­¥é©Ÿ

### 1. æª¢æŸ¥ç¶²çµ¡é…ç½®
```bash
docker network inspect jyt-gas-network
```

ç¢ºèªï¼š
- æ‰€æœ‰å®¹å™¨éƒ½åœ¨ç¶²çµ¡ä¸­
- DNS é…ç½®æ­£ç¢º
- ç¶²çµ¡é©…å‹•æ˜¯ bridge

### 2. æ¸¬è©¦æœå‹™åç¨±è§£æ
```bash
# å¾ nginx æ¸¬è©¦
docker compose exec nginx getent hosts app

# å¾ app æ¸¬è©¦
docker compose exec app getent hosts nginx
```

### 3. æª¢æŸ¥ cloudflared æ—¥èªŒ
```bash
docker compose logs cloudflared --tail 50
```

æŸ¥çœ‹æ˜¯å¦æœ‰ï¼š
- é€£æ¥è¢«æ‹’çµ•ï¼ˆconnection refusedï¼‰
- è¶…æ™‚ï¼ˆtimeoutï¼‰
- DNS è§£æå¤±æ•—

## ğŸ“‹ ç•¶å‰ç¶²çµ¡é…ç½®

```
Network: jyt-gas-network (bridge)
â”œâ”€â”€ cloudflared: 172.18.0.5
â”œâ”€â”€ nginx:       172.18.0.4
â””â”€â”€ app:         172.18.0.3
```

## ğŸ¯ æ¨è–¦æ“ä½œ

### æ­¥é©Ÿ 1ï¼šæ”¹å›æœå‹™åç¨±
åœ¨ Dashboard ä¸­å°‡ Service æ”¹ç‚ºï¼š`http://nginx:80`

### æ­¥é©Ÿ 2ï¼šæª¢æŸ¥ Docker ç¶²çµ¡ DNS
```bash
docker network inspect jyt-gas-network --format '{{.Options}}'
```

### æ­¥é©Ÿ 3ï¼šé‡å•Ÿæœå‹™
```bash
docker compose restart cloudflared
```

### æ­¥é©Ÿ 4ï¼šæª¢æŸ¥æ—¥èªŒ
```bash
docker compose logs cloudflared --tail 30
```

æŸ¥çœ‹æ˜¯å¦æœ‰é€£æ¥éŒ¯èª¤ã€‚

### æ­¥é©Ÿ 5ï¼šæ¸¬è©¦
```bash
curl https://linebot.jytian.it.com/api/webhook/line
```

## âš ï¸ å¯èƒ½çš„åŸå› 

1. **cloudflared å®¹å™¨ç¶²çµ¡éš”é›¢**
   - cloudflared å¯èƒ½ç„¡æ³•è¨ªå• Docker ç¶²çµ¡ä¸­çš„å…¶ä»–å®¹å™¨
   - éœ€è¦ä½¿ç”¨æœå‹™åç¨±ï¼Œä¾è³´ Docker DNS

2. **Docker DNS é…ç½®å•é¡Œ**
   - Docker çš„å…§å»º DNS å¯èƒ½æ²’æœ‰æ­£å¸¸å·¥ä½œ
   - éœ€è¦æª¢æŸ¥ç¶²çµ¡é…ç½®

3. **cloudflared ç‰ˆæœ¬å•é¡Œ**
   - ç•¶å‰ç‰ˆæœ¬ï¼š2025.11.1
   - å¯èƒ½éœ€è¦æ›´æ–°æˆ–ä½¿ç”¨ç‰¹å®šé…ç½®

## ğŸ”§ å¦‚æœé‚„æ˜¯ä¸è¡Œ

### æª¢æŸ¥ cloudflared é…ç½®
æŸ¥çœ‹ cloudflared çš„å¯¦éš›é…ç½®ï¼š
```bash
docker compose exec cloudflared cat /etc/cloudflared/config.yml
```

### ä½¿ç”¨ host ç¶²çµ¡æ¨¡å¼ï¼ˆä¸æ¨è–¦ï¼‰
ä¿®æ”¹ docker-compose.ymlï¼š
```yaml
cloudflared:
  network_mode: host
```

ä½†é€™æœƒå¤±å» Docker ç¶²çµ¡éš”é›¢çš„å„ªå‹¢ã€‚

### ä½¿ç”¨å¤–éƒ¨ç¶²çµ¡
å‰µå»ºå¤–éƒ¨ç¶²çµ¡ä¸¦æ‰‹å‹•é…ç½®ï¼š
```bash
docker network create --driver bridge jyt-external
```

---

**æœ€å¾Œæ›´æ–°**: 2025-12-28
**å•é¡Œ**: cloudflared å¯èƒ½ç„¡æ³•è¨ªå• Docker ç¶²çµ¡ä¸­çš„ IP
**æ¨è–¦**: æ”¹å›ä½¿ç”¨æœå‹™åç¨± `http://nginx:80`

