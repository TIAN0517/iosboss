# 🔍 突然不正常問題排查指南

## 📋 可能的原因

### 1. 服務重啟導致配置丟失
- Docker 容器重啟後，環境變量可能沒有正確加載
- `.env` 文件可能被重置或修改

### 2. Cloudflare Token 過期或失效
- Token 可能已過期
- Token 可能被重新生成（在 Dashboard 中點擊了"重新整理權杖"）

### 3. Cloudflare 設置被更改
- SSL/TLS 模式可能被更改
- DNS 設置可能被更改
- Tunnel 配置可能被更改

### 4. Docker 容器問題
- 容器可能意外停止
- 網絡連接可能中斷
- 配置可能沒有正確掛載

## 🔧 快速修復步驟

### 步驟 1：檢查服務狀態

```powershell
docker compose ps
```

所有服務應該顯示 `Up` 狀態。

### 步驟 2：檢查 Token 是否有效

```powershell
Get-Content .env | Select-String "CF_TUNNEL_TOKEN"
```

確認 Token 存在且格式正確。

### 步驟 3：檢查 Cloudflare Dashboard

1. 訪問：https://one.dash.cloudflare.com/access/tunnels
2. 檢查 Tunnel 狀態
3. 檢查是否有 Token 被重新生成的記錄

### 步驟 4：重啟所有服務

```powershell
docker compose down
docker compose up -d
```

### 步驟 5：檢查 Cloudflare SSL/TLS 設置

1. 訪問：https://dash.cloudflare.com/
2. 選擇域名：`jytian.it.com`
3. 進入 **SSL/TLS** → **Overview**
4. 確認模式是 **Full** 或 **Full (strict)**

## 🐛 常見問題

### Q: 昨天正常，今天突然 521
**A:** 可能的原因：
1. Cloudflare Token 被重新生成（需要更新 `.env` 文件）
2. Cloudflare 設置被更改（SSL/TLS 模式、DNS 等）
3. Docker 容器重啟後配置沒有正確加載

### Q: 如何檢查 Token 是否有效？
**A:** 
1. 檢查 Tunnel 日誌：`docker compose logs cloudflared`
2. 如果看到 "invalid token" 或類似錯誤，需要重新獲取 Token

### Q: 如何恢復到昨天的配置？
**A:**
1. 檢查 `.env` 文件是否有備份
2. 檢查 `docker-compose.yml` 是否有變更
3. 檢查 Cloudflare Dashboard 中的配置

## 📝 檢查清單

- [ ] 所有 Docker 服務運行正常
- [ ] Token 存在且格式正確
- [ ] Cloudflare Tunnel 狀態是 Active
- [ ] Cloudflare SSL/TLS 模式是 Full
- [ ] DNS 設置正確
- [ ] 沒有在 Dashboard 中重新生成 Token

## 🔄 恢復步驟

### 如果 Token 被重新生成：

1. **獲取新 Token**：
   - 訪問：https://one.dash.cloudflare.com/access/tunnels
   - 點擊 `jyt-gas-tunnel`
   - 點擊 **Token** 按鈕，複製新 Token

2. **更新 .env 文件**：
   ```powershell
   .\set-tunnel-token.ps1 -Token "new_token_here"
   ```

3. **重啟服務**：
   ```powershell
   docker compose restart cloudflared
   ```

### 如果配置被更改：

1. **檢查 Cloudflare Dashboard** 中的所有設置
2. **恢復到正確的配置**
3. **重啟服務**

---

**下一步**：檢查服務狀態和 Token 是否有效。

