# 九九瓦斯行管理系統 - 持久性部署完成總結

## ✅ 部署完成

所有持久性監控和自動恢復機制已經設置完成！

---

## 📦 已安裝的組件

### 1. 核心監控腳本

| 文件 | 功能 | 狀態 |
|------|------|------|
| `monitor-services.ps1` | 持久性服務監控守護進程 | ✅ 已創建 |
| `start-with-monitor.bat` | 一鍵啟動（含監控） | ✅ 已創建 |
| `diagnose-fix.ps1` | 診斷和自動修復 | ✅ 已創建並測試 |
| `install-scheduled-task.ps1` | Windows 任務計劃器安裝 | ✅ 已創建 |

### 2. Docker 配置優化

| 文件 | 變更 | 狀態 |
|------|------|------|
| `docker-compose.yml` | Cloudflared 重啟策略改為 `always` | ✅ 已優化 |

### 3. 文檔

| 文件 | 內容 | 狀態 |
|------|------|------|
| `持久性監控系統-使用指南.md` | 完整使用文檔 | ✅ 已創建 |

---

## 🎯 系統架構

```
┌─────────────────────────────────────────────────────────┐
│         Windows 系統（開機自動啟動）            │
│                                                      │
│  ┌──────────────────────────────────────────────┐   │
│  │   任務計劃器（開機/登錄觸發）    │   │
│  │   • 延遲 2 分鐘                      │   │
│  │   • 失敗重試 3 次                      │   │
│  └──────────────────────────────────────────────┘   │
│                      ↓                               │
│  ┌──────────────────────────────────────────────┐   │
│  │   start-with-monitor.bat                  │   │
│  │   1. 檢查 Docker                      │   │
│  │   2. 啟動所有服務                    │   │
│  │   3. 啟動監控守護進程              │   │
│  └──────────────────────────────────────────────┘   │
│                      ↓                               │
│  ┌──────────────────────────────────────────────┐   │
│  │   monitor-services.ps1 (持續運行）    │   │
│  │   • 每 30 秒檢查一次               │   │
│  │   • 自動重啟停止的容器              │   │
│  │   • 自動清理舊日誌（7 天）        │   │
│  │   • 持久化運行                        │   │
│  └──────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

## 🔧 服務重啟機制

### Docker 層級

| 容器 | 重啟策略 | 說明 |
|--------|----------|------|
| jyt-gas-app | `unless-stopped` | 除非手動停止，否則重啟 |
| jyt-gas-nginx | `unless-stopped` | 除非手動停止，否則重啟 |
| jyt-gas-postgres | `unless-stopped` | 除非手動停止，否則重啟 |
| jyt-gas-cloudflared | `always` | **任何情況下都會重啟** |

### 監控守護進程層級

| 檢查項 | 頻率 | 動作 |
|----------|------|------|
| Docker 是否運行 | 每 30 秒 | 未運行則啟動 Docker Desktop |
| 所有容器狀態 | 每 30 秒 | 停止則自動重啟 |
| 容器健康狀態 | 每 30 秒 | 不健康則等待或重啟 |
| 日誌清理 | 每天 3:00 | 自動刪除 7 天前的日誌 |

---

## 🚀 如何使用

### 方式 1：手動啟動（開發/測試）

```powershell
# 雙擊運行
.\start-with-monitor.bat
```

**過程：**
1. ✅ 檢查並確保 Docker 運行
2. ✅ 啟動所有 Docker 服務
3. ✅ 等待 30 秒讓服務就緒
4. ✅ 啟動監控守護進程（持續運行）

**注意：**
- 監控進程會在當前窗口持續運行
- 按 `Ctrl + C` 可停止監控（不影響服務）
- 關閉窗口會停止監控和服務

### 方式 2：自動啟動（生產環境）

#### 步驟 1：安裝 Windows 任務計劃器

```powershell
# 右鍵單擊，選擇「以管理員身份運行」
.\install-scheduled-task.ps1
```

**成功提示：**
```
✅ 任務計劃安裝成功！

任務詳情:
  名稱: JYT-Gas-Services-Monitor
  描述: 九九瓦斯行管理系統 - 服務監控守護進程
  腳本: C:\Users\tian7\OneDrive\Desktop\媽媽ios\start-with-monitor.bat

觸發條件:
  • 開機時（延遲 2 分鐘）
  • 用戶登錄時（延遲 30 秒）

重試策略:
  • 失敗後每 5 分鐘重試，最多 3 次
```

#### 步驟 2：驗證安裝

```powershell
# 方法 1：查看任務
taskschd.msc

# 方法 2：命令行查詢
schtasks /query /tn "JYT-Gas-Services-Monitor" /fo LIST

# 方法 3：手動觸發（測試）
schtasks /run /tn "JYT-Gas-Services-Monitor"
```

#### 步驟 3：測試開機自動啟動

1. **重啟電腦**（或登出再登入）
2. **等待 2-3 分鐘**
3. **檢查服務是否自動啟動**：
   ```powershell
   docker ps
   ```
4. **查看監控日誌**：
   ```powershell
   Get-Content logs\monitor.log -Tail 50
   ```

---

## 📊 監控詳解

### 監控的服務

```
服務列表（共 4 個）：
├── jyt-gas-app          (Next.js 應用，端口 9999)
├── jyt-gas-nginx        (Nginx 反向代理，端口 80)
├── jyt-gas-postgres     (PostgreSQL 資料庫，端口 5433)
└── jyt-gas-cloudflared   (Cloudflare Tunnel)
```

### 監控功能

| 功能 | 描述 | 自動處理 |
|------|------|----------|
| Docker 停止檢測 | 檢測 Docker Desktop 是否運行 | ✅ 自動啟動 |
| 容器停止檢測 | 每 30 秒檢查所有容器 | ✅ 自動重啟 |
| 健康狀態檢查 | 檢查容器健康指標 | ✅ 等待或重啟 |
| 日誌自動清理 | 每天凌晨 3 點執行 | ✅ 刪除 7 天前的日誌 |
| 連接狀態監控 | 檢查 webhook 和 tunnel 連接 | ✅ 記錄異常 |

### 日誌系統

```
logs/
├── monitor.log           # 監控守護進程日誌
│   ├── 格式: [yyyy-MM-dd HH:mm:ss] [LEVEL] Message
│   ├── 等級: INFO, SUCCESS, WARNING, ERROR
│   └── 自動清理: 保留 7 天
│
├── docker-compose.log    # Docker Compose 日誌
└── [其他服務日誌]
```

---

## 🔍 診斷和修復

### 快速診斷

```powershell
# 基本診斷
.\diagnose-fix.ps1

# 診斷並自動修復
.\diagnose-fix.ps1 -AutoFix

# 僅檢查，不修復
.\diagnose-fix.ps1 -OnlyCheck
```

**診斷輸出：**
```
========================================
Service Diagnosis
========================================

Check time: 2025-12-29 01:10:25

[1/6] Docker Status
  Docker version: 29.1.3
  Docker status: Running

[2/6] Container Status
  jyt-gas-app : Running - Healthy
  jyt-gas-nginx : Running - Healthy
  jyt-gas-postgres : Running - Healthy
  jyt-gas-cloudflared : Running - Healthy
  Running: 4/4
  Stopped: 0/4

[3/6] Webhook Connection Test
  LINE Webhook: 200 OK

[4/6] Cloudflare Tunnel Status
  Tunnel connection: OK (4 points)

[5/6] Port Listening Check
  Port 9999: Listening
  Port 5433: Listening

========================================
Diagnosis Complete
========================================

✓ All systems operational!

========================================
```

### 常見問題修復

| 問題 | 診斷 | 修復方法 |
|------|------|----------|
| 所有容器停止 | `docker ps` 顯示無容器 | 運行 `diagnose-fix.ps1 -AutoFix` |
| 個別容器停止 | 日誌顯示某容器停止 | 監控會自動重啟 |
| Webhook 無法連接 | `curl https://linebot.jytian.it.com` 失敗 | 檢查 Nginx 和 Tunnel 配置 |
| 監控進程退出 | PowerShell 窗口關閉 | 運行 `start-with-monitor.bat` 重新啟動 |

---

## 📋 日常管理命令

### Docker 服務管理

```powershell
# 查看所有容器狀態
docker compose ps

# 查看實時日誌
docker compose logs -f

# 查看特定服務日誌
docker logs jyt-gas-app --tail 100

# 重啟所有服務
docker compose restart

# 重啟特定服務
docker restart jyt-gas-app

# 停止所有服務
docker compose down

# 重建並啟動
docker compose up -d --build

# 完全清理（包括數據卷）
docker compose down -v
```

### 監控管理

```powershell
# 啟動監控守護進程（後台）
powershell -NoProfile -ExecutionPolicy Bypass -File monitor-services.ps1

# 啟動監控（前台，可查看日誌）
start-with-monitor.bat

# 單次檢查
powershell -NoProfile -ExecutionPolicy Bypass -File monitor-services.ps1 -OneTime

# 查看監控日誌
Get-Content logs\monitor.log -Tail 50

# 實時監控日誌
Get-Content logs\monitor.log -Wait -Tail 10
```

### 任務計劃器管理

```powershell
# 安裝任務
.\install-scheduled-task.ps1

# 卸載任務
.\install-scheduled-task.ps1 -Uninstall

# 手動運行任務
schtasks /run /tn "JYT-Gas-Services-Monitor"

# 查看任務日誌
schtasks /query /tn "JYT-Gas-Services-Monitor" /fo LIST /v
```

---

## 🔒 安全和維護建議

### 1. 定期備份

```powershell
# 備份 PostgreSQL
$backupDate = Get-Date -Format 'yyyyMMdd'
docker exec jyt-gas-postgres pg_dump -U postgres gas_management > "backup_$backupDate.sql"

# 備份數據卷
docker run --rm -v jyt-gas-postgres-data:/data -v (Get-Location):/backup alpine tar czf "postgres_data_$backupDate.tar.gz" -C /data .
```

### 2. 監控磁盤空間

```powershell
# 檢查 Docker 磁盤使用
docker system df

# 清理未使用的鏡像
docker image prune -a

# 清理未使用的容器
docker container prune

# 清理未使用的卷
docker volume prune
```

### 3. 監控日誌大小

```powershell
# 檢查日誌文件大小
Get-ChildItem logs\*.log | 
    Select-Object Name, Length, LastWriteTime | 
    Format-Table -AutoSize

# 清理大於 100MB 的日誌
Get-ChildItem logs\*.log | 
    Where-Object { $_.Length -gt 100MB } | 
    Remove-Item -Force
```

### 4. 定期更新

```powershell
# 更新 Docker 鏡像
docker compose pull

# 重建並重啟
docker compose up -d --build

# 更新依賴
npm install
```

---

## 📞 持久性保證

### 自動恢復機制

| 失敗場景 | 自動處理 | 恢復時間 |
|-----------|----------|----------|
| Docker Desktop 未啟動 | 自動啟動 | 約 20 秒 |
| 容器意外崩潰 | 自動重啟 | 約 30 秒（檢查間隔） |
| 網絡連接丟失 | 記錄並報告 | - |
| 服務不健康 | 等待恢復或重啟 | 依情況 |
| 系統重啟 | 自動啟動所有服務 | 約 2-3 分鐘 |

### 持久性驗證測試

**測試步驟：**

1. ✅ **重啟系統**
   ```powershell
   Restart-Computer -Force
   ```

2. ✅ **等待 3 分鐘**

3. ✅ **驗證服務自動啟動**
   ```powershell
   docker ps
   # 預期：所有 4 個容器都在運行
   ```

4. ✅ **驗證 Webhook 可用**
   ```powershell
   curl https://linebot.jytian.it.com/api/webhook/line
   # 預期：HTTP 200 OK
   ```

5. ✅ **檢查監控日誌**
   ```powershell
   Get-Content logs\monitor.log -Tail 20
   # 預期：顯示正常啟動過程
   ```

---

## 🎯 快速參考

### 服務狀態快速檢查

```powershell
# 一鍵診斷
.\diagnose-fix.ps1
```

### 問題快速修復

```powershell
# 自動診斷並修復
.\diagnose-fix.ps1 -AutoFix
```

### 完全重置系統

```powershell
# 停止所有服務
docker compose down

# 清理並重建
docker compose up -d --build
```

---

## 📈 監控指標

### 關鍵指標

| 指標 | 正常值 | 告警值 |
|------|--------|--------|
| 容器運行數量 | 4/4 | < 4 |
| 健康容器數量 | 4/4 | < 4 |
| Webhook HTTP 狀態 | 200 | != 200 |
| Tunnel 連接點 | 3-4 | 0 |
| 日誌文件大小 | < 100MB | > 100MB |

### 監控日誌示例

```
[2025-12-29 01:10:25] [INFO] ========================================
[2025-12-29 01:10:25] [INFO] 服務監控守護進程啟動
[2025-12-29 01:10:25] [INFO] 檢查間隔: 30 秒
[2025-12-29 01:10:25] [INFO] ========================================
[2025-12-29 01:10:25] [INFO]
[2025-12-29 01:10:25] [INFO] 開始檢查服務狀態...
[2025-12-29 01:10:25] [SUCCESS] ✅ jyt-gas-app - 運行中
[2025-12-29 01:10:25] [SUCCESS] ✅ jyt-gas-nginx - 運行中
[2025-12-29 01:10:25] [SUCCESS] ✅ jyt-gas-postgres - 運行中
[2025-12-29 01:10:25] [SUCCESS] ✅ jyt-gas-cloudflared - 運行中
[2025-12-29 01:10:25] [INFO] 檢查完成！
[2025-12-29 01:10:25] [INFO] ----------------------------------------
[2025-12-29 01:10:55] [INFO] 等待 30 秒後進行下一次檢查...
```

---

## ✅ 完成檢查清單

### 部署檢查

- [x] Docker 重啟策略已優化（Cloudflared 改為 always）
- [x] 監控守護進程腳本已創建
- [x] 一鍵啟動腳本已創建
- [x] 診斷修復腳本已創建並測試
- [x] Windows 任務計劃器腳本已創建
- [x] 日誌自動清理機制已設置（7 天）
- [x] 完整使用文檔已創建

### 功能測試

- [x] Docker 容器正常運行（4/4）
- [x] 所有容器健康狀態良好
- [x] LINE Webhook 連接正常（HTTP 200）
- [x] Cloudflare Tunnel 正常連接（4 個連接點）
- [x] 端口正確監聽（9999, 5433）
- [x] 診斷腳本運行成功

---

## 📞 技術支持

### 收集診斷信息

```powershell
# 完整系統診斷
.\diagnose-fix.ps1 > diagnostic_report.txt

# Docker 日誌
docker compose logs > docker_logs.txt

# 容器狀態
docker ps -a > container_status.txt

# 系統信息
systeminfo > system_info.txt

# 打包所有日誌
Compress-Archive -Path logs -DestinationPath logs_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss').zip
```

### 常見問題排查

#### 問題 1：監控守護進程無法啟動

**症狀：**
- PowerShell 運行腳本立即退出
- 錯誤：無法執行腳本

**解決方案：**
```powershell
# 允許腳本執行
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# 或臨時允許
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process
```

#### 問題 2：Windows 任務計劃器失敗

**症狀：**
- 開機後沒有自動啟動
- 任務顯示「失敗」

**解決方案：**
```powershell
# 卸載任務
.\install-scheduled-task.ps1 -Uninstall

# 重新安裝（需要管理員權限）
# 右鍵 -> 以管理員身份運行
.\install-scheduled-task.ps1
```

#### 問題 3：容器循環重啟

**症狀：**
- 容器每隔幾分鐘自動重啟
- 日誌顯示重啟循環

**可能原因：**
1. 容器健康檢查失敗
2. 資源不足（記憶體/CPU）
3. 配置錯誤

**解決方案：**
```powershell
# 查看詳細日誌
docker logs jyt-gas-app --tail 100

# 檢查資源使用
docker stats

# 重新構建容器
docker compose up -d --build
```

---

## 📚 相關文檔

| 文檔 | 說明 |
|------|------|
| `持久性監控系統-使用指南.md` | 詳細使用指南 |
| `docker-compose.yml` | Docker 服務配置 |
| `521錯誤最終解決.md` | LINE Webhook 解決方案 |
| `CLOUDFLARE_TUNNEL_SETUP.md` | Cloudflare Tunnel 配置 |
| `README_99GAS.md` | 系統使用手冊 |

---

## 🎉 總結

您的九九瓦斯行管理系統現在具備完整的**持久性運行能力**：

### ✅ 已實現

1. **自動監控** - 每 30 秒檢查一次所有服務
2. **自動恢復** - 停止的服務會自動重啟
3. **開機自啟** - Windows 任務計劃器確保開機自動運行
4. **日誌管理** - 自動清理舊日誌（保留 7 天）
5. **快速診斷** - 一鍵診斷和修復問題

### 🎯 持久性保證

| 場景 | 保證 |
|------|------|
| 系統重啟 | ✅ 2-3 分鐘內自動恢復 |
| 容器崩潰 | ✅ 30 秒內自動重啟 |
| Docker 停止 | ✅ 自動啟動並恢復服務 |
| 服務異常 | ✅ 自動檢測並記錄 |

### 🚀 下一步建議

1. **安裝 Windows 任務計劃器**
   ```powershell
   .\install-scheduled-task.ps1
   ```

2. **測試開機自動啟動**
   - 重啟電腦
   - 等待 3 分鐘
   - 驗證所有服務自動啟動

3. **定期監控**
   - 每週檢查 `logs\monitor.log`
   - 每月清理舊日誌
   - 每月備份資料庫

---

**部署日期：** 2025-12-29
**部署者：** Jy技術團隊
**系統版本：** 1.0 (持久性監控版）

---

## 📞 如需協助

如有任何問題，請參考：
- `持久性監控系統-使用指南.md` - 詳細使用說明
- `diagnose-fix.ps1` - 快速診斷工具
- `logs\monitor.log` - 監控日誌

**祝您使用愉快！** 🎉
