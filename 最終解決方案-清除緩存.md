# 最終解決方案 - 清除 Cloudflare 緩存

## ✅ 當前狀態

### 配置確認
- ✅ Dashboard 配置：`http://172.18.0.4:80`
- ✅ Cloudflare Tunnel 配置：版本 10（已更新）
- ✅ Tunnel 已重啟並重新連接
- ✅ 所有服務運行正常
- ⚠️ **但還是 521 錯誤**

## 💡 解決方案：清除 Cloudflare 緩存

### 為什麼需要清除緩存？

雖然配置已經正確更新，但 Cloudflare 可能還在使用舊的緩存配置。清除緩存可以強制 Cloudflare 使用最新的配置。

### 操作步驟

#### 1. 登入 Cloudflare Dashboard
- 網址：https://dash.cloudflare.com/
- 使用您的 Cloudflare 帳號登入

#### 2. 選擇域名
- 選擇域名：`jytian.it.com`

#### 3. 進入緩存設置
- 點擊左側選單：**Caching**
- 點擊：**Configuration**

#### 4. 清除所有緩存
- 找到 **Purge Cache** 區塊
- 點擊：**Purge Everything**（清除所有緩存）
- 確認操作

#### 5. 等待
- 等待 2-3 分鐘讓緩存清除完成

#### 6. 測試
```bash
curl https://linebot.jytian.it.com/api/webhook/line
```

應該返回 JSON 響應，而不是 521 錯誤。

#### 7. 在 LINE 平台測試
1. 登入 [LINE Developers Console](https://developers.line.biz/console/)
2. 進入您的 Bot 設定
3. 找到 **Webhook 設定**
4. 點擊 **Webhook 重發**（Verify）按鈕
5. 應該顯示成功，而不是 521 錯誤

## 📋 配置總結

### 當前配置
```
Hostname: linebot.jytian.it.com
Service:  http://172.18.0.4:80
Path:     *
配置版本: 10
```

### 服務狀態
```
✅ nginx: 運行中 (healthy)
✅ app: 運行中 (healthy)
✅ cloudflared: 運行中
```

### 網絡配置
```
cloudflared: 172.18.0.5
nginx:       172.18.0.4  ← 使用這個 IP
app:         172.18.0.3
```

## 🔍 如果清除緩存後還是不行

### 檢查 Cloudflare Tunnel 日誌
```bash
docker compose logs cloudflared --tail 50
```

查看是否有連接錯誤或超時。

### 檢查 nginx 日誌
```bash
docker compose logs nginx --tail 50
```

查看是否有請求到達。

### 測試內部連接
```bash
# 測試 nginx 內部訪問
docker compose exec nginx wget -qO- http://127.0.0.1:80/api/webhook/line
```

應該返回 JSON 響應。

### 重啟所有服務
```bash
docker compose restart cloudflared nginx app
```

等待服務啟動後再次測試。

## 🎯 預期結果

清除緩存後：
- ✅ 外網訪問應該正常
- ✅ LINE Webhook 應該可以正常工作
- ✅ 不再出現 521 錯誤

## ⚠️ 注意事項

- 清除緩存會暫時影響所有使用該域名的服務
- 但這只是暫時的，通常幾秒鐘內就會恢復
- 這是解決 521 錯誤的最後一步

---

**最後更新**: 2025-12-28
**配置版本**: 10
**推薦操作**: 清除 Cloudflare 緩存

