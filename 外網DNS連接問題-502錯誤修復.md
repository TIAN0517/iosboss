# å¤–ç¶² DNS é€£æ¥å•é¡Œ - 502 éŒ¯èª¤ä¿®å¾©

## ğŸ” å•é¡Œè¨ºæ–·

### ç•¶å‰ç‹€æ…‹

1. **Cloudflare Tunnel å®¹å™¨** âœ…
   - ç‹€æ…‹ï¼š`Up`ï¼ˆé‹è¡Œæ­£å¸¸ï¼‰
   - å·²é€£æ¥ï¼š`Registered tunnel connection`
   - é…ç½®å·²æ›´æ–°ï¼š`Updated to new configuration`

2. **DNS è§£æ** âœ…
   - `bossai.jytian.it.com` DNS è§£ææˆåŠŸ

3. **HTTP é€£æ¥** âŒ
   - è¿”å› 502 Bad Gatewayï¼ˆå¾ 530 æ”¹ç‚º 502ï¼Œæœ‰é€²æ­¥ï¼‰
   - èªªæ˜ Cloudflare å¯ä»¥é€£æ¥åˆ° Tunnelï¼Œä½† Tunnel ç„¡æ³•é€£æ¥åˆ°æºæœå‹™å™¨

4. **æœ¬åœ°æœå‹™** âœ…
   - `http://localhost:9999` é‹è¡Œæ­£å¸¸ï¼ˆç‹€æ…‹ç¢¼ 200ï¼‰

---

## ğŸš¨ æ ¹æœ¬åŸå› 

### é—œéµéŒ¯èª¤

**æ—¥èªŒéŒ¯èª¤**ï¼š
```
ERR Unable to reach the origin service. The service may be down or it may not be responding to traffic from cloudflared: 
dial tcp: lookup nginx on 127.0.0.11:53: server misbehaving
```

**å•é¡Œåˆ†æ**ï¼š
- Tunnel å®¹å™¨ç„¡æ³•è§£æ `nginx` ä¸»æ©Ÿå
- Docker DNS æœå‹™å™¨ï¼ˆ127.0.0.11:53ï¼‰ç„¡æ³•è§£ææœå‹™åç¨±
- é€™å°è‡´ Tunnel ç„¡æ³•é€£æ¥åˆ° Nginx æœå‹™å™¨

**å¯èƒ½åŸå› **ï¼š
1. å®¹å™¨ä¸åœ¨åŒä¸€å€‹ Docker ç¶²çµ¡ä¸­
2. Docker DNS æœå‹™å™¨é…ç½®å•é¡Œ
3. æœå‹™åç¨±è§£æå¤±æ•—

---

## ğŸ”§ è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: æª¢æŸ¥ä¸¦ä¿®å¾©ç¶²çµ¡é…ç½®ï¼ˆæ¨è–¦ï¼‰

#### æ­¥é©Ÿ 1: ç¢ºèªæ‰€æœ‰å®¹å™¨åœ¨åŒä¸€å€‹ç¶²çµ¡ä¸­

```powershell
# æª¢æŸ¥ç¶²çµ¡ä¸­çš„å®¹å™¨
docker network inspect jyt-network --format "{{range .Containers}}{{.Name}} {{end}}"
```

æ‡‰è©²çœ‹åˆ°ï¼š
- `jyt-gas-app`
- `jyt-gas-nginx`
- `jyt-gas-cloudflared`
- `jyt-gas-postgres`

#### æ­¥é©Ÿ 2: æª¢æŸ¥ Cloudflare Dashboard é…ç½®

1. **ç™»å…¥ Cloudflare Dashboard**
   - è¨ªå•ï¼šhttps://one.dash.cloudflare.com/
   - é€²å…¥ Zero Trust â†’ Access â†’ Tunnels

2. **æª¢æŸ¥ Service URL**
   - æ‰¾åˆ° `bossai.jytian.it.com` çš„é…ç½®
   - æª¢æŸ¥ **Service URL** æ˜¯å¦ç‚º `http://nginx:80`
   - å¦‚æœç„¡æ³•è§£æï¼Œå˜—è©¦æ”¹ç‚ºï¼š
     - `http://jyt-gas-nginx:80`ï¼ˆä½¿ç”¨å®¹å™¨åç¨±ï¼‰
     - æˆ–ä½¿ç”¨ IP åœ°å€ï¼ˆä¸æ¨è–¦ï¼Œå› ç‚º IP å¯èƒ½è®ŠåŒ–ï¼‰

#### æ­¥é©Ÿ 3: é©—è­‰ç¶²çµ¡é€£æ¥

```powershell
# æª¢æŸ¥å®¹å™¨ IP
docker inspect jyt-gas-nginx --format "{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}"
docker inspect jyt-gas-cloudflared --format "{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}"

# æ‡‰è©²åœ¨åŒä¸€å€‹ç¶²çµ¡ä¸­ï¼ŒIP åœ°å€æ‡‰è©²åœ¨åŒä¸€ç¶²æ®µ
```

### æ–¹æ¡ˆ 2: ä½¿ç”¨å®¹å™¨åç¨±è€Œä¸æ˜¯æœå‹™åç¨±

å¦‚æœ Docker DNS ç„¡æ³•è§£ææœå‹™åç¨±ï¼Œå¯ä»¥ï¼š

1. **åœ¨ Cloudflare Dashboard ä¸­ä¿®æ”¹ Service URL**
   - å¾ `http://nginx:80` æ”¹ç‚º `http://jyt-gas-nginx:80`
   - ä¿å­˜é…ç½®

2. **ç­‰å¾…é…ç½®æ›´æ–°**ï¼ˆç´„ 30 ç§’ï¼‰

3. **æª¢æŸ¥æ—¥èªŒ**
   ```powershell
   docker logs jyt-gas-cloudflared --tail 20
   ```
   æ‡‰è©²çœ‹åˆ°é…ç½®æ›´æ–°æ¶ˆæ¯

### æ–¹æ¡ˆ 3: æª¢æŸ¥ Docker Compose ç¶²çµ¡é…ç½®

ç¢ºä¿ `docker-compose.yml` ä¸­æ‰€æœ‰æœå‹™éƒ½ä½¿ç”¨ç›¸åŒçš„ç¶²çµ¡ï¼š

```yaml
services:
  nginx:
    networks:
      - jyt-network
  
  cloudflared:
    networks:
      - jyt-network
    depends_on:
      - nginx  # ç¢ºä¿ nginx å…ˆå•Ÿå‹•

networks:
  jyt-network:
    driver: bridge
```

---

## ğŸ“‹ é©—è­‰æ­¥é©Ÿ

### æ­¥é©Ÿ 1: æª¢æŸ¥ç¶²çµ¡é…ç½®

```powershell
# æª¢æŸ¥æ‰€æœ‰å®¹å™¨æ˜¯å¦åœ¨åŒä¸€å€‹ç¶²çµ¡ä¸­
docker network inspect jyt-network --format "{{range .Containers}}{{.Name}} {{end}}"
```

### æ­¥é©Ÿ 2: æª¢æŸ¥ Cloudflare Dashboard é…ç½®

1. è¨ªå•ï¼šhttps://one.dash.cloudflare.com/
2. é€²å…¥ Zero Trust â†’ Access â†’ Tunnels
3. æ‰¾åˆ°æ‚¨çš„ Tunnel
4. é»æ“Š Configure â†’ Public Hostname
5. æª¢æŸ¥ `bossai.jytian.it.com` çš„ Service URL

### æ­¥é©Ÿ 3: ä¿®æ”¹ Service URLï¼ˆå¦‚æœéœ€è¦ï¼‰

å¦‚æœ Service URL æ˜¯ `http://nginx:80`ï¼Œå˜—è©¦æ”¹ç‚ºï¼š
- `http://jyt-gas-nginx:80`ï¼ˆä½¿ç”¨å®¹å™¨åç¨±ï¼‰

### æ­¥é©Ÿ 4: ç­‰å¾…é…ç½®æ›´æ–°

```powershell
# ç­‰å¾… 30 ç§’è®“é…ç½®ç”Ÿæ•ˆ
Start-Sleep -Seconds 30

# æª¢æŸ¥æ—¥èªŒ
docker logs jyt-gas-cloudflared --tail 20
```

æ‡‰è©²çœ‹åˆ°ï¼š
```
INF Updated to new configuration
```

### æ­¥é©Ÿ 5: æ¸¬è©¦é€£æ¥

```powershell
# æ¸¬è©¦ HTTP é€£æ¥
Invoke-WebRequest -Uri "https://bossai.jytian.it.com" -Method Head
```

æ‡‰è©²è¿”å›ç‹€æ…‹ç¢¼ 200ï¼ˆä¸æ˜¯ 502ï¼‰

---

## âš ï¸ é‡è¦æç¤º

### Docker ç¶²çµ¡ DNS è§£æ

- **æœå‹™åç¨±**ï¼šåœ¨ `docker-compose.yml` ä¸­å®šç¾©çš„æœå‹™åç¨±ï¼ˆå¦‚ `nginx`ï¼‰
- **å®¹å™¨åç¨±**ï¼š`container_name` æŒ‡å®šçš„åç¨±ï¼ˆå¦‚ `jyt-gas-nginx`ï¼‰

**é€šå¸¸**ï¼š
- åœ¨åŒä¸€å€‹ Docker Compose ç¶²çµ¡ä¸­ï¼Œæœå‹™åç¨±æ‡‰è©²å¯ä»¥è§£æ
- å¦‚æœç„¡æ³•è§£æï¼Œä½¿ç”¨å®¹å™¨åç¨±ä½œç‚ºå‚™é¸æ–¹æ¡ˆ

### Cloudflare Dashboard é…ç½®

- **Service URL** æ‡‰è©²æŒ‡å‘ Docker å…§éƒ¨ç¶²çµ¡åœ°å€
- ä½¿ç”¨ `http://` è€Œä¸æ˜¯ `https://`ï¼ˆå› ç‚ºæ˜¯å…§éƒ¨ç¶²çµ¡ï¼‰
- ç«¯å£æ‡‰è©²æ˜¯ `80`ï¼ˆNginx ç›£è½çš„ç«¯å£ï¼‰

---

## ğŸ“ ç›¸é—œæ–‡ä»¶

- `docker-compose.yml` - Docker Compose é…ç½®
- `nginx.cloudflare.conf` - Nginx é…ç½®
- Cloudflare Dashboard - Tunnel é…ç½®

---

## âœ… ä¿®å¾©ç‹€æ…‹

**è¨ºæ–·æ™‚é–“**ï¼š2025-12-29 09:50

**å•é¡Œç‹€æ…‹**ï¼šğŸ”´ ç™¼ç¾ DNS è§£æå•é¡Œ

**ä¸‹ä¸€æ­¥**ï¼šæª¢æŸ¥ä¸¦ä¿®å¾©ç¶²çµ¡é…ç½®æˆ–ä¿®æ”¹ Cloudflare Dashboard ä¸­çš„ Service URL
