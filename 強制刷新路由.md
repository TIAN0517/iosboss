# ğŸ”„ å¼·åˆ¶åˆ·æ–° Cloudflare è·¯ç”±

## âœ… é…ç½®ç¢ºèª

æ ¹æ“šæ‚¨çš„ Cloudflare Dashboardï¼š
- âœ… Tunnel ç‹€æ…‹ï¼šè‰¯å¥½ï¼ˆå·²é€£æ¥ï¼‰
- âœ… Hostname: `linebot.jytian.it.com`
- âœ… Service: `http://nginx:80`ï¼ˆæ­£ç¢ºï¼‰
- âœ… Path: `*`ï¼ˆé€šé…ç¬¦ï¼Œæ­£ç¢ºï¼‰

**æ‰€æœ‰é…ç½®éƒ½æ­£ç¢ºï¼**

## ğŸ” 521 éŒ¯èª¤çš„åŸå› 

å¾è©³ç´°çš„ curl è¼¸å‡ºå¯ä»¥çœ‹åˆ°ï¼š
```
< HTTP/1.1 521 <none>
< Server: cloudflare
```

é€™æ˜¯ **Cloudflare è¿”å›çš„ 521 éŒ¯èª¤**ï¼Œè¡¨ç¤º Cloudflare ç„¡æ³•é€£æ¥åˆ°æºæœå‹™å™¨ã€‚

**å¯èƒ½çš„åŸå› **ï¼š
1. Cloudflare è·¯ç”±æ›´æ–°å»¶é²ï¼ˆæœ€å¯èƒ½ï¼‰
2. Cloudflare ç·©å­˜äº†èˆŠçš„é…ç½®
3. éœ€è¦å¼·åˆ¶åˆ·æ–°è·¯ç”±

## ğŸ”§ å¼·åˆ¶åˆ·æ–°æ–¹æ³•

### æ–¹æ³• 1ï¼šåˆªé™¤ä¸¦é‡æ–°å‰µå»º Routeï¼ˆæ¨è–¦ï¼‰

åœ¨ Cloudflare Dashboard ä¸­ï¼š

1. **é€²å…¥ Published Application Routes**
   - è¨ªå•ï¼šhttps://one.dash.cloudflare.com/access/tunnels
   - é»æ“Š `jyt-gas-tunnel`
   - é€²å…¥ **å·²ç™¼ä½ˆçš„æ‡‰ç”¨ç¨‹å¼è·¯ç”±** æ¨™ç±¤

2. **åˆªé™¤ç¾æœ‰ Route**
   - æ‰¾åˆ° `linebot.jytian.it.com` é€™ä¸€è¡Œ
   - é»æ“Šå³å´çš„ **åŠŸèƒ½è¡¨**ï¼ˆä¸‰å€‹é»åœ–æ¨™ï¼‰
   - é¸æ“‡ **åˆªé™¤** æˆ– **Delete**

3. **é‡æ–°å‰µå»º Route**
   - é»æ“Š **+ æ–°å¢å·²ç™¼ä½ˆçš„æ‡‰ç”¨ç¨‹å¼è·¯ç”±**
   - å¡«å¯«ï¼š
     - **Hostname**: `linebot.jytian.it.com`
     - **Service**: `http://nginx:80`
     - **Path**: `*`ï¼ˆæˆ–ç•™ç©ºï¼‰
   - é»æ“Š **å„²å­˜** æˆ– **Save**

4. **ç­‰å¾… 2-5 åˆ†é˜**
   - é‡æ–°å‰µå»ºå¾Œï¼ŒCloudflare æœƒç«‹å³æ›´æ–°è·¯ç”±
   - é€šå¸¸æ¯”ç­‰å¾…è‡ªå‹•æ›´æ–°å¿«å¾—å¤š

5. **æ¸¬è©¦**
   ```powershell
   curl https://linebot.jytian.it.com/api/webhook/line
   ```

### æ–¹æ³• 2ï¼šæ¸…é™¤æ‰€æœ‰ç·©å­˜ä¸¦ç­‰å¾…

1. **æ¸…é™¤ Cloudflare ç·©å­˜**
   - è¨ªå•ï¼šhttps://dash.cloudflare.com/
   - é¸æ“‡åŸŸåï¼š`jytian.it.com`
   - é€²å…¥ **Caching** â†’ **Configuration**
   - é»æ“Š **Purge Everything**

2. **ç­‰å¾… 15-30 åˆ†é˜**

3. **å†æ¬¡æ¸¬è©¦**

### æ–¹æ³• 3ï¼šé‡å•Ÿ Tunnelï¼ˆå¯èƒ½æœ‰æ•ˆï¼‰

```powershell
# é‡å•Ÿ Tunnel
docker compose restart cloudflared

# ç­‰å¾… 5 åˆ†é˜
Start-Sleep -Seconds 300

# æ¸¬è©¦
curl https://linebot.jytian.it.com/api/webhook/line
```

## ğŸ¯ æ¨è–¦æ“ä½œé †åº

1. **å…ˆå˜—è©¦æ–¹æ³• 1**ï¼ˆåˆªé™¤ä¸¦é‡æ–°å‰µå»º Routeï¼‰
   - é€™æ˜¯æœ€å¿«çš„æ–¹æ³•
   - é€šå¸¸ 2-5 åˆ†é˜å…§ç”Ÿæ•ˆ

2. **å¦‚æœæ–¹æ³• 1 ç„¡æ•ˆï¼Œå˜—è©¦æ–¹æ³• 2**ï¼ˆæ¸…é™¤ç·©å­˜ï¼‰
   - ç­‰å¾… 15-30 åˆ†é˜

3. **å¦‚æœé‚„æ˜¯ç„¡æ•ˆï¼Œæª¢æŸ¥å…¶ä»–è¨­ç½®**
   - SSL/TLS æ¨¡å¼
   - DNS è¨­ç½®
   - Tunnel é€£æ¥ç‹€æ…‹

## ğŸ“‹ æª¢æŸ¥æ¸…å–®

- [ ] åœ¨ Dashboard ä¸­åˆªé™¤ä¸¦é‡æ–°å‰µå»º Route
- [ ] ç¢ºèª Service URL æ˜¯ `http://nginx:80`
- [ ] æ¸…é™¤ Cloudflare ç·©å­˜
- [ ] ç­‰å¾… 2-5 åˆ†é˜ï¼ˆé‡æ–°å‰µå»ºå¾Œï¼‰
- [ ] æ¸¬è©¦å¤–ç¶²è¨ªå•

## âœ… æˆåŠŸæ¨™èªŒ

ç•¶ä»¥ä¸‹æ¢ä»¶æ»¿è¶³æ™‚ï¼Œå°±æˆåŠŸäº†ï¼š

- âœ… å¤–ç¶²è¨ªå•è¿”å› JSON éŸ¿æ‡‰ï¼ˆä¸æ˜¯ 521ï¼‰
- âœ… éŸ¿æ‡‰åŒ…å« `"status": "ready"`
- âœ… LINE Developers Console é©—è­‰æˆåŠŸ

---

**å»ºè­°**ï¼šå…ˆå˜—è©¦åˆªé™¤ä¸¦é‡æ–°å‰µå»º Routeï¼Œé€™é€šå¸¸æ˜¯æœ€å¿«çš„è§£æ±ºæ–¹æ³•ï¼

