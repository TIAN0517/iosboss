services:
  line-bot-ai:
    build: ./line_bot_ai
    container_name: line-bot-ai
    env_file:
      - .env
    ports:
      - "0.0.0.0:9999:9999"
    # ==================== 穩定運行配置 ====================
    restart: always  # 總是自動重啟
    # 健康檢查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9999/api/health"]
      interval: 30s      # 每 30 秒檢查一次
      timeout: 10s       # 逾時 10 秒
      retries: 3         # 失敗 3 次後標記為不健康
      start_period: 40s  # 容器啟動後 40 秒內不算失敗
    # 資源限制（防止崩潰）
    deploy:
      resources:
        limits:
          cpus: '2.0'      # 最多使用 2 核心
          memory: 2G      # 最多使用 2GB 記憶體
        reservations:
          cpus: '0.5'     # 保留 0.5 核心
          memory: 512M    # 保留 512MB 記憶體
      # 重啟策略
      restart_policy:
        condition: on-failure  # 失敗時重啟
        delay: 5s             # 重啟前等待 5 秒
        max_attempts: 10      # 最多嘗試 10 次
        window: 120s          # 120 秒內計算嘗試次數
    # 環境變量
    environment:
      - PYTHONUNBUFFERED=1  # 即時輸出日誌
      - TZ=Asia/Taipei      # 台灣時區
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
