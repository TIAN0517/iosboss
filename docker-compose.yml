
# ========================================
# 九九瓦斯行管理系統 - Docker Compose
# 完整服務編排：Next.js + PostgreSQL + Nginx + Cloudflare Tunnel
# ========================================

services:
  # ========================================
  # Next.js 應用服務
  # ========================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
    image: jyt-gas-app:${APP_VERSION:-latest}
    container_name: jyt-gas-app
    restart: always

    ports:
      - "${APP_PORT:-9999}:9999"

    # 明確指定環境變量文件（Windows 兼容）
    env_file:
      - .env.docker

    environment:
      # 資料庫連接
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-Ss520520}@postgres:5432/${POSTGRES_DB:-gas_management}?schema=public&connection_limit=20&pool_timeout=30
      - DIRECT_URL=postgresql://postgres:${POSTGRES_PASSWORD:-Ss520520}@postgres:5432/${POSTGRES_DB:-gas_management}

      # 啟動腳本用的資料庫變量
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-Ss520520}
      - POSTGRES_DB=${POSTGRES_DB:-gas_management}

      # 應用環境
      - NODE_ENV=production
      - PORT=9999
      - HOSTNAME=0.0.0.0
      - NEXT_TELEMETRY_DISABLED=1

      # JWT 密鑰
      - JWT_SECRET=${JWT_SECRET:-9hg8PlHMFswnN7FZyfxHOagwqyJ87lZVXQFDKRBc+GY=}

      # AI 提供商配置（優先使用 Ollama）
      - NEXT_AI_PROVIDER=${NEXT_AI_PROVIDER:-ollama}
      
      # Ollama 雲 API 配置（從 env_file 讀取）
      - OLLAMA_API_KEY=${OLLAMA_API_KEY:-}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-deepseek-v3.1:671b}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-https://ollama.com/v1}
      - OLLAMA_TIMEOUT=${OLLAMA_TIMEOUT:-60000}
      - OLLAMA_ENABLE_STREAMING=${OLLAMA_ENABLE_STREAMING:-true}
      
      # GLM API Keys (從 env_file 讀取，不在這裡設置以避免覆蓋)
      # GLM_API_KEYS 和 GLM_API_KEY 從 .env.docker 文件讀取
      - GLM_MODEL=${GLM_MODEL:-glm-4.7-coding-max}
      - GLM_THINKING_ENABLED=${GLM_THINKING_ENABLED:-true}
      - GLM_ENABLE_STREAMING=${GLM_ENABLE_STREAMING:-true}
      - GLM_TIMEOUT=${GLM_TIMEOUT:-60000}

      # LINE Bot
      - LINE_CHANNEL_ACCESS_TOKEN=${LINE_CHANNEL_ACCESS_TOKEN:-}
      - LINE_CHANNEL_SECRET=${LINE_CHANNEL_SECRET:-}
      - LINE_USER_ID=${LINE_USER_ID:-}
      - LINE_SKIP_SIGNATURE_VERIFY=${LINE_SKIP_SIGNATURE_VERIFY:-false}
      - LINE_ADMIN_GROUP_ID=${LINE_ADMIN_GROUP_ID:-}
      - LINE_DRIVER_GROUP_ID=${LINE_DRIVER_GROUP_ID:-}
      - LINE_SALES_GROUP_ID=${LINE_SALES_GROUP_ID:-}

      # 語音服務
      - VOICE_PROVIDER=${VOICE_PROVIDER:-eightwai}
      - VOICE_API_KEY=${VOICE_API_KEY:-}
      - VOICE_WEBHOOK_SECRET=${VOICE_WEBHOOK_SECRET:-}

      # Deepgram ASR (語音轉文字)
      - DG_API_KEY=${DG_API_KEY:-}
      - DG_MODEL=${DG_MODEL:-nova-3}
      - DG_LANGUAGE=${DG_LANGUAGE:-zh-CN}
      - DG_SMART_FORMAT=${DG_SMART_FORMAT:-true}

      # Azure Speech TTS (文字轉語音)
      - AZ_SPEECH_KEY=${AZ_SPEECH_KEY:-}
      - AZ_SPEECH_REGION=${AZ_SPEECH_REGION:-southeastasia}
      - AZ_TTS_VOICE=${AZ_TTS_VOICE:-zh-CN-XiaoxiaoNeural}
      - AZ_TTS_STYLE=${AZ_TTS_STYLE:-chat}
      - AZ_TTS_STYLE_DEGREE=${AZ_TTS_STYLE_DEGREE:-1.15}
      - AZ_TTS_RATE=${AZ_TTS_RATE:--5%}
      - AZ_TTS_PITCH=${AZ_TTS_PITCH:+0%}
      - AZ_TTS_FORMAT=${AZ_TTS_FORMAT:-audio-16khz-128kbitrate-mono-mp3}

      # AI 內部端點（容器網絡，必須使用服務名）
      - AI_INTERNAL_ENDPOINT=${AI_INTERNAL_ENDPOINT:-http://jyt-gas-app:9999/api/ai/chat}

      # 川紀 API 整合
      - CJ_ENABLED=${CJ_ENABLED:-false}
      - CJ_API_URL=${CJ_API_URL:-}
      - CJ_API_KEY=${CJ_API_KEY:-}
      - CJ_API_TIMEOUT=${CJ_API_TIMEOUT:-10000}
      - CJ_MSSQL_HOST=${CJ_MSSQL_HOST:-}
      - CJ_MSSQL_PORT=${CJ_MSSQL_PORT:-1433}
      - CJ_MSSQL_DATABASE=${CJ_MSSQL_DATABASE:-}
      - CJ_MSSQL_USE_WINDOWS_AUTH=${CJ_MSSQL_USE_WINDOWS_AUTH:-true}
      - CJ_MSSQL_DOMAIN=${CJ_MSSQL_DOMAIN:-}
      - CJ_MSSQL_USER=${CJ_MSSQL_USER:-}
      - CJ_MSSQL_PASSWORD=${CJ_MSSQL_PASSWORD:-}
      - CJ_MSSQL_ENCRYPT=${CJ_MSSQL_ENCRYPT:-false}
      - CJ_MSSQL_TRUST_CERT=${CJ_MSSQL_TRUST_CERT:-true}

      # WebSocket 同步服務
      - SYNC_WEBSOCKET_ENABLED=${SYNC_WEBSOCKET_ENABLED:-false}
      - SYNC_WEBSOCKET_PORT=${SYNC_WEBSOCKET_PORT:-3005}

      # 配送管理
      - DISPATCH_AUTO_ASSIGN_ENABLED=${DISPATCH_AUTO_ASSIGN_ENABLED:-false}
      - DISPATCH_AUTO_ASSIGN_RADIUS=${DISPATCH_AUTO_ASSIGN_RADIUS:-10}

      # 司機位置追蹤
      - DRIVER_LOCATION_TRACKING_ENABLED=${DRIVER_LOCATION_TRACKING_ENABLED:-true}
      - DRIVER_LOCATION_UPDATE_INTERVAL=${DRIVER_LOCATION_UPDATE_INTERVAL:-30}
      - DRIVER_LOCATION_RETENTION_DAYS=${DRIVER_LOCATION_RETENTION_DAYS:-90}
      - DRIVER_APP_NOTIFICATION_ENABLED=${DRIVER_APP_NOTIFICATION_ENABLED:-true}
      - DRIVER_APP_SMS_NOTIFICATION_ENABLED=${DRIVER_APP_SMS_NOTIFICATION_ENABLED:-true}

      # 車訊快遞服務
      - VEHICLE_EXPRESS_ENABLED=${VEHICLE_EXPRESS_ENABLED:-true}
      - VEHICLE_EXPRESS_SMS_ENABLED=${VEHICLE_EXPRESS_SMS_ENABLED:-true}
      - VEHICLE_EXPRESS_SENDER_ID=${VEHICLE_EXPRESS_SENDER_ID:-JY99GAS}
      - VEHICLE_EXPRESS_SMS_USERNAME=${VEHICLE_EXPRESS_SMS_USERNAME:-}
      - VEHICLE_EXPRESS_SMS_PASSWORD=${VEHICLE_EXPRESS_SMS_PASSWORD:-}
      - VEHICLE_EXPRESS_SMS_ON_WAY=${VEHICLE_EXPRESS_SMS_ON_WAY:-}
      - VEHICLE_EXPRESS_SMS_ARRIVED=${VEHICLE_EXPRESS_SMS_ARRIVED:-}
      - VEHICLE_EXPRESS_SMS_COMPLETED=${VEHICLE_EXPRESS_SMS_COMPLETED:-}
      - VEHICLE_EXPRESS_TRACKING_ENABLED=${VEHICLE_EXPRESS_TRACKING_ENABLED:-true}
      - VEHICLE_EXPRESS_TRACKING_INTERVAL=${VEHICLE_EXPRESS_TRACKING_INTERVAL:-300}

      # 會計同步
      - ACCOUNTING_SYNC_ENABLED=${ACCOUNTING_SYNC_ENABLED:-false}
      - ACCOUNTING_SYNC_API_KEY=${ACCOUNTING_SYNC_API_KEY:-}
      - ACCOUNTING_SYNC_API_URL=${ACCOUNTING_SYNC_API_URL:-}
      - ACCOUNTING_SYNC_INTERVAL=${ACCOUNTING_SYNC_INTERVAL:-3600}

      # 庫存管理
      - MIN_STOCK_ALERT_LEVEL=${MIN_STOCK_ALERT_LEVEL:-10}

      # Webhook 配置
      - WEBHOOK_TIMEOUT=${WEBHOOK_TIMEOUT:-30000}
      - WEBHOOK_RETRY_COUNT=${WEBHOOK_RETRY_COUNT:-3}
      - WEBHOOK_SIGNATURE_SECRET=${WEBHOOK_SIGNATURE_SECRET:-}

      # GLM 語音服務
      - GLM_STT_MODEL=${GLM_STT_MODEL:-glm-4v}
      - GLM_TTS_MODEL=${GLM_TTS_MODEL:-tts-1}
      - TTS_VOICE=${TTS_VOICE:-zh-cn-female-standard}
      - TTS_SPEED=${TTS_SPEED:-1.0}
      - TTS_PITCH=${TTS_PITCH:-1.0}

      # 自動初始化數據庫
      - DB_AUTO_MIGRATE=${DB_AUTO_MIGRATE:-true}
      - DB_AUTO_SEED=${DB_AUTO_SEED:-true}

    # 額外的 hosts 映射（解決 DNS 問題）
    extra_hosts:
      - "postgres:172.18.0.3"

    # 資源限制
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    volumes:
      - gas_data:/app/data
      - app_uploads:/app/public/uploads

    # 使用 Dockerfile 中的启动脚本（移除 command 以使用默认 CMD）
    # command: ["node", ".next/standalone/server.js"]

    depends_on:
      postgres:
        condition: service_healthy

    # DNS 配置（提高網絡穩定性）
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1

    # 服務標籤（便於管理和監控）
    labels:
      - "com.jyt.service=app"
      - "com.jyt.environment=production"
      - "com.jyt.version=${APP_VERSION:-latest}"

    networks:
      - jyt-network

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9999/api/health && curl -fsS http://localhost:9999/api/voice/diag | jq -e '.healthy == true' || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 90s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

  # ========================================
  # PostgreSQL 資料庫服務
  # ========================================
  postgres:
    image: postgres:16-alpine
    container_name: jyt-gas-postgres
    restart: always

    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-Ss520520}
      - POSTGRES_DB=${POSTGRES_DB:-gas_management}
      - PGDATA=/var/lib/postgresql/data/pgdata

      # 效能調優
      - POSTGRES_SHARED_BUFFERS=256MB
      - POSTGRES_EFFECTIVE_CACHE_SIZE=1GB
      - POSTGRES_MAINTENANCE_WORK_MEM=64MB
      - POSTGRES_WORK_MEM=4MB
      - POSTGRES_MAX_CONNECTIONS=100

    volumes:
      - postgres_data:/var/lib/postgresql/data
      # PostgreSQL 初始化 SQL 腳本（不包括 .sh 文件）
      - ./db/init/01-init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro

    ports:
      - "${POSTGRES_PORT:-5433}:5432"

    # 效能優化：啟動參數
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "work_mem=4MB"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "synchronous_commit=on"
      - "-c"
      - "deadlock_timeout=1s"

    networks:
      - jyt-network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-gas_management}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

    shm_size: 128mb

    # 資源限制
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # ========================================
  # Nginx 反向代理 (Cloudflare CDN 模式)
  # ========================================
  nginx:
    image: nginx:alpine
    container_name: jyt-gas-nginx
    restart: always
    # 使用內部網絡，不通過 Cloudflare Tunnel 暴露
    expose:
      - "80"
    volumes:
      - ./nginx.cloudflare.conf:/etc/nginx/nginx.conf:ro
      # SSL 憑證（如果不用 Cloudflare CDN）
      # - ./certs:/etc/nginx/certs:ro
      - nginx_cache:/var/cache/nginx
      - nginx_logs:/var/log/nginx
    command: >
      /bin/sh -c "rm -f /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"
    depends_on:
      app:
        condition: service_healthy
      postgres:
        condition: service_started
    networks:
      - jyt-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

    # 資源限制
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

  # ========================================
  # Cloudflare Tunnel (cloudflared)
  # ========================================
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: jyt-gas-cloudflared
    restart: always  # 改為 always，確保容器意外停止後自動重啟
    # 明確指定環境變量文件（Windows 兼容）
    env_file:
      - .env.docker
    # 使用 token 方式（配置由 Cloudflare Dashboard 管理）
    # 注意：如果使用 --token，配置應該在 Cloudflare Dashboard 中設置，不需要本地配置文件
    command: ["tunnel", "--no-autoupdate", "run", "--token", "${CF_TUNNEL_TOKEN}"]
    # 如果需要在本地管理配置，使用以下命令（但需要移除 --token）：
    # command: ["tunnel", "--no-autoupdate", "--config", "/etc/cloudflared/config.yml", "run"]
    # volumes:
    #   - ${PWD}/cloudflared.yml:/etc/cloudflared/config.yml:ro
    depends_on:
      nginx:
        condition: service_healthy
    networks:
      - jyt-network
    # 健康檢查 (cloudflared 鏡像為 distroless，無法執行健康檢查命令)
    # 服務實際運行正常，通過日誌和隧道連接狀態確認
    # healthcheck:
    #   test: ["CMD-SHELL", "exit 0"]
    #   interval: 30s
    #   timeout: 5s
    #   retries: 3
    #   start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"  # 增加到 3 個文件
        compress: "true"

    # 資源限制
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 32M

  # ========================================
  # 資料庫自動備份服務
  # ========================================
  backup:
    image: postgres:16-alpine
    container_name: jyt-gas-backup
    restart: always

    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-Ss520520}
      - POSTGRES_DB=${POSTGRES_DB:-gas_management}
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-7}
      - TZ=Asia/Taipei

    volumes:
      - ./backups:/backups
      - postgres_data:/var/lib/postgresql/data:ro

    networks:
      - jyt-network

    # 使用簡單的睡眠循環，每天凌晨 3 點執行備份
    command: >
      sh -c 'echo "Backup service started" && while true; do hour=$$(date +%H); min=$$(date +%M); if [ "$$hour" = "03" ] && [ "$$min" = "00" ]; then echo "Starting backup..."; pg_dump -h postgres -U postgres gas_management | gzip > /backups/backup-$$(date +%Y%m%d-%H%M%S).sql.gz && echo "Backup done"; find /backups -name "*.sql.gz" -mtime +7 -delete; sleep 60; fi; sleep 30; done'

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"
        compress: "true"

    # 資源限制
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

  # ========================================
  # 來電顯示 WebSocket 服務
  # ========================================
  call-display-service:
    build:
      context: ./mini-services/call-display-service
      dockerfile: Dockerfile
    image: jyt-gas-call-display:${APP_VERSION:-latest}
    container_name: jyt-gas-call-display
    restart: always
    environment:
      - NODE_ENV=production
      - PORT=3004
      - APP_URL=${CALL_DISPLAY_APP_URL:-http://app:9999}
      - CORS_ORIGIN=${CALL_DISPLAY_CORS_ORIGIN:-*}
    ports:
      - "${CALL_DISPLAY_SERVICE_PORT:-3004}:3004"
    networks:
      - jyt-network
    depends_on:
      app:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3004 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

  # ========================================
  # 即時同步 WebSocket 服務
  # ========================================
  sync-websocket-service:
    build:
      context: .
      dockerfile: mini-services/sync-websocket-service/Dockerfile
    image: jyt-gas-sync-websocket:${APP_VERSION:-latest}
    container_name: jyt-gas-sync-websocket
    restart: always
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-Ss520520}@postgres:5432/${POSTGRES_DB:-gas_management}?schema=public&connection_limit=20&pool_timeout=30
      - NODE_ENV=production
      - SYNC_WEBSOCKET_ENABLED=${SYNC_WEBSOCKET_ENABLED:-true}
      - SYNC_WEBSOCKET_PORT=${SYNC_WEBSOCKET_PORT:-3005}
      - CORS_ORIGIN=${SYNC_WEBSOCKET_CORS_ORIGIN:-*}
    ports:
      - "${SYNC_WEBSOCKET_PORT:-3005}:3005"
    networks:
      - jyt-network
    depends_on:
      postgres:
        condition: service_healthy
      app:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3005 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

# ========================================
# Volumes (數據持久化)
# ========================================
volumes:
  postgres_data:
    driver: local
    name: jyt-gas-postgres-data
  gas_data:
    driver: local
    name: jyt-gas-app-data
  app_uploads:
    driver: local
    name: jyt-gas-uploads
  nginx_cache:
    driver: local
    name: jyt-gas-nginx-cache
  nginx_logs:
    driver: local
    name: jyt-gas-nginx-logs

# ========================================
# Networks
# ========================================
networks:
  jyt-network:
    name: jyt-gas-network
    driver: bridge
    # 改為內部網絡，讓 Docker Compose 自動創建
    # external: true  # 已移除，改為自動創建
