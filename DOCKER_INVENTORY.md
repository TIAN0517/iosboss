# ä¹ä¹ç“¦æ–¯è¡Œç®¡ç†ç³»çµ± - Docker å°ˆæ¡ˆç›¤é»

> ğŸ“‹ **ç‰ˆæœ¬**: v1.0.0
> ğŸ“… **æ—¥æœŸ**: 2025-01-25
> ğŸ‘¥ **å°ˆæ¡ˆ**: JyæŠ€è¡“åœ˜éšŠ

---

## ğŸ“š ç›®éŒ„

1. [Docker æª”æ¡ˆæ¸…å–®](#docker-æª”æ¡ˆæ¸…å–®)
2. [Dockerfile åˆ†æ](#dockerfile-åˆ†æ)
3. [Docker Compose åˆ†æ](#docker-compose-åˆ†æ)
4. [éƒ¨ç½²æ¶æ§‹åœ–](#éƒ¨ç½²æ¶æ§‹åœ–)
5. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
6. [ç’°å¢ƒè®Šæ•¸é…ç½®](#ç’°å¢ƒè®Šæ•¸é…ç½®)
7. [å¸¸è¦‹å•é¡Œ](#å¸¸è¦‹å•é¡Œ)

---

## Docker æª”æ¡ˆæ¸…å–®

### ğŸ“ å°ˆæ¡ˆ Docker æª”æ¡ˆçµæ§‹

```
ä¹ä¹ç“¦æ–¯è¡Œç®¡ç†ç³»çµ±/
â”œâ”€â”€ Dockerfile               # ä¸»è¦ Dockerfile (Next.js æ‡‰ç”¨)
â”œâ”€â”€ docker-compose.yml       # Docker Compose ç·¨æ’é…ç½®
â”œâ”€â”€ .dockerignore           # Docker æ§‹å»ºå¿½ç•¥è¦å‰‡
â”œâ”€â”€ ecosystem.config.js     # PM2 é…ç½® (é Docker éƒ¨ç½²ä½¿ç”¨)
â”œâ”€â”€ Caddyfile              # Caddy åå‘ä»£ç† (é Docker éƒ¨ç½²ä½¿ç”¨)
â””â”€â”€ .env                   # ç’°å¢ƒè®Šæ•¸ (ä¸é€²å…¥ Docker æ˜ åƒ)
```

### ğŸ“‹ æª”æ¡ˆèªªæ˜

| æª”æ¡ˆ | ç”¨é€” | ç‹€æ…‹ |
|------|------|------|
| `Dockerfile` | Next.js æ‡‰ç”¨å®¹å™¨åŒ– | âœ… å®Œæ•´ |
| `docker-compose.yml` | å¤šæœå‹™ç·¨æ’ (App + DB) | âœ… å®Œæ•´ |
| `.dockerignore` | æ§‹å»ºå„ªåŒ– | âœ… å®Œæ•´ |
| `nginx.conf` | Nginx åå‘ä»£ç† | âŒ ç¼ºå¤± (å¯é¸) |
| `.env.docker` | Docker å°ˆç”¨ç’°å¢ƒè®Šæ•¸ | âŒ ç¼ºå¤± (å»ºè­°æ–°å¢) |

---

## Dockerfile åˆ†æ

### ğŸ—ï¸ æ§‹å»ºéšæ®µ

```dockerfile
# ========================================
# ä¸‰éšæ®µå»ºç½®ï¼šdeps â†’ builder â†’ runner
# ========================================

# éšæ®µ 1: Dependencies (ä¾è³´å±¤)
FROM node:lts-alpine AS deps
  â”œâ”€ å®‰è£ libc6-compat (ç›¸å®¹æ€§)
  â”œâ”€ è¤‡è£½ package.json
  â””â”€ npm ci (å®‰è£ä¾è³´)

# éšæ®µ 2: Builder (å»ºç½®å±¤)
FROM node:lts-alpine AS builder
  â”œâ”€ è¤‡è£½ node_modules (ä¾†è‡ª deps)
  â”œâ”€ è¤‡è£½æºä»£ç¢¼
  â”œâ”€ npx prisma generate (ç”Ÿæˆ Prisma Client)
  â””â”€ npm run build (å»ºç½® Next.js)

# éšæ®µ 3: Runner (ç”Ÿç”¢ç’°å¢ƒ)
FROM node:lts-alpine AS runner
  â”œâ”€ å®‰è£ç³»çµ±å·¥å…· (curl, netcat, openssl)
  â”œâ”€ å‰µå»ºé root ç”¨æˆ¶ (nextjs:1001)
  â”œâ”€ è¤‡è£½å»ºç½®ç”¢ç‰©
  â”œâ”€ è¤‡è£½ Prisma æ–‡ä»¶
  â”œâ”€ æš´éœ²ç«¯å£ 9999
  â”œâ”€ å¥åº·æª¢æŸ¥ (/api/health)
  â””â”€ å•Ÿå‹•å‘½ä»¤ (node server.js)
```

### ğŸ“Š æ˜ åƒå±¤ç´šåˆ†æ

```
æœ€çµ‚æ˜ åƒå¤§å°é ä¼°: ~350-450 MB (Alpine Linux)

â”œâ”€â”€ node:lts-alpine åŸºç¤æ˜ åƒ    ~120 MB
â”œâ”€â”€ node_modules (ç”Ÿç”¢ä¾è³´)    ~200 MB
â”œâ”€â”€ .next/standalone (å»ºç½®ç”¢ç‰©) ~80 MB
â”œâ”€â”€ .next/static (éœæ…‹è³‡æº)    ~30 MB
â”œâ”€â”€ public (å…¬å…±è³‡æº)          ~5 MB
â””â”€â”€ prisma (Prisma Client)     ~15 MB
```

### ğŸ” å„ªåŒ–è¦é»

| å„ªåŒ–é … | å¯¦ç¾æ–¹å¼ | æ•ˆæœ |
|--------|----------|------|
| **å¤šéšæ®µå»ºç½®** | deps â†’ builder â†’ runner | æ¸›å°‘æœ€çµ‚æ˜ åƒå¤§å° |
| **Alpine Linux** | node:lts-alpine | åŸºç¤æ˜ åƒæœ€å°åŒ– |
| **é root ç”¨æˆ¶** | adduser -S nextjs | æå‡å®‰å…¨æ€§ |
| **å¥åº·æª¢æŸ¥** | HEALTHCHECK æŒ‡ä»¤ | å®¹å™¨å¥åº·ç›£æ§ |
| **ä¾è³´å¿«å–** | ç¨ç«‹ deps éšæ®µ | åŠ é€Ÿé‡è¤‡å»ºç½® |

### âš™ï¸ é—œéµé…ç½®èªªæ˜

```dockerfile
# 1. åŸºç¤æ˜ åƒé¸æ“‡
FROM node:lts-alpine
# - Alpine Linux: é«”ç©å°ã€å®‰å…¨æ€§é«˜
# - LTS ç‰ˆæœ¬: é•·æœŸæ”¯æŒã€ç©©å®š

# 2. ç’°å¢ƒè®Šé‡è¨­ç½®
ENV NEXT_TELEMETRY_DISABLED=1
# - ç¦ç”¨ Next.js é™æ¸¬
# - ä¿è­·éš±ç§ã€æ¸›å°‘ç¶²çµ¡è«‹æ±‚

# 3. Prisma ç”Ÿæˆ
RUN npx prisma generate
# - åœ¨å»ºç½®éšæ®µç”Ÿæˆ Client
# - é¿å…é‹è¡Œæ™‚ç”Ÿæˆ

# 4. ç”¨æˆ¶æ¬Šé™
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nextjs -u 1001 -G nodejs
# - UID 1001: é root ç”¨æˆ¶
# - æå‡å®¹å™¨å®‰å…¨æ€§

# 5. å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=15s --timeout=5s --start-period=30s --retries=3
# - æ¯ 15 ç§’æª¢æŸ¥ä¸€æ¬¡
# - è¶…æ™‚ 5 ç§’
# - å•Ÿå‹•å¯¬é™æœŸ 30 ç§’
# - å¤±æ•— 3 æ¬¡æ¨™è¨˜ç‚ºä¸å¥åº·
```

---

## Docker Compose åˆ†æ

### ğŸ³ æœå‹™æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Docker Compose ç¶²çµ¡                       â”‚
â”‚                    (jyt-network: 172.20.0.0/16)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  app (Next.js) â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  postgres      â”‚         â”‚
â”‚  â”‚  :9999         â”‚   å…§éƒ¨ç¶²çµ¡    â”‚  :5432         â”‚         â”‚
â”‚  â”‚  Port: 9999   â”‚              â”‚  Port: 5432    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                                â”‚                  â”‚
â”‚         â–¼                                â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  gas_data      â”‚              â”‚  postgres_data â”‚         â”‚
â”‚  â”‚  (Volume)      â”‚              â”‚  (Volume)      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                              â”‚
â”‚  è¨»: nginx æœå‹™å·²é…ç½®ä½†é è¨­è¨»é‡‹                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“¦ æœå‹™è©³ç´°é…ç½®

#### 1ï¸âƒ£ app æœå‹™ (Next.js æ‡‰ç”¨)

| é…ç½®é … | å€¼ | èªªæ˜ |
|--------|-----|------|
| **æ˜ åƒ** | `jyt-gas-app:latest` | è‡ªå®šç¾©æ˜ åƒåç¨± |
| **å®¹å™¨å** | `jyt-gas-app` | ä¾¿æ–¼è­˜åˆ¥å’Œç®¡ç† |
| **é‡å•Ÿç­–ç•¥** | `unless-stopped` | é™¤éæ‰‹å‹•åœæ­¢ï¼Œå¦å‰‡è‡ªå‹•é‡å•Ÿ |
| **ç«¯å£** | `9999:9999` | ä¸»æ©Ÿç«¯å£:å®¹å™¨ç«¯å£ |
| **ä¾è³´** | `postgres: healthy` | ç­‰å¾…è³‡æ–™åº«å¥åº·å¾Œå•Ÿå‹• |
| **ç¶²çµ¡** | `jyt-network` | è‡ªå®šç¾©æ©‹æ¥ç¶²çµ¡ |

**å¥åº·æª¢æŸ¥:**
```yaml
test: ["CMD", "node", "-e", "require('http').get(...)"]
interval: 15s
timeout: 5s
retries: 3
start_period: 30s
```

**æ—¥èªŒé…ç½®:**
```yaml
driver: "json-file"
options:
  max-size: "10m"  # å–®å€‹æ—¥èªŒæ–‡ä»¶æœ€å¤§ 10MB
  max-file: "3"    # ä¿ç•™æœ€è¿‘ 3 å€‹æ–‡ä»¶
  compress: "true" # å£“ç¸®èˆŠæ—¥èªŒ
```

**DNS è¨­å®š:**
```yaml
dns:
  - 8.8.8.8   # Google DNS
  - 8.8.4.4   # Google DNS å‚™ç”¨
```

#### 2ï¸âƒ£ postgres æœå‹™ (PostgreSQL è³‡æ–™åº«)

| é…ç½®é … | å€¼ | èªªæ˜ |
|--------|-----|------|
| **æ˜ åƒ** | `postgres:16-alpine` | PostgreSQL 16 Alpine ç‰ˆ |
| **å®¹å™¨å** | `jyt-gas-postgres` | ä¾¿æ–¼è­˜åˆ¥ |
| **ç«¯å£** | `5432:5432` | ä¸»æ©Ÿç«¯å£:å®¹å™¨ç«¯å£ (å¯å¾å¤–éƒ¨è¨ªå•) |
| **è³‡æ–™åº«** | `gas_management` | é è¨­è³‡æ–™åº«å |
| **ç”¨æˆ¶** | `postgres` | é è¨­ç”¨æˆ¶å |
| **å¯†ç¢¼** | `Ss520520` (é è¨­) | âš ï¸ ç”Ÿç”¢ç’°å¢ƒå¿…é ˆä¿®æ”¹ |

**æ•ˆèƒ½èª¿å„ªåƒæ•¸:**
```yaml
# ç’°å¢ƒè®Šæ•¸
POSTGRES_SHARED_BUFFERS=256MB        # å…±äº«ç·©è¡å€
POSTGRES_EFFECTIVE_CACHE_SIZE=1GB    # æœ‰æ•ˆç·©å­˜å¤§å°
POSTGRES_MAINTENANCE_WORK_MEM=64MB   # ç¶­è­·æ“ä½œå…§å­˜
POSTGRES_WORK_MEM=4MB                # å–®å€‹æ“ä½œå…§å­˜
POSTGRES_MAX_CONNECTIONS=100          # æœ€å¤§é€£æ¥æ•¸

# å•Ÿå‹•åƒæ•¸
-c random_page_cost=1.1              # éš¨æ©Ÿé é¢æˆæœ¬
-c synchronous_commit=on             # åŒæ­¥æäº¤
-c deadlock_timeout=1s               # æ­»é–è¶…æ™‚
```

**å…±äº«å…§å­˜:**
```yaml
shm_size: 128mb  # PostgreSQL æ“ä½œéœ€è¦
```

#### 3ï¸âƒ£ nginx æœå‹™ (å¯é¸ - å·²è¨»é‡‹)

| é…ç½®é … | å€¼ | èªªæ˜ |
|--------|-----|------|
| **æ˜ åƒ** | `nginx:alpine` | Nginx Alpine ç‰ˆ |
| **å®¹å™¨å** | `jyt-gas-nginx` | |
| **ç«¯å£** | `80:80`, `443:443` | HTTP/HTTPS |
| **ä¾è³´** | `app: healthy` | ç­‰å¾…æ‡‰ç”¨å¥åº·å¾Œå•Ÿå‹• |

**ç‹€æ…‹:** ğŸ”´ å·²è¨»é‡‹ï¼Œéœ€è¦æ™‚å¯å•Ÿç”¨

### ğŸ’¾ æ•¸æ“šå· (Volumes)

| å·å | ç”¨é€” | å‘½å |
|------|------|------|
| `postgres_data` | PostgreSQL æ•¸æ“šæŒä¹…åŒ– | `jyt-gas-postgres-data` |
| `gas_data` | æ‡‰ç”¨æ•¸æ“š | `jyt-gas-app-data` |
| `app_uploads` | ç”¨æˆ¶ä¸Šå‚³æ–‡ä»¶ | `jyt-gas-uploads` |
| `nginx_cache` | Nginx å¿«å– (å·²è¨»é‡‹) | `jyt-gas-nginx-cache` |
| `nginx_logs` | Nginx æ—¥èªŒ (å·²è¨»é‡‹) | `jyt-gas-nginx-logs` |

### ğŸŒ ç¶²çµ¡é…ç½®

```yaml
networks:
  jyt-network:
    driver: bridge
    name: jyt-gas-network
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    driver_opts:
      com.docker.network.bridge.name: br-jyt-gas
```

**ç¶²çµ¡è¨­å®š:**
- **å­ç¶²:** `172.20.0.0/16` (65534 å€‹å¯ç”¨ IP)
- **é–˜é“:** `172.20.0.1`
- **æ©‹æ¥åç¨±:** `br-jyt-gas`
- **DNS:** ä½¿ç”¨ Google DNS (8.8.8.8, 8.8.4.4)

---

## éƒ¨ç½²æ¶æ§‹åœ–

### ğŸ¢ ç”Ÿç”¢ç’°å¢ƒæ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å¤–éƒ¨è¨ªå•å±¤                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            ç”¨æˆ¶ç€è¦½å™¨ (iOS Safari / Chrome)             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                     â”‚
â”‚                           â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   Docker Host                            â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚              Docker Engine                         â”‚  â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚   â”‚
â”‚  â”‚  â”‚                                                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ jyt-gas-app  â”‚â—€â”€â”€â”€â”€â”‚ jyt-gas-     â”‚           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  :9999       â”‚      â”‚ postgres     â”‚           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚              â”‚      â”‚  :5432       â”‚           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Next.js     â”‚      â”‚ PostgreSQL  â”‚           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Prisma      â”‚      â”‚  16-alpine  â”‚           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚         â”‚                       â”‚                  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚            â”‚                       â”‚                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚  jyt-network (Bridge)   â”‚  â”‚ postgres_data    â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  172.20.0.0/16          â”‚  â”‚  (Volume)        â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”„ å®¹å™¨äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ¶è«‹æ±‚   â”‚â”€â”€â”€â”€â–¶â”‚  Port 9999  â”‚â”€â”€â”€â”€â–¶â”‚  app å®¹å™¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                       â”‚  Prisma ORM â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                       â”‚postgreså®¹å™¨ â”‚
                                       â”‚ Port 5432   â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                       â”‚postgres_data â”‚
                                       â”‚ (Volume)    â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä½¿ç”¨æŒ‡å—

### ğŸš€ å¿«é€Ÿé–‹å§‹

#### 1. å‰ç½®è¦æ±‚

```bash
# æª¢æŸ¥ Docker ç‰ˆæœ¬
docker --version  # >= 20.10
docker compose version  # >= 2.0

# æª¢æŸ¥ Docker æœå‹™ç‹€æ…‹
docker ps
```

#### 2. æ§‹å»ºæ˜ åƒ

```bash
# ä½¿ç”¨ Docker Compose æ§‹å»º
docker compose build

# åªå»ºç½® app æœå‹™
docker compose build app

# æŸ¥çœ‹æ˜ åƒå¤§å°
docker images | grep jyt-gas
```

#### 3. å•Ÿå‹•æœå‹™

```bash
# å•Ÿå‹•æ‰€æœ‰æœå‹™ (å¾Œå°é‹è¡Œ)
docker compose up -d

# æŸ¥çœ‹æœå‹™ç‹€æ…‹
docker compose ps

# æŸ¥çœ‹æ—¥èªŒ
docker compose logs -f app
docker compose logs -f postgres
```

#### 4. åˆå§‹åŒ–è³‡æ–™åº«

```bash
# é€²å…¥ app å®¹å™¨
docker compose exec app sh

# åœ¨å®¹å™¨å…§åŸ·è¡Œ
npx prisma db push
npx prisma db seed  # å¦‚æœæœ‰ seed è…³æœ¬

# æˆ–ä½¿ç”¨ API åˆå§‹åŒ–
curl -X POST http://localhost:9999/api/init
```

#### 5. è¨ªå•æ‡‰ç”¨

```
URL: http://localhost:9999
```

#### 6. åœæ­¢æœå‹™

```bash
# åœæ­¢æ‰€æœ‰æœå‹™
docker compose down

# åœæ­¢ä¸¦åˆªé™¤æ•¸æ“šå· (âš ï¸ å±éšªæ“ä½œ)
docker compose down -v
```

### ğŸ”§ å¸¸ç”¨æ“ä½œ

#### æŸ¥çœ‹å®¹å™¨æ—¥èªŒ

```bash
# æ‰€æœ‰æœå‹™æ—¥èªŒ
docker compose logs

# è¿½è¹¤ app æœå‹™æ—¥èªŒ
docker compose logs -f app

# æœ€è¿‘ 100 è¡Œæ—¥èªŒ
docker compose logs --tail=100 app
```

#### é€²å…¥å®¹å™¨

```bash
# é€²å…¥ app å®¹å™¨ (shell)
docker compose exec app sh

# é€²å…¥ postgres å®¹å™¨
docker compose exec postgres sh

# é€²å…¥ postgres psql
docker compose exec postgres psql -U postgres -d gas_management
```

#### é‡å•Ÿæœå‹™

```bash
# é‡å•Ÿæ‰€æœ‰æœå‹™
docker compose restart

# é‡å•Ÿå–®å€‹æœå‹™
docker compose restart app
docker compose restart postgres
```

#### æ›´æ–°æœå‹™

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç¢¼
git pull

# 2. é‡æ–°å»ºç½®æ˜ åƒ
docker compose build

# 3. é‡å•Ÿæœå‹™
docker compose up -d

# 4. æ¸…ç†èˆŠæ˜ åƒ (å¯é¸)
docker image prune -a
```

#### æ•¸æ“šåº«å‚™ä»½

```bash
# å‚™ä»½ postgres æ•¸æ“š
docker compose exec postgres pg_dump -U postgres gas_management > backup.sql

# é‚„åŸ
cat backup.sql | docker compose exec -T postgres psql -U postgres gas_management
```

---

## ç’°å¢ƒè®Šæ•¸é…ç½®

### ğŸ“‹ å¿…è¦ç’°å¢ƒè®Šæ•¸

| è®Šæ•¸åç¨± | é è¨­å€¼ | èªªæ˜ | ç”Ÿç”¢ç’°å¢ƒ |
|----------|--------|------|----------|
| `DATABASE_URL` | - | è³‡æ–™åº«é€£æ¥å­—ç¬¦ä¸² | âš ï¸ å¿…é ˆä¿®æ”¹ |
| `JWT_SECRET` | `9hg8PlHMF...` | JWT å¯†é‘° | âš ï¸ å¿…é ˆä¿®æ”¹ |
| `POSTGRES_PASSWORD` | `Ss520520` | PostgreSQL å¯†ç¢¼ | âš ï¸ å¿…é ˆä¿®æ”¹ |

### ğŸ”‘ API å¯†é‘° (å¯é¸)

| è®Šæ•¸åç¨± | é è¨­å€¼ | èªªæ˜ |
|----------|--------|------|
| `GLM_API_KEYS` | - | GLM AI API å¯†é‘° (é€—è™Ÿåˆ†éš”) |
| `GLM_API_KEY` | - | GLM ä¸» API å¯†é‘° |
| `GLM_MODEL` | `glm-4.7` | GLM æ¨¡å‹åç¨± |
| `LINE_CHANNEL_ACCESS_TOKEN` | - | LINE Bot Access Token |
| `LINE_CHANNEL_SECRET` | - | LINE Bot Channel Secret |
| `VOICE_PROVIDER` | `eightwai` | èªéŸ³æœå‹™æä¾›å•† |

### âš™ï¸ é…ç½®å»ºè­°

#### é–‹ç™¼ç’°å¢ƒ (.env.development)

```bash
# è³‡æ–™åº«
DATABASE_URL="postgresql://postgres:Ss520520@localhost:5432/gas_management?schema=public"

# æ‡‰ç”¨
NODE_ENV="development"
PORT=9999

# JWT (é–‹ç™¼ç”¨)
JWT_SECRET="dev-secret-do-not-use-in-production"

# GLM AI (å¯é¸)
GLM_API_KEY="your-dev-key"

# æ—¥èªŒ
LOG_LEVEL="debug"
DATABASE_LOGGING="true"
```

#### ç”Ÿç”¢ç’°å¢ƒ (.env.production)

```bash
# âš ï¸ è³‡æ–™åº« - ä½¿ç”¨å¼·å¯†ç¢¼
DATABASE_URL="postgresql://postgres:STRONG_PASSWORD_HERE@postgres:5432/gas_management?schema=public&connection_limit=20&pool_timeout=30"

# æ‡‰ç”¨
NODE_ENV="production"
PORT=9999

# âš ï¸ JWT - ä½¿ç”¨ç”Ÿæˆçš„å¼·å¯†é‘°
JWT_SECRET="openssl rand -base64 32"

# GLM AI (ç”Ÿç”¢ç”¨)
GLM_API_KEYS="key1,key2,key3"
GLM_MODEL="glm-4.7"
GLM_THINKING_ENABLED="true"

# LINE Bot
LINE_CHANNEL_ACCESS_TOKEN="your-production-token"
LINE_CHANNEL_SECRET="your-production-secret"

# æ—¥èªŒ
LOG_LEVEL="info"
DATABASE_LOGGING="false"
```

### ğŸ” å®‰å…¨å¯†é‘°ç”Ÿæˆ

```bash
# ç”Ÿæˆ JWT_SECRET
openssl rand -base64 32

# ç”Ÿæˆ POSTGRES_PASSWORD
openssl rand -base64 16

# ç”Ÿæˆ LINE_WEBHOOK_SECRET
openssl rand -hex 32
```

---

## å¸¸è¦‹å•é¡Œ

### â“ å•é¡Œæ’æŸ¥

#### 1. ç«¯å£è¡çª

```bash
éŒ¯èª¤: Bind for 0.0.0.0:9999 failed: port is already allocated

è§£æ±ºæ–¹æ³•:
# 1. æŸ¥çœ‹ä½”ç”¨ç«¯å£çš„é€²ç¨‹
netstat -ano | findstr :9999  # Windows
lsof -i :9999                # Linux/Mac

# 2. ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£æ˜ å°„
ports:
  - "9998:9999"  # ä½¿ç”¨ 9998 ä»£æ›¿ 9999

# 3. æˆ–åœæ­¢ä½”ç”¨ç«¯å£çš„æœå‹™
```

#### 2. è³‡æ–™åº«é€£æ¥å¤±æ•—

```bash
éŒ¯èª¤: Error: Can't reach database server at `postgres:5432`

è§£æ±ºæ–¹æ³•:
# 1. æª¢æŸ¥ postgres å®¹å™¨ç‹€æ…‹
docker compose ps postgres

# 2. æŸ¥çœ‹ postgres æ—¥èªŒ
docker compose logs postgres

# 3. ç­‰å¾…è³‡æ–™åº«å®Œå…¨å•Ÿå‹•
docker compose up -d postgres
# ç­‰å¾… 10-20 ç§’å¾Œå†å•Ÿå‹• app
docker compose up -d app
```

#### 3. Prisma Client æœªç”Ÿæˆ

```bash
éŒ¯èª¤: Error: Prisma Client is not generated

è§£æ±ºæ–¹æ³•:
# 1. é€²å…¥ app å®¹å™¨
docker compose exec app sh

# 2. ç”Ÿæˆ Prisma Client
npx prisma generate

# 3. æ¨é€ schema
npx prisma db push

# 4. é‡å•Ÿå®¹å™¨
docker compose restart app
```

#### 4. å¥åº·æª¢æŸ¥å¤±æ•—

```bash
éŒ¯èª¤: Container health check failed

è§£æ±ºæ–¹æ³•:
# 1. æª¢æŸ¥æ‡‰ç”¨æ˜¯å¦æ­£ç¢ºå•Ÿå‹•
docker compose logs app

# 2. æ‰‹å‹•æ¸¬è©¦å¥åº·æª¢æŸ¥ç«¯é»
curl http://localhost:9999/api/health

# 3. å¦‚æœ /api/health ä¸å­˜åœ¨ï¼Œæ·»åŠ åˆ° API
```

### ğŸ“Š æ•ˆèƒ½å„ªåŒ–å»ºè­°

#### 1. æ˜ åƒå¤§å°å„ªåŒ–

```dockerfile
# ä½¿ç”¨ .dockerignore æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶
# å·²åœ¨ .dockerignore ä¸­é…ç½®

# åªå®‰è£ç”Ÿç”¢ä¾è³´ (éœ€è¦ä¿®æ”¹ Dockerfile)
RUN npm ci --only=production
```

#### 2. æ§‹å»ºé€Ÿåº¦å„ªåŒ–

```bash
# ä½¿ç”¨ BuildKit (æ›´å¿«)
export DOCKER_BUILDKIT=1
docker compose build

# æˆ–åœ¨ daemon.json ä¸­å•Ÿç”¨
# {"features": {"buildkit": true}}
```

#### 3. é‹è¡Œæ™‚æ•ˆèƒ½å„ªåŒ–

```yaml
# docker-compose.yml

# 1. é™åˆ¶è³‡æºä½¿ç”¨
app:
  deploy:
    resources:
      limits:
        cpus: '2.0'      # æœ€å¤š 2 å€‹ CPU æ ¸å¿ƒ
        memory: 2G      # æœ€å¤š 2GB è¨˜æ†¶é«”
      reservations:
        cpus: '0.5'      # ä¿ç•™ 0.5 å€‹ CPU æ ¸å¿ƒ
        memory: 512M    # ä¿ç•™ 512MB è¨˜æ†¶é«”

# 2. PostgreSQL æ•ˆèƒ½åƒæ•¸
postgres:
  command:
    - "-c shared_buffers=256MB"
    - "-c effective_cache_size=1GB"
    # ... (å·²é…ç½®)
```

### ğŸ”§ ç”Ÿç”¢ç’°å¢ƒå»ºè­°

1. **ä½¿ç”¨ .env.docker æ–‡ä»¶**
   ```bash
   # å‰µå»º .env.docker
   cp .env .env.docker
   # ç·¨è¼¯ .env.dockerï¼Œå¡«å…¥ç”Ÿç”¢ç’°å¢ƒè®Šæ•¸
   ```

2. **ä¿®æ”¹ docker-compose.yml**
   ```yaml
   env_file:
     - .env.docker
   ```

3. **å•Ÿç”¨ Nginx åå‘ä»£ç†**
   - å–æ¶ˆè¨»é‡‹ nginx æœå‹™
   - é…ç½® SSL è­‰æ›¸
   - è¨­ç½®åˆé©çš„ nginx.conf

4. **é…ç½®æ—¥èªŒè¼ªè½‰**
   - å·²é…ç½®: max-size: 10m, max-file: 3
   - è€ƒæ…®ä½¿ç”¨æ—¥èªŒæ”¶é›†æœå‹™ (å¦‚ ELK)

5. **è¨­ç½®è‡ªå‹•é‡å•Ÿ**
   - å·²é…ç½®: restart: unless-stopped
   - å¥åº·æª¢æŸ¥è‡ªå‹•é‡å•Ÿä¸å¥åº·å®¹å™¨

---

## ğŸ“‹ ç‰ˆæœ¬è³‡è¨Š

| ç‰ˆæœ¬ | æ—¥æœŸ | èªªæ˜ |
|------|------|------|
| v1.0.0 | 2025-01-25 | åˆå§‹ Docker ç›¤é» |

---

*æœ¬ Docker ç›¤é»æ–‡æª”ç”± JyæŠ€è¡“åœ˜éšŠç¶­è­·*
