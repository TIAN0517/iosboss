<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èªéŸ³åŠŸèƒ½è¨ºæ–·</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-bottom: 20px; }
    h2 { color: #667eea; margin-bottom: 15px; font-size: 20px; }
    .check-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    .check-item:last-child { border-bottom: none; }
    .status-icon {
      font-size: 24px;
      margin-right: 15px;
      min-width: 30px;
    }
    .check-content {
      flex: 1;
    }
    .check-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .check-detail {
      color: #666;
      font-size: 14px;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .warning { color: #f59e0b; }
    .button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    .button:hover { background: #5a67d8; }
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .log {
      background: #1e1e1e;
      color: #10b981;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>ğŸ” èªéŸ³åŠŸèƒ½è¨ºæ–·å·¥å…·</h1>
      <p>æª¢æ¸¬æ‚¨çš„ç€è¦½å™¨å’Œç³»çµ±æ˜¯å¦æ”¯æ´èªéŸ³åŠŸèƒ½</p>
    </div>

    <div class="card">
      <h2>ğŸ“‹ ç³»çµ±æª¢æ¸¬çµæœ</h2>
      <div id="results"></div>
    </div>

    <div class="card">
      <h2>ğŸ§ª æ¸¬è©¦æŒ‰éˆ•</h2>
      <button class="button" onclick="testSpeechRecognition()">
        ğŸ¤ æ¸¬è©¦èªéŸ³è­˜åˆ¥
      </button>
      <button class="button" onclick="testSpeechSynthesis()">
        ğŸ”Š æ¸¬è©¦èªéŸ³æ’­æ”¾
      </button>
      <button class="button" onclick="testAPI()">
        ğŸŒ æ¸¬è©¦ AI API
      </button>
    </div>

    <div class="card">
      <h2>ğŸ“ é‹è¡Œæ—¥èªŒ</h2>
      <div id="log" class="log">ç­‰å¾…æ¸¬è©¦...</div>
    </div>

    <div class="card">
      <h2>ğŸ”§ è§£æ±ºæ–¹æ¡ˆ</h2>
      <div id="solutions" style="line-height: 1.8;"></div>
    </div>
  </div>

  <script>
    const logDiv = document.getElementById('log');
    const resultsDiv = document.getElementById('results');
    const solutionsDiv = document.getElementById('solutions');

    function log(message) {
      const time = new Date().toLocaleTimeString();
      logDiv.textContent = `[${time}] ${message}\n` + logDiv.textContent;
      console.log(message);
    }

    function addCheck(status, title, detail) {
      const icons = {
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
      };
      const colors = {
        success: 'success',
        error: 'error',
        warning: 'warning',
        info: ''
      };

      const checkDiv = document.createElement('div');
      checkDiv.className = 'check-item';
      checkDiv.innerHTML = `
        <div class="status-icon ${colors[status]}">${icons[status]}</div>
        <div class="check-content">
          <div class="check-title">${title}</div>
          <div class="check-detail">${detail}</div>
        </div>
      `;
      resultsDiv.appendChild(checkDiv);
    }

    let checks = {
      speechRecognition: false,
      speechSynthesis: false,
      api: false,
      microphone: false
    };

    // é é¢åŠ è¼‰æ™‚è‡ªå‹•æª¢æ¸¬
    window.onload = async () => {
      log('=== é–‹å§‹è¨ºæ–· ===');

      // æª¢æŸ¥ 1: èªéŸ³åˆæˆ
      log('æª¢æŸ¥èªéŸ³åˆæˆæ”¯æ´...');
      if ('speechSynthesis' in window) {
        const voices = speechSynthesis.getVoices();
        log(`æ‰¾åˆ° ${voices.length} å€‹èªéŸ³`);
        const zhVoice = voices.find(v => v.lang.includes('zh'));
        if (zhVoice) {
          addCheck('success', 'èªéŸ³æ’­æ”¾', `æ”¯æ´ ${voices.length} å€‹èªéŸ³ï¼ŒåŒ…å«ä¸­æ–‡`);
          checks.speechSynthesis = true;
        } else {
          addCheck('warning', 'èªéŸ³æ’­æ”¾', `æ”¯æ´èªéŸ³åˆæˆä½†æ²’æœ‰ä¸­æ–‡èªéŸ³`);
          checks.speechSynthesis = true;
        }
      } else {
        addCheck('error', 'èªéŸ³æ’­æ”¾', 'ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆ');
      }

      // æª¢æŸ¥ 2: èªéŸ³è­˜åˆ¥
      log('æª¢æŸ¥èªéŸ³è­˜åˆ¥æ”¯æ´...');
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SpeechRecognition) {
        addCheck('success', 'èªéŸ³è­˜åˆ¥', 'ç€è¦½å™¨æ”¯æ´ Web Speech API');
        checks.speechRecognition = true;
      } else {
        addCheck('error', 'èªéŸ³è­˜åˆ¥', 'ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è­˜åˆ¥ï¼Œè«‹ä½¿ç”¨ Chrome æˆ– Edge');
      }

      // æª¢æŸ¥ 3: éº¥å…‹é¢¨æ¬Šé™
      log('æª¢æŸ¥éº¥å…‹é¢¨æ¬Šé™...');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(track => track.stop());
        addCheck('success', 'éº¥å…‹é¢¨', 'éº¥å…‹é¢¨æ¬Šé™å·²æˆäºˆ');
        checks.microphone = true;
        log('éº¥å…‹é¢¨æ¬Šé™æ­£å¸¸');
      } catch (error) {
        addCheck('error', 'éº¥å…‹é¢¨', `ç„¡æ³•è¨ªå•éº¥å…‹é¢¨: ${error.message}`);
        log(`éº¥å…‹é¢¨éŒ¯èª¤: ${error.message}`);
      }

      // æª¢æŸ¥ 4: API é€£æ¥
      log('æª¢æŸ¥ API é€£æ¥...');
      try {
        const response = await fetch('http://localhost:9999/api/health');
        if (response.ok) {
          addCheck('success', 'ç³»çµ± API', 'API æœå‹™æ­£å¸¸é‹è¡Œ');
          checks.api = true;
          log('API é€£æ¥æˆåŠŸ');
        } else {
          addCheck('warning', 'ç³»çµ± API', `API å›æ‡‰ ${response.status}`);
          log(`API éŒ¯èª¤: ${response.status}`);
        }
      } catch (error) {
        addCheck('error', 'ç³»çµ± API', `ç„¡æ³•é€£æ¥åˆ° API: ${error.message}`);
        log(`API éŒ¯èª¤: ${error.message}`);
      }

      // é¡¯ç¤ºè§£æ±ºæ–¹æ¡ˆ
      showSolutions();
    };

    function testSpeechRecognition() {
      log('=== æ¸¬è©¦èªéŸ³è­˜åˆ¥ ===');
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!SpeechRecognition) {
        alert('âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è­˜åˆ¥\n\nè«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨');
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = 'zh-TW';
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => {
        log('èªéŸ³è­˜åˆ¥å·²å•Ÿå‹•ï¼Œè«‹èªªè©±...');
        alert('ğŸ¤ è«‹èªªè©±ï¼ˆä¾‹å¦‚ï¼šä½ å¥½ï¼‰');
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        log(`è­˜åˆ¥çµæœ: "${transcript}"`);
        alert(`âœ… è­˜åˆ¥åˆ°: "${transcript}"`);
      };

      recognition.onerror = (event) => {
        log(`èªéŸ³è­˜åˆ¥éŒ¯èª¤: ${event.error}`);
        alert(`âŒ èªéŸ³è­˜åˆ¥å¤±æ•—: ${event.error}`);
      };

      recognition.onend = () => {
        log('èªéŸ³è­˜åˆ¥å·²çµæŸ');
      };

      recognition.start();
    }

    function testSpeechSynthesis() {
      log('=== æ¸¬è©¦èªéŸ³æ’­æ”¾ ===');

      if (!('speechSynthesis' in window)) {
        alert('âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆ');
        return;
      }

      log('æº–å‚™æ’­æ”¾æ¸¬è©¦èªéŸ³...');

      const utterance = new SpeechSynthesisUtterance('ä½ å¥½ï¼Œé€™æ˜¯ä¸€å€‹æ¸¬è©¦ã€‚');
      utterance.lang = 'zh-TW';
      utterance.rate = 1.0;
      utterance.volume = 1.0;

      utterance.onstart = () => {
        log('â–¶ï¸ æ­£åœ¨æ’­æ”¾èªéŸ³...');
        alert('ğŸ”Š æ­£åœ¨æ’­æ”¾èªéŸ³ï¼Œè«‹è½...');
      };

      utterance.onend = () => {
        log('âœ… èªéŸ³æ’­æ”¾å®Œæˆ');
        alert('âœ… æ¸¬è©¦å®Œæˆï¼æ‚¨è½åˆ°è²éŸ³äº†å—ï¼Ÿ');
      };

      utterance.onerror = (event) => {
        log(`âŒ èªéŸ³æ’­æ”¾éŒ¯èª¤: ${event.error}`);
        alert(`âŒ æ’­æ”¾å¤±æ•—: ${event.error}\n\nå¯èƒ½åŸå› ï¼š\n1. éŸ³é‡å¤ªå°\n2. ç€è¦½å™¨ä¸æ”¯æ´\n3. ç³»çµ±éŸ³æ•ˆè¨­å®šå•é¡Œ`);
      };

      speechSynthesis.speak(utterance);
    }

    async function testAPI() {
      log('=== æ¸¬è©¦ AI API ===');
      log('ç™¼é€è«‹æ±‚åˆ° API...');

      try {
        const response = await fetch('http://localhost:9999/api/ai/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: 'ä½ å¥½',
            conversationHistory: [],
            stream: false
          })
        });

        log(`API å›æ‡‰ç‹€æ…‹: ${response.status}`);

        if (response.ok) {
          const data = await response.json();
          log(`API å›æ‡‰: ${JSON.stringify(data)}`);
          alert(`âœ… API æ¸¬è©¦æˆåŠŸï¼\n\nAI å›æ‡‰: ${data.content || 'ç„¡å…§å®¹'}`);

          // æ’­æ”¾å›æ‡‰
          if (data.content) {
            log('æº–å‚™æ’­æ”¾ AI å›æ‡‰...');
            if ('speechSynthesis' in window) {
              const utterance = new SpeechSynthesisUtterance(data.content);
              utterance.lang = 'zh-TW';
              speechSynthesis.speak(utterance);
            }
          }
        } else {
          log(`API éŒ¯èª¤: ${response.status}`);
          alert(`âŒ API è«‹æ±‚å¤±æ•—\nç‹€æ…‹ç¢¼: ${response.status}`);
        }
      } catch (error) {
        log(`API éŒ¯èª¤: ${error.message}`);
        alert(`âŒ API é€£æ¥å¤±æ•—: ${error.message}`);
      }
    }

    function showSolutions() {
      let solutions = [];

      if (!checks.speechRecognition) {
        solutions.push('âŒ èªéŸ³è­˜åˆ¥ä¸æ”¯æ´<br>è«‹ä½¿ç”¨ <strong>Google Chrome</strong> æˆ– <strong>Microsoft Edge</strong> ç€è¦½å™¨');
      }

      if (!checks.speechSynthesis) {
        solutions.push('âŒ èªéŸ³æ’­æ”¾ä¸æ”¯æ´<br>è«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨');
      }

      if (!checks.microphone) {
        solutions.push('âŒ éº¥å…‹é¢¨æ¬Šé™æœªæˆäºˆ<br>è«‹å…è¨±ç€è¦½å™¨ä½¿ç”¨éº¥å…‹é¢¨');
      }

      if (!checks.api) {
        solutions.push('âŒ ç³»çµ± API æœªé‹è¡Œ<br>è«‹ç¢ºä¿ http://localhost:9999 æ­£åœ¨é‹è¡Œ');
      }

      if (checks.speechRecognition && checks.speechSynthesis && checks.microphone && checks.api) {
        solutions.push('âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼<br>æ‚¨å¯ä»¥æ­£å¸¸ä½¿ç”¨èªéŸ³åŠ©æ‰‹');
      }

      solutionsDiv.innerHTML = solutions.join('<br><br>');
    }
  </script>
</body>
</html>
