# Supabase 安全配置指南

## 📋 當前頁面：攻擊防護 (Attack Protection)

您現在在 **攻擊防護** 頁面，這裡有兩個重要的安全設置需要配置。

---

## 🔐 安全設置說明

### 1. 啟用驗證碼保護 (Enable CAPTCHA protection)

**當前狀態**：❌ 已停用

**作用**：
- 保護身份驗證端點免受機器人和濫用行為的侵害
- 防止自動化攻擊（如暴力破解、批量註冊等）
- 提高登入和註冊的安全性

**建議**：
- ✅ **生產環境建議開啟**
- ⚠️ **開發環境可以關閉**（方便測試）

**配置步驟**：
1. 將「啟用驗證碼保護」開關切換為「開啟」
2. 點擊「配置電子郵件提供者」按鈕
3. 選擇驗證碼提供商（如 reCAPTCHA、hCaptcha 等）
4. 輸入提供商提供的 API 密鑰
5. 點擊「儲存變更」

**注意事項**：
- 需要先配置電子郵件提供者才能啟用驗證碼
- 驗證碼會增加用戶登入步驟，但提高安全性
- 可以選擇「僅在可疑活動時顯示驗證碼」以減少用戶干擾

---

### 2. 防止使用外洩的密碼 (Prevent use of leaked passwords)

**當前狀態**：❌ 已停用

**作用**：
- 註冊或更改密碼時，不允許使用已知或容易猜測的密碼
- 檢查密碼是否在已知的數據洩露列表中
- 防止用戶使用弱密碼或已被洩露的密碼

**建議**：
- ✅ **強烈建議開啟**（無論開發或生產環境）
- 這是一個被動保護，不會影響正常用戶體驗
- 可以顯著提高系統安全性

**配置步驟**：
1. 將「防止使用外洩的密碼」開關切換為「開啟」
2. 點擊「儲存變更」

**注意事項**：
- 此功能使用 Supabase 內建的密碼洩露數據庫
- 不會向第三方發送用戶密碼
- 僅在註冊和更改密碼時檢查，不影響現有用戶

---

## ✅ 推薦配置

### 開發環境配置

| 設置 | 狀態 | 說明 |
|------|------|------|
| 啟用驗證碼保護 | ❌ 關閉 | 開發時可以關閉，方便測試 |
| 防止使用外洩的密碼 | ✅ 開啟 | 建議開啟，提高安全性 |

### 生產環境配置

| 設置 | 狀態 | 說明 |
|------|------|------|
| 啟用驗證碼保護 | ✅ 開啟 | 必須開啟，防止機器人攻擊 |
| 防止使用外洩的密碼 | ✅ 開啟 | 必須開啟，防止弱密碼 |

---

## 🔧 其他重要配置項目

除了「攻擊防護」頁面，您還需要配置以下項目：

### 1. Row Level Security (RLS) 策略

**位置**：Database → Tables → 選擇表 → Policies

**作用**：
- 控制誰可以訪問哪些數據
- 防止未授權訪問
- 實現細粒度的數據權限控制

**需要配置的表**：
- ✅ `User` - 用戶表
- ✅ `Customer` - 客戶表
- ✅ `GasOrder` - 訂單表
- ✅ `Product` - 產品表
- ✅ `Inventory` - 庫存表
- ✅ 其他業務表

**配置指南**：請參考 `backups/migration/COMPLETE_MIGRATION_REPORT.md` 中的 RLS 策略示例

---

### 2. API 密鑰管理

**位置**：Settings → API

**當前狀態**：
- ✅ Anon Key：已配置
- ✅ Service Role Key：已配置
- ✅ Publishable Key：已配置

**建議操作**：
- 定期輪換 API 密鑰
- 不要在前端代碼中暴露 Service Role Key
- 使用環境變量管理密鑰

---

### 3. 電子郵件配置

**位置**：Authentication → Providers → Email

**作用**：
- 配置電子郵件發送服務（用於驗證碼、密碼重置等）
- 支持自定義 SMTP 服務器或使用 Supabase 默認服務

**需要配置的項目**：
- SMTP 服務器地址
- SMTP 端口
- 用戶名和密碼
- 發送者電子郵件地址

**注意事項**：
- 如果使用驗證碼保護，必須先配置電子郵件提供者
- 可以使用 Supabase 默認的電子郵件服務（有限制）
- 生產環境建議使用自定義 SMTP（如 SendGrid、Mailgun 等）

---

### 4. 數據庫連接池配置

**位置**：Settings → Database → Connection Pooling

**作用**：
- 優化數據庫連接性能
- 防止連接數過多導致數據庫崩潰
- 提高應用程序響應速度

**建議配置**：
- 連接池模式：Transaction（推薦）
- 最大連接數：根據應用需求設置（默認 100）
- 連接超時：30 秒

---

### 5. 備份配置

**位置**：Settings → Database → Backups

**作用**：
- 自動備份數據庫
- 防止數據丟失
- 支持時間點恢復

**建議配置**：
- ✅ 啟用自動備份
- 備份頻率：每日（生產環境）
- 保留時間：7-30 天（根據需求）

---

### 6. 日誌和監控

**位置**：Logs → 各種日誌類型

**作用**：
- 監控 API 請求
- 追蹤錯誤和異常
- 分析系統性能

**建議操作**：
- 定期查看 API 日誌
- 設置錯誤警報
- 監控數據庫查詢性能

---

## 📝 配置檢查清單

### 必須配置（生產環境）

- [ ] **Row Level Security (RLS)**：為所有表配置 RLS 策略
- [ ] **防止使用外洩的密碼**：開啟此功能
- [ ] **啟用驗證碼保護**：開啟並配置電子郵件提供者
- [ ] **電子郵件配置**：配置 SMTP 服務器
- [ ] **備份配置**：啟用自動備份
- [ ] **API 密鑰管理**：確認密鑰安全存儲

### 建議配置（可選）

- [ ] **連接池配置**：優化數據庫連接
- [ ] **日誌監控**：設置錯誤警報
- [ ] **自定義域名**：配置自定義 API 域名
- [ ] **Webhook 配置**：設置數據變更通知

---

## 🚀 快速配置步驟

### 步驟 1：配置攻擊防護

1. 在當前頁面（攻擊防護），將「防止使用外洩的密碼」開關切換為「開啟」
2. （可選）將「啟用驗證碼保護」開關切換為「開啟」（需要先配置電子郵件）
3. 點擊「儲存變更」按鈕

### 步驟 2：配置電子郵件（如果需要驗證碼）

1. 點擊「配置電子郵件提供者」按鈕
2. 選擇電子郵件提供商（Supabase 默認或自定義 SMTP）
3. 輸入必要的配置信息
4. 測試電子郵件發送
5. 保存配置

### 步驟 3：配置 RLS 策略

1. 導航到：Database → Tables
2. 選擇需要保護的表（如 `User`、`Customer` 等）
3. 點擊「Policies」標籤
4. 創建適當的 RLS 策略
5. 測試策略是否正常工作

### 步驟 4：配置備份

1. 導航到：Settings → Database → Backups
2. 啟用自動備份
3. 設置備份頻率和保留時間
4. 保存配置

---

## ⚠️ 重要提醒

### 安全性優先級

1. **最高優先級**：
   - ✅ 配置 RLS 策略（防止未授權訪問）
   - ✅ 防止使用外洩的密碼（防止弱密碼）

2. **高優先級**：
   - ✅ 啟用驗證碼保護（防止機器人攻擊）
   - ✅ 配置電子郵件提供者（支持驗證碼）

3. **中優先級**：
   - ✅ 配置備份（防止數據丟失）
   - ✅ 監控日誌（及時發現問題）

### 開發 vs 生產環境

- **開發環境**：可以簡化配置，重點測試功能
- **生產環境**：必須配置所有安全設置，確保系統安全

---

## 📞 需要幫助？

如果在配置過程中遇到問題：

1. **查看 Supabase 文檔**：
   - 攻擊防護：https://supabase.com/docs/guides/auth/auth-captcha
   - RLS 策略：https://supabase.com/docs/guides/auth/row-level-security
   - 電子郵件配置：https://supabase.com/docs/guides/auth/auth-smtp

2. **查看項目文檔**：
   - 完整遷移報告：`backups/migration/COMPLETE_MIGRATION_REPORT.md`
   - Supabase 配置指南：`docs/SUPABASE_CONFIGURATION_GUIDE.md`

3. **Supabase Dashboard**：
   - 訪問：https://supabase.com/dashboard/project/mdmltksbpdyndoisnqhy
   - 查看日誌和錯誤信息

---

**配置完成日期**：2025-12-29  
**當前狀態**：待配置
