# 九九瓦斯行管理系統 - 持久性監控系統
## 使用指南

---

## 📋 系統概述

本系統包含完整的**服務監控和自動恢復機制**，確保您的應用**7x24 持久運行**。

### 組件

| 組件 | 文件 | 功能 |
|------|------|------|
| 監控守護進程 | `monitor-services.ps1` | 持續監控服務狀態 |
| 一鍵啟動 | `start-with-monitor.bat` | 啟動所有服務 + 監控 |
| 任務計劃器 | `install-scheduled-task.ps1` | 開機/登錄自動啟動 |
| 診斷修復 | `diagnose-fix.ps1` | 快速診斷和修復問題 |

---

## 🚀 快速開始

### 方式 1：手動啟動（推薦用於開發）

```powershell
# 雙擊運行
.\start-with-monitor.bat

# 或命令行
cd "C:\Users\tian7\OneDrive\Desktop\媽媽ios"
.\start-with-monitor.bat
```

**過程：**
1. ✅ 檢查 Docker 狀態
2. ✅ 啟動所有 Docker 服務（4 個容器）
3. ✅ 等待服務就緒（30 秒）
4. ✅ 檢查服務健康狀態
5. ✅ 啟動監控守護進程（持續運行）

### 方式 2：設置開機自動啟動（推薦用於生產）

**步驟 1：安裝 Windows 任務計劃器**

```powershell
# 右鍵單擊並選擇「以管理員身份運行」
.\install-scheduled-task.ps1
```

**這會設置：**
- ✅ 開機時自動啟動（延遲 2 分鐘）
- ✅ 用戶登錄時自動啟動（延遲 30 秒）
- ✅ 失敗後自動重試（每 5 分鐘，最多 3 次）

**步驟 2：驗證安裝**

```powershell
# 查看任務
taskschd.msc

# 或命令行
schtasks /query /tn "JYT-Gas-Services-Monitor"
```

**步驟 3：手動觸發任務（測試）**

```powershell
schtasks /run /tn "JYT-Gas-Services-Monitor"
```

---

## 🔧 日常管理

### 診斷問題

```powershell
# 基本診斷
.\diagnose-fix.ps1

# 診斷並自動修復
.\diagnose-fix.ps1 -AutoFix

# 僅檢查，不修復
.\diagnose-fix.ps1 -OnlyCheck
```

**診斷內容：**
1. Docker 運行狀態
2. 所有容器狀態（4 個服務）
3. Webhook 連接測試
4. Cloudflare Tunnel 連接狀態
5. 端口監聽檢查
6. 自動修復建議

### 重啟所有服務

```powershell
# 使用監控模式
.\start-with-monitor.bat

# 或簡單重啟
.\restart.bat
```

### 停止監控守護進程

在 `start-with-monitor.bat` 運行的窗口中：
- 按 `Ctrl + C` 停止監控（服務會繼續運行）
- 關閉窗口會停止監控

**注意：** 關閉監控不會停止 Docker 服務。

---

## 📊 監控功能詳解

### 自動重啟機制

監控守護進程會：

1. **每 30 秒檢查一次**所有容器狀態
2. **自動檢測停止的容器**
3. **自動重啟停止的服務**
4. **等待健康檢查通過**
5. **記錄所有操作到日誌**

### 監控的服務

| 容器名稱 | 服務 | 端口 |
|-----------|------|------|
| jyt-gas-app | Next.js 應用 | 9999 |
| jyt-gas-nginx | Nginx 反向代理 | 80 (內部) |
| jyt-gas-postgres | PostgreSQL 資料庫 | 5433 (外部) |
| jyt-gas-cloudflared | Cloudflare Tunnel | - |

### 自動修復場景

| 問題 | 自動處理 | 日誌記錄 |
|------|----------|----------|
| Docker 未運行 | 啟動 Docker Desktop | ✅ |
| 容器意外停止 | 重啟容器 | ✅ |
| 服務不健康 | 等待恢復或重啟 | ✅ |
| 網絡連接失敗 | 檢測並報告 | ✅ |

---

## 📝 日誌管理

### 日誌位置

```
logs\
├── monitor.log           # 監控守護進程日誌
├── docker-compose.log    # Docker Compose 日誌
└── [其他服務日誌]
```

### 自動清理

- **保留時間：** 7 天
- **清理頻率：** 每天凌晨 3 點自動清理
- **清理內容：** 所有超過 7 天的日誌文件

### 手動清理

```powershell
# 清理所有舊日誌
Remove-Item logs\*.log -Force -ErrorAction SilentlyContinue
```

---

## 🔍 故障排除

### 常見問題

#### 1. 監控守護進程無法啟動

**症狀：**
- PowerShell 運行腳本立即退出
- 錯誤訊息：「無法執行腳本」

**解決方案：**
```powershell
# 允許腳本執行
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# 或臨時允許
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process
```

#### 2. Docker 容器無法啟動

**症狀：**
- `docker compose up -d` 後容器立即退出
- `docker ps` 顯示無容器運行

**解決方案：**
```powershell
# 查看詳細日誌
docker compose logs --tail 100

# 診斷具體問題
.\diagnose-fix.ps1

# 重建容器
docker compose down
docker compose up -d
```

#### 3. Windows 任務計劃器失敗

**症狀：**
- 開機後沒有自動啟動
- 任務計劃器顯示「失敗」

**解決方案：**
```powershell
# 卸載任務
.\install-scheduled-task.ps1 -Uninstall

# 重新安裝（管理員權限）
# 右鍵 -> 以管理員身份運行
.\install-scheduled-task.ps1
```

#### 4. 監控進程佔用大量 CPU

**症狀：**
- PowerShell 窗口高 CPU 使用
- 系統變慢

**解決方案：**
- 調整檢查間隔（默認 30 秒）
- 增加檢查間隔到 60 秒：

```powershell
# 修改 monitor-services.ps1 第 11 行
# $CheckInterval = 30  改為
$CheckInterval = 60
```

#### 5. 服務不斷重啟循環

**症狀：**
- 容器每隔幾分鐘自動重啟
- 日誌顯示重啟循環

**可能原因：**
1. 容器健康檢查失敗
2. 資源不足（記憶體/CPU）
3. 配置錯誤

**解決方案：**
```powershell
# 查看容器健康狀態
docker inspect jyt-gas-app --format '{{.State.Health}}'

# 查看詳細錯誤
docker logs jyt-gas-app --tail 50

# 檢查系統資源
tasklist | findstr "node postgres"
```

---

## 📋 管理命令速查

### Docker 命令

```powershell
# 查看所有容器狀態
docker compose ps

# 查看實時日誌
docker compose logs -f

# 查看特定服務日誌
docker logs jyt-gas-app --tail 100

# 重啟所有服務
docker compose restart

# 重啟特定服務
docker restart jyt-gas-app

# 停止所有服務
docker compose down

# 完全清理（包括數據卷）
docker compose down -v
```

### 監控命令

```powershell
# 啟動監控守護進程
powershell -NoProfile -ExecutionPolicy Bypass -File monitor-services.ps1

# 單次檢查（不持續運行）
powershell -NoProfile -ExecutionPolicy Bypass -File monitor-services.ps1 -OneTime

# 診斷系統
.\diagnose-fix.ps1

# 自動修復
.\diagnose-fix.ps1 -AutoFix
```

### 任務計劃器命令

```powershell
# 安裝任務
.\install-scheduled-task.ps1

# 卸載任務
.\install-scheduled-task.ps1 -Uninstall

# 手動運行任務
schtasks /run /tn "JYT-Gas-Services-Monitor"

# 查看任務狀態
schtasks /query /tn "JYT-Gas-Services-Monitor" /fo LIST

# 查看所有任務
taskschd.msc
```

---

## 🔒 安全建議

### 1. 定期備份

```powershell
# 備份 PostgreSQL
docker exec jyt-gas-postgres pg_dump -U postgres gas_management > backup_$(Get-Date -Format 'yyyyMMdd').sql

# 備份數據卷
docker run --rm -v jyt-gas-postgres-data:/data -v (Get-Location):/backup alpine tar czf /backup/postgres_data_$(Get-Date -Format 'yyyyMMdd').tar.gz -C /data .
```

### 2. 監控日誌大小

```powershell
# 檢查日誌文件大小
Get-ChildItem logs\*.log | Select-Object Name, Length, LastWriteTime | Format-Table

# 清理大於 100MB 的日誌
Get-ChildItem logs\*.log | Where-Object { $_.Length -gt 100MB } | Remove-Item
```

### 3. 定期更新

```powershell
# 更新 Docker 鏡像
docker compose pull

# 重建並重啟
docker compose up -d --build
```

---

## 📞 技術支援

### 系統信息

```powershell
# 查看 Docker 版本
docker --version
docker-compose --version

# 查看 PowerShell 版本
$PSVersionTable

# 查看系統信息
systeminfo
```

### 收集診斷信息

```powershell
# 運行完整診斷
.\diagnose-fix.ps1 > diagnostic_report.txt

# 收集日誌
docker compose logs > docker_logs.txt

# 收集容器狀態
docker ps -a > container_status.txt
```

---

## ✅ 檢查清單

### 部署檢查清單

- [ ] Docker Desktop 已安裝並運行
- [ ] 所有環境變量已配置（.env.docker）
- [ ] Cloudflare Tunnel Token 已設置
- [ ] LINE Bot Token 已設置
- [ ] PostgreSQL 資料庫密碼已設置
- [ ] 監控腳本權限已設置
- [ ] Windows 任務計劃器已安裝（生產環境）
- [ ] 首次啟動已測試成功
- [ ] Webhook 已驗證（200 OK）
- [ ] 日誌目錄已創建

### 運行維護檢查清單

- [ ] 每週檢查監控日誌
- [ ] 每月清理舊日誌
- [ ] 每月備份資料庫
- [ ] 每季度更新 Docker 鏡像
- [ ] 每半年審查安全配置
- [ ] 定期測試自動重啟功能

---

## 📚 相關文檔

- `README.md` - 專案概述
- `docker-compose.yml` - Docker 服務配置
- `521錯誤最終解決.md` - LINE Webhook 錯誤解決
- `CLOUDFLARE_TUNNEL_SETUP.md` - Cloudflare Tunnel 設置
- `SYSTEM_MANUAL.md` - 系統使用手冊

---

## 📈 版本歷史

| 版本 | 日期 | 變更 |
|------|------|------|
| 1.0 | 2025-12-29 | 初始版本 - 基本監控和重啟 |
| 1.1 | 2025-12-29 | 添加 Windows 任務計劃器支持 |
| 1.2 | 2025-12-29 | 改進日誌管理和自動清理 |
| 1.3 | 2025-12-29 | 添加診斷和自動修復功能 |

---

**維護者：** Jy技術團隊
**最後更新：** 2025-12-29
**專案：** 九九瓦斯行管理系統
