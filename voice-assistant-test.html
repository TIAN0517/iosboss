<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èªéŸ³åŠ©æ‰‹æ¸¬è©¦</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #1e1e2e 0%, #2d1b4e 50%, #1e1e2e 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      text-align: center;
      max-width: 500px;
      width: 100%;
    }
    h1 {
      color: white;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: rgba(255,255,255,0.7);
      margin-bottom: 40px;
    }
    .mic-button {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      border: none;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0 auto 30px;
      box-shadow: 0 8px 32px rgba(245, 87, 108, 0.4);
      transition: all 0.3s;
      animation: pulse 2s infinite;
    }
    .mic-button:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 40px rgba(245, 87, 108, 0.6);
    }
    .mic-button:active {
      transform: scale(0.95);
    }
    .mic-button.recording {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      animation: recording 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 8px 32px rgba(245, 87, 108, 0.4); }
      50% { box-shadow: 0 8px 48px rgba(245, 87, 108, 0.8); }
    }
    @keyframes recording {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .mic-icon {
      width: 60px;
      height: 60px;
      fill: white;
      margin-bottom: 5px;
    }
    .mic-text {
      color: white;
      font-size: 16px;
      font-weight: bold;
    }
    .status {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 16px;
      color: white;
      margin-bottom: 20px;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .response {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      padding: 25px;
      border-radius: 16px;
      color: white;
      margin-bottom: 20px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .quick-btn {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    .quick-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }
    .speaking-indicator {
      display: none;
      color: #10b981;
      font-weight: bold;
      margin-top: 10px;
    }
    .speaking-indicator.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¤ èªéŸ³åŠ©æ‰‹æ¸¬è©¦</h1>
    <p class="subtitle">åƒè±†åŒ…ä¸€æ¨£çš„èªéŸ³å°è©±</p>

    <div id="status" class="status">
      é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹èªªè©±
    </div>

    <button id="micButton" class="mic-button" onclick="toggleRecording()">
      <svg class="mic-icon" viewBox="0 0 24 24">
        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
      </svg>
      <span class="mic-text" id="micText">é»æ“Šèªªè©±</span>
    </button>

    <div class="speaking-indicator" id="speakingIndicator">
      ğŸ”Š æ­£åœ¨æ’­æ”¾èªéŸ³...
    </div>

    <div id="response" class="response" style="display: none;">
      AI å›æ‡‰æœƒé¡¯ç¤ºåœ¨é€™è£¡
    </div>

    <div class="buttons">
      <button class="quick-btn" onclick="testQuick('ä½ å¥½')">ğŸ‘‹ ä½ å¥½</button>
      <button class="quick-btn" onclick="testQuick('ä»Šå¤©è³ºäº†å¤šå°‘')">ğŸ’° ä»Šå¤©è³ºäº†å¤šå°‘</button>
      <button class="quick-btn" onclick="testQuick('åº«å­˜é‚„æœ‰æ²’æœ‰')">ğŸ“¦ åº«å­˜æŸ¥è©¢</button>
    </div>

    <div style="margin-top: 30px;">
      <button class="quick-btn" onclick="window.location.href='http://localhost:9999'">
        ğŸ  å›åˆ°ä¸»ç³»çµ±
      </button>
    </div>
  </div>

  <script>
    let isRecording = false;
    let recognition = null;

    function toggleRecording() {
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    }

    function startRecording() {
      const statusDiv = document.getElementById('status');
      const micButton = document.getElementById('micButton');
      const micText = document.getElementById('micText');

      // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!SpeechRecognition) {
        statusDiv.textContent = 'âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è­˜åˆ¥';
        return;
      }

      recognition = new SpeechRecognition();
      recognition.lang = 'zh-TW';
      recognition.continuous = false;
      recognition.interimResults = true;

      recognition.onstart = () => {
        isRecording = true;
        micButton.classList.add('recording');
        micText.textContent = 'åœæ­¢';
        statusDiv.textContent = 'ğŸ§ æ­£åœ¨è†è½...';
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        statusDiv.textContent = 'ğŸ—£ï¸ ' + transcript;

        if (event.results[0].isFinal) {
          processInput(transcript);
        }
      };

      recognition.onerror = (event) => {
        console.error('Speech error:', event.error);
        statusDiv.textContent = 'âŒ èªéŸ³è­˜åˆ¥å¤±æ•—: ' + event.error;
        stopRecording();
      };

      recognition.onend = () => {
        stopRecording();
      };

      recognition.start();
    }

    function stopRecording() {
      isRecording = false;
      const micButton = document.getElementById('micButton');
      const micText = document.getElementById('micText');

      micButton.classList.remove('recording');
      micText.textContent = 'é»æ“Šèªªè©±';

      if (recognition) {
        recognition.stop();
      }
    }

    async function processInput(text) {
      const statusDiv = document.getElementById('status');
      const responseDiv = document.getElementById('response');

      statusDiv.textContent = 'â³ æ­£åœ¨æ€è€ƒ...';
      responseDiv.style.display = 'none';

      try {
        const response = await fetch('http://localhost:9999/api/ai/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: text,
            conversationHistory: [],
            stream: false
          })
        });

        if (response.ok) {
          const data = await response.json();
          const aiResponse = data.content || 'è™•ç†å®Œæˆ';

          statusDiv.textContent = 'âœ… å®Œæˆ';
          responseDiv.textContent = aiResponse;
          responseDiv.style.display = 'flex';

          // æ’­æ”¾èªéŸ³
          speakText(aiResponse);
        } else {
          statusDiv.textContent = 'âŒ æŸ¥è©¢å¤±æ•—';
        }
      } catch (error) {
        console.error('Error:', error);
        statusDiv.textContent = 'âŒ ç™¼ç”ŸéŒ¯èª¤';
      }
    }

    function speakText(text) {
      if (!('speechSynthesis' in window)) {
        console.log('Browser does not support speech synthesis');
        return;
      }

      // åœæ­¢ä¹‹å‰çš„èªéŸ³
      speechSynthesis.cancel();

      const utterance = new SpeechSynthesisUtterance(text);

      // è¨­ç½®èªéŸ³åƒæ•¸ - æ›´è‡ªç„¶çš„èªèª¿
      utterance.lang = 'zh-TW';
      utterance.rate = 1.0;  // æ­£å¸¸èªé€Ÿ
      utterance.pitch = 1.0;  // æ­£å¸¸éŸ³èª¿
      utterance.volume = 1.0; // æœ€å¤§éŸ³é‡

      // å˜—è©¦é¸æ“‡æœ€å¥½çš„èªéŸ³
      const voices = speechSynthesis.getVoices();
      console.log('å¯ç”¨èªéŸ³:', voices.length);

      // å„ªå…ˆé¸æ“‡å°ç£èªéŸ³
      const taiwanVoice = voices.find(v =>
        v.lang.includes('zh-TW') && (v.name.includes('Google') || v.name.includes('Microsoft'))
      );

      if (taiwanVoice) {
        utterance.voice = taiwanVoice;
        console.log('ä½¿ç”¨èªéŸ³:', taiwanVoice.name);
      }

      utterance.onstart = () => {
        document.getElementById('speakingIndicator').classList.add('active');
      };

      utterance.onend = () => {
        document.getElementById('speakingIndicator').classList.remove('active');
      };

      utterance.onerror = (e) => {
        console.error('TTS error:', e);
        document.getElementById('speakingIndicator').classList.remove('active');
      };

      speechSynthesis.speak(utterance);
    }

    function testQuick(text) {
      document.getElementById('status').textContent = 'ğŸ“ ' + text;
      processInput(text);
    }

    // è¼‰å…¥èªéŸ³åˆ—è¡¨ï¼ˆæœ‰äº›ç€è¦½å™¨éœ€è¦ï¼‰
    if ('speechSynthesis' in window) {
      speechSynthesis.getVoices();
      speechSynthesis.onvoiceschanged = () => {
        console.log('èªéŸ³åˆ—è¡¨å·²æ›´æ–°');
      };
    }
  </script>
</body>
</html>
