# ğŸ”§ 521 éŒ¯èª¤æ•…éšœæ’é™¤æŒ‡å—

## âœ… å·²å®Œæˆçš„ä¿®å¾©

1. âœ… **Nginx é…ç½®å·²ä¿®å¾©**
   - å·²æ·»åŠ  `linebot.jytian.it.com` åˆ° `server_name`
   - Nginx é…ç½®èªæ³•æ­£ç¢º
   - Nginx æœå‹™å·²é‡å•Ÿ

2. âœ… **Tunnel é€£æ¥æ­£å¸¸**
   - 4 å€‹é€£æ¥é»å·²è¨»å†Š
   - é…ç½®å·²æ›´æ–°ï¼š`linebot.jytian.it.com` â†’ `http://nginx:80`

3. âœ… **æ‰€æœ‰æœå‹™é‹è¡Œæ­£å¸¸**
   - Appï¼šå¥åº·
   - Nginxï¼šå¥åº·
   - PostgreSQLï¼šå¥åº·
   - Cloudflare Tunnelï¼šé‹è¡Œä¸­

## ğŸ” 521 éŒ¯èª¤çš„å¯èƒ½åŸå› 

### 1. Cloudflare è·¯ç”±æ›´æ–°éœ€è¦æ™‚é–“ï¼ˆæœ€å¯èƒ½ï¼‰

Cloudflare éœ€è¦ 5-15 åˆ†é˜ä¾†å®Œå…¨æ›´æ–°è·¯ç”±é…ç½®ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼šç­‰å¾… 10-15 åˆ†é˜å¾Œå†æ¸¬è©¦ã€‚

### 2. Cloudflare Dashboard ä¸­çš„é…ç½®å•é¡Œ

éœ€è¦æª¢æŸ¥ Cloudflare Dashboard ä¸­çš„ Public Hostname é…ç½®ã€‚

**æª¢æŸ¥æ­¥é©Ÿ**ï¼š
1. è¨ªå•ï¼šhttps://one.dash.cloudflare.com/
2. é€²å…¥ **Zero Trust** â†’ **Access** â†’ **Tunnels**
3. é»æ“Š **`jyt-gas-tunnel`**
4. é»æ“Š **Configure** æ¨™ç±¤
5. æª¢æŸ¥ **Public Hostname** é…ç½®ï¼š
   - **Subdomain**: `linebot`
   - **Domain**: `jytian.it.com`
   - **Service Type**: HTTP
   - **Service URL**: `http://nginx:80` âš ï¸ **é‡è¦ï¼šå¿…é ˆæ˜¯ `nginx:80`ï¼Œä¸æ˜¯ `app:9999`**

### 3. DNS å‚³æ’­å•é¡Œ

**æª¢æŸ¥ DNS**ï¼š
```powershell
nslookup linebot.jytian.it.com
```

æ‡‰è©²è¿”å› Cloudflare çš„ IP åœ°å€ã€‚

### 4. Cloudflare ä»£ç†ç‹€æ…‹

åœ¨ Cloudflare Dashboard ä¸­æª¢æŸ¥ï¼š
1. é€²å…¥ **DNS** è¨­ç½®
2. æ‰¾åˆ° `linebot.jytian.it.com` çš„è¨˜éŒ„
3. ç¢ºèª **ä»£ç†ç‹€æ…‹** æ˜¯ **å·²ä»£ç†**ï¼ˆæ©™è‰²é›²æœµï¼‰âœ…

## ğŸ› ï¸ æ•…éšœæ’é™¤æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šæª¢æŸ¥ Cloudflare Dashboard é…ç½®

1. è¨ªå•ï¼šhttps://one.dash.cloudflare.com/access/tunnels
2. é»æ“Š **`jyt-gas-tunnel`**
3. é»æ“Š **Configure** â†’ **Public Hostname**
4. ç¢ºèªé…ç½®ï¼š
   - Hostname: `linebot.jytian.it.com`
   - Service: `http://nginx:80`

**å¦‚æœ Service URL ä¸æ˜¯ `http://nginx:80`ï¼Œè«‹ä¿®æ”¹ç‚º `http://nginx:80`**

### æ­¥é©Ÿ 2ï¼šæª¢æŸ¥ DNS è¨­ç½®

1. è¨ªå•ï¼šhttps://dash.cloudflare.com/
2. é¸æ“‡åŸŸåï¼š`jytian.it.com`
3. é€²å…¥ **DNS** è¨­ç½®
4. ç¢ºèªæœ‰ `linebot` çš„ A è¨˜éŒ„æˆ– CNAME è¨˜éŒ„
5. ç¢ºèªä»£ç†ç‹€æ…‹æ˜¯ **å·²ä»£ç†**ï¼ˆæ©™è‰²é›²æœµï¼‰

### æ­¥é©Ÿ 3ï¼šé‡å•Ÿ Tunnel

```powershell
docker compose restart cloudflared
docker compose logs cloudflared --tail 20
```

### æ­¥é©Ÿ 4ï¼šç­‰å¾…ä¸¦é‡è©¦

ç­‰å¾… 10-15 åˆ†é˜ï¼Œç„¶å¾Œæ¸¬è©¦ï¼š

```powershell
curl https://linebot.jytian.it.com/api/webhook/line
```

### æ­¥é©Ÿ 5ï¼šæª¢æŸ¥æœ¬åœ°æœå‹™

ç¢ºèªæœ¬åœ°æœå‹™æ­£å¸¸ï¼š

```powershell
# æ¸¬è©¦æœ¬åœ°
curl http://localhost:9999/api/webhook/line

# æ¸¬è©¦ Nginx
docker compose exec nginx curl http://app:9999/api/webhook/line
```

## ğŸ“‹ æª¢æŸ¥æ¸…å–®

- [ ] Nginx é…ç½®å·²æ›´æ–°ï¼ˆåŒ…å« `linebot.jytian.it.com`ï¼‰
- [ ] Nginx æœå‹™å·²é‡å•Ÿ
- [ ] Tunnel é€£æ¥å·²è¨»å†Šï¼ˆ4 å€‹é€£æ¥é»ï¼‰
- [ ] Cloudflare Dashboard ä¸­ Public Hostname é…ç½®æ­£ç¢º
- [ ] Service URL æ˜¯ `http://nginx:80`
- [ ] DNS è¨˜éŒ„å­˜åœ¨ä¸”å·²ä»£ç†
- [ ] ç­‰å¾… 10-15 åˆ†é˜è®“ Cloudflare æ›´æ–°

## ğŸ¯ æœ€å¯èƒ½çš„åŸå› 

æ ¹æ“šç•¶å‰ç‹€æ…‹ï¼Œæœ€å¯èƒ½çš„åŸå› æ˜¯ï¼š

1. **Cloudflare è·¯ç”±æ›´æ–°éœ€è¦æ™‚é–“**ï¼ˆ5-15 åˆ†é˜ï¼‰
2. **Cloudflare Dashboard ä¸­çš„ Service URL é…ç½®ä¸æ­£ç¢º**

**å»ºè­°æ“ä½œ**ï¼š
1. æª¢æŸ¥ Cloudflare Dashboard ä¸­çš„ Public Hostname é…ç½®
2. ç¢ºèª Service URL æ˜¯ `http://nginx:80`
3. ç­‰å¾… 10-15 åˆ†é˜
4. å†æ¬¡æ¸¬è©¦

## âœ… æˆåŠŸæ¨™èªŒ

ç•¶ä»¥ä¸‹æ¢ä»¶éƒ½æ»¿è¶³æ™‚ï¼Œé…ç½®å°±æˆåŠŸäº†ï¼š

- âœ… å¤–ç¶²è¨ªå•è¿”å› JSON éŸ¿æ‡‰ï¼ˆä¸æ˜¯ 521ï¼‰
- âœ… LINE Developers Console é©—è­‰æˆåŠŸ
- âœ… Tunnel æ—¥èªŒé¡¯ç¤ºé€£æ¥æ­£å¸¸
- âœ… æ‰€æœ‰æœå‹™é‹è¡Œæ­£å¸¸

---

**ä¸‹ä¸€æ­¥**ï¼šè«‹æª¢æŸ¥ Cloudflare Dashboard ä¸­çš„ Public Hostname é…ç½®ï¼Œç¢ºèª Service URL æ˜¯ `http://nginx:80`ã€‚

