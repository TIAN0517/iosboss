# å®¹å™¨ç©©å®šæ€§æœ€ä½³å¯¦è¸æŒ‡å—

## ğŸ“Š ç•¶å‰é…ç½®åˆ†æ

### âœ… å·²é…ç½®çš„è‰¯å¥½å¯¦è¸

1. **é‡å•Ÿç­–ç•¥**ï¼šæ‰€æœ‰æœå‹™ä½¿ç”¨ `restart: always`
2. **å¥åº·æª¢æŸ¥**ï¼šä¸»è¦æœå‹™éƒ½æœ‰å¥åº·æª¢æŸ¥é…ç½®
3. **è³‡æºé™åˆ¶**ï¼šæ‰€æœ‰æœå‹™éƒ½é…ç½®äº† CPU å’Œå…§å­˜é™åˆ¶
4. **æ—¥èªŒç®¡ç†**ï¼šé…ç½®äº†æ—¥èªŒè¼ªè½‰å’Œå£“ç¸®
5. **ä¾è³´ç®¡ç†**ï¼šä½¿ç”¨ `depends_on` ç¢ºä¿å•Ÿå‹•é †åº
6. **ç¶²çµ¡éš”é›¢**ï¼šä½¿ç”¨è‡ªå®šç¾© bridge ç¶²çµ¡

### âš ï¸ å¯æ”¹é€²çš„åœ°æ–¹

1. **å¥åº·æª¢æŸ¥è¶…æ™‚å’Œé‡è©¦ç­–ç•¥**ï¼šéƒ¨åˆ†æœå‹™å¯èƒ½éœ€è¦èª¿æ•´
2. **ä¾è³´é—œä¿‚**ï¼šå¯ä»¥æ›´æ˜ç¢ºåœ°å®šç¾©æœå‹™ä¾è³´
3. **å•Ÿå‹•é †åº**ï¼šå¯ä»¥æ·»åŠ å•Ÿå‹•å»¶é²é¿å…ç«¶æ…‹æ¢ä»¶
4. **è³‡æºé™åˆ¶**ï¼šå¯èƒ½éœ€è¦æ ¹æ“šå¯¦éš›ä½¿ç”¨æƒ…æ³èª¿æ•´
5. **DNS é…ç½®**ï¼šå¯ä»¥æ·»åŠ å‚™ç”¨ DNS æœå‹™å™¨

---

## ğŸ¯ ç©©å®šæ€§æ”¹é€²æ–¹æ¡ˆ

### 1. å„ªåŒ–é‡å•Ÿç­–ç•¥

**ç•¶å‰é…ç½®**ï¼š`restart: always`

**å»ºè­°**ï¼š
- âœ… **æ ¸å¿ƒæœå‹™**ï¼ˆapp, postgres, nginxï¼‰ï¼šä½¿ç”¨ `restart: always` - ä»»ä½•æƒ…æ³ä¸‹éƒ½é‡å•Ÿ
- âœ… **é—œéµæœå‹™**ï¼ˆcloudflaredï¼‰ï¼šä½¿ç”¨ `restart: always` - å¿…é ˆä¿æŒé€£æ¥
- âš ï¸ **è¼”åŠ©æœå‹™**ï¼ˆbackup, call-display, sync-websocketï¼‰ï¼šå¯è€ƒæ…® `restart: unless-stopped` - å…è¨±æ‰‹å‹•åœæ­¢

**åŸå› **ï¼š
- `always`ï¼šDocker å®ˆè­·é€²ç¨‹é‡å•Ÿæ™‚ä¹Ÿæœƒè‡ªå‹•å•Ÿå‹•ï¼ˆæœ€ç©©å®šï¼‰
- `unless-stopped`ï¼šæ‰‹å‹•åœæ­¢å¾Œä¸æœƒè‡ªå‹•å•Ÿå‹•ï¼ˆé©åˆè¼”åŠ©æœå‹™ï¼‰

### 2. å¢å¼·å¥åº·æª¢æŸ¥

**æ”¹é€²å»ºè­°**ï¼š

```yaml
# app æœå‹™
healthcheck:
  test: ["CMD-SHELL", "curl -f http://localhost:9999/api/health || exit 1"]
  interval: 15s        # æª¢æŸ¥é–“éš”ï¼ˆç•¶å‰é…ç½®ï¼‰
  timeout: 10s         # è¶…æ™‚æ™‚é–“ï¼ˆå»ºè­°å¢åŠ åˆ° 10sï¼‰
  retries: 5           # é‡è©¦æ¬¡æ•¸ï¼ˆå»ºè­°å¢åŠ åˆ° 5 æ¬¡ï¼‰
  start_period: 60s    # å•Ÿå‹•å¯¬é™æœŸï¼ˆå»ºè­°å¢åŠ åˆ° 60sï¼‰

# postgres æœå‹™
healthcheck:
  test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-gas_management}"]
  interval: 10s
  timeout: 5s
  retries: 5           # å»ºè­°å¢åŠ åˆ° 5 æ¬¡
  start_period: 30s    # å»ºè­°å¢åŠ åˆ° 30s

# nginx æœå‹™
healthcheck:
  test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1/health || exit 1"]
  interval: 20s        # å»ºè­°èª¿æ•´ç‚º 20s
  timeout: 5s
  retries: 3
  start_period: 15s
```

### 3. å®Œå–„ä¾è³´é—œä¿‚

**ç•¶å‰é…ç½®**ï¼š
```yaml
depends_on:
  postgres:
    condition: service_healthy
```

**æ”¹é€²å»ºè­°**ï¼š
```yaml
# app æœå‹™
depends_on:
  postgres:
    condition: service_healthy
  # å¯ä»¥æ·»åŠ æ›´å¤šä¾è³´æª¢æŸ¥

# nginx æœå‹™
depends_on:
  app:
    condition: service_healthy
  postgres:
    condition: service_started  # é–“æ¥ä¾è³´

# cloudflared æœå‹™
depends_on:
  nginx:
    condition: service_healthy
```

### 4. æ·»åŠ å•Ÿå‹•å»¶é²

**å•é¡Œ**ï¼šæœå‹™å¯èƒ½åŒæ™‚å•Ÿå‹•ï¼Œå°è‡´ç«¶æ…‹æ¢ä»¶

**è§£æ±ºæ–¹æ¡ˆ**ï¼šåœ¨å•Ÿå‹•è…³æœ¬ä¸­æ·»åŠ å»¶é²ï¼Œæˆ–åœ¨ docker-compose ä¸­ä½¿ç”¨ `depends_on` çš„ `service_started` æ¢ä»¶

### 5. å„ªåŒ–è³‡æºé™åˆ¶

**ç•¶å‰é…ç½®**ï¼š
- app: 2 CPU, 2GB å…§å­˜
- postgres: 1 CPU, 1GB å…§å­˜
- nginx: 0.5 CPU, 256MB å…§å­˜

**å»ºè­°**ï¼šæ ¹æ“šå¯¦éš›ç›£æ§æ•¸æ“šèª¿æ•´ï¼Œä½†ç•¶å‰é…ç½®åŸºæœ¬åˆç†

### 6. æ·»åŠ  DNS é…ç½®

**æ”¹é€²å»ºè­°**ï¼š
```yaml
services:
  app:
    dns:
      - 8.8.8.8        # Google DNS
      - 8.8.4.4        # Google DNS å‚™ç”¨
      - 1.1.1.1        # Cloudflare DNS
    dns_search:
      - jyt-network
```

### 7. ç¶²çµ¡é…ç½®å„ªåŒ–

**ç•¶å‰é…ç½®**ï¼š
```yaml
networks:
  jyt-network:
    driver: bridge
```

**å»ºè­°**ï¼šä¿æŒ bridge æ¨¡å¼ï¼Œé€™æ˜¯ Docker Compose çš„æœ€ä½³å¯¦è¸

### 8. æ·»åŠ æœå‹™æ¨™ç±¤

**æ”¹é€²å»ºè­°**ï¼š
```yaml
services:
  app:
    labels:
      - "com.jyt.service=app"
      - "com.jyt.version=${APP_VERSION:-latest}"
      - "com.jyt.environment=production"
```

---

## ğŸ”§ å…·é«”æ”¹é€²é…ç½®

### æ”¹é€²å¾Œçš„ docker-compose.yml é—œéµéƒ¨åˆ†

```yaml
services:
  app:
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9999/api/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      postgres:
        condition: service_healthy
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
    labels:
      - "com.jyt.service=app"
      - "com.jyt.environment=production"

  postgres:
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-gas_management}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  nginx:
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 15s
    depends_on:
      app:
        condition: service_healthy

  cloudflared:
    restart: always
    depends_on:
      nginx:
        condition: service_healthy
    # æ³¨æ„ï¼šcloudflared é¡åƒç‚º distrolessï¼Œç„¡æ³•åŸ·è¡Œå¥åº·æª¢æŸ¥
    # é€šéæ—¥èªŒå’Œé€£æ¥ç‹€æ…‹ç¢ºèªé‹è¡Œç‹€æ…‹
```

---

## ğŸ“ˆ ç©©å®šæ€§ç›£æ§å»ºè­°

### 1. å®¹å™¨ç‹€æ…‹ç›£æ§

```powershell
# æª¢æŸ¥æ‰€æœ‰å®¹å™¨ç‹€æ…‹
docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Health}}"

# æª¢æŸ¥å®¹å™¨å¥åº·ç‹€æ…‹
docker inspect --format='{{.State.Health.Status}}' jyt-gas-app
```

### 2. è³‡æºä½¿ç”¨ç›£æ§

```powershell
# æŸ¥çœ‹å®¹å™¨è³‡æºä½¿ç”¨
docker stats --no-stream

# æŸ¥çœ‹ç‰¹å®šå®¹å™¨çš„è³‡æºä½¿ç”¨
docker stats jyt-gas-app --no-stream
```

### 3. æ—¥èªŒç›£æ§

```powershell
# æŸ¥çœ‹å®¹å™¨æ—¥èªŒ
docker logs --tail 100 -f jyt-gas-app

# æŸ¥çœ‹å¥åº·æª¢æŸ¥æ—¥èªŒ
docker inspect jyt-gas-app | Select-String -Pattern "Health"
```

---

## ğŸ¯ æœ€ä½³å¯¦è¸ç¸½çµ

### ç©©å®šæ€§å„ªå…ˆç´š

1. **æœ€é«˜å„ªå…ˆç´š**ï¼š
   - âœ… ä½¿ç”¨ `restart: always` ç¢ºä¿è‡ªå‹•é‡å•Ÿ
   - âœ… é…ç½®å¥åº·æª¢æŸ¥ä¸¦è¨­ç½®åˆç†çš„é‡è©¦æ¬¡æ•¸
   - âœ… ä½¿ç”¨ `depends_on` ç¢ºä¿å•Ÿå‹•é †åº

2. **é«˜å„ªå…ˆç´š**ï¼š
   - âœ… é…ç½®è³‡æºé™åˆ¶é˜²æ­¢è³‡æºè€—ç›¡
   - âœ… é…ç½®æ—¥èªŒè¼ªè½‰é˜²æ­¢ç£ç›¤æ»¿
   - âœ… ä½¿ç”¨è‡ªå®šç¾©ç¶²çµ¡éš”é›¢æœå‹™

3. **ä¸­å„ªå…ˆç´š**ï¼š
   - âœ… æ·»åŠ  DNS é…ç½®æé«˜ç¶²çµ¡ç©©å®šæ€§
   - âœ… æ·»åŠ æœå‹™æ¨™ç±¤ä¾¿æ–¼ç®¡ç†
   - âœ… ç›£æ§å®¹å™¨ç‹€æ…‹å’Œè³‡æºä½¿ç”¨

### å®¹å™¨æŠ€è¡“é¸æ“‡

**ç•¶å‰ä½¿ç”¨ï¼šDocker + Docker Compose**

**æ¨è–¦ç†ç”±**ï¼š
- âœ… **æˆç†Ÿç©©å®š**ï¼šDocker æ˜¯æœ€æˆç†Ÿçš„å®¹å™¨æŠ€è¡“
- âœ… **ç”Ÿæ…‹è±å¯Œ**ï¼šæœ‰å¤§é‡å·¥å…·å’Œæ–‡æª”æ”¯æŒ
- âœ… **è·¨å¹³å°**ï¼šæ”¯æŒ Windowsã€Linuxã€macOS
- âœ… **æ˜“æ–¼ç®¡ç†**ï¼šDocker Compose ç°¡åŒ–å¤šå®¹å™¨ç®¡ç†
- âœ… **ç”Ÿç”¢å°±ç·’**ï¼šå»£æ³›ç”¨æ–¼ç”Ÿç”¢ç’°å¢ƒ

**å…¶ä»–é¸é …å°æ¯”**ï¼š
- **Podman**ï¼šç„¡å®ˆè­·é€²ç¨‹ï¼Œä½†ç”Ÿæ…‹ä¸å¦‚ Docker è±å¯Œ
- **containerd**ï¼šæ›´åº•å±¤ï¼Œéœ€è¦æ›´å¤šé…ç½®
- **Kubernetes**ï¼šéæ–¼è¤‡é›œï¼Œé©åˆå¤§è¦æ¨¡éƒ¨ç½²

**çµè«–**ï¼š**Docker + Docker Compose æ˜¯æœ€ç©©å®šå¥½ç”¨çš„é¸æ“‡**ï¼Œç‰¹åˆ¥é©åˆä¸­å°å‹é …ç›®ã€‚

---

## ğŸš€ å¯¦æ–½å»ºè­°

1. **ç«‹å³å¯¦æ–½**ï¼š
   - å„ªåŒ–å¥åº·æª¢æŸ¥é…ç½®ï¼ˆå¢åŠ é‡è©¦æ¬¡æ•¸å’Œè¶…æ™‚æ™‚é–“ï¼‰
   - æ·»åŠ  DNS é…ç½®
   - å®Œå–„ä¾è³´é—œä¿‚

2. **çŸ­æœŸå¯¦æ–½**ï¼š
   - æ·»åŠ æœå‹™æ¨™ç±¤
   - å„ªåŒ–è³‡æºé™åˆ¶ï¼ˆæ ¹æ“šç›£æ§æ•¸æ“šï¼‰
   - å¢å¼·ç›£æ§è…³æœ¬

3. **é•·æœŸå„ªåŒ–**ï¼š
   - æ ¹æ“šå¯¦éš›ä½¿ç”¨æƒ…æ³èª¿æ•´é…ç½®
   - å»ºç«‹å®Œæ•´çš„ç›£æ§å’Œå‘Šè­¦ç³»çµ±
   - å®šæœŸå¯©æŸ¥å’Œå„ªåŒ–é…ç½®

---

## ğŸ“ æ³¨æ„äº‹é …

1. **å¥åº·æª¢æŸ¥ç«¯é»**ï¼šç¢ºä¿ `/api/health` ç«¯é»å­˜åœ¨ä¸”æ­£å¸¸å·¥ä½œ
2. **è³‡æºé™åˆ¶**ï¼šæ ¹æ“šå¯¦éš›è² è¼‰èª¿æ•´ï¼Œé¿å…éåº¦é™åˆ¶
3. **æ—¥èªŒç®¡ç†**ï¼šå®šæœŸæ¸…ç†èˆŠæ—¥èªŒï¼Œé˜²æ­¢ç£ç›¤æ»¿
4. **å‚™ä»½ç­–ç•¥**ï¼šç¢ºä¿æ•¸æ“šå·æœ‰å®šæœŸå‚™ä»½
5. **ç¶²çµ¡å®‰å…¨**ï¼šä½¿ç”¨å…§éƒ¨ç¶²çµ¡ï¼Œé¿å…æš´éœ²ä¸å¿…è¦çš„ç«¯å£

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-01-27
**ç¶­è­·è€…**ï¼šJyæŠ€è¡“åœ˜éšŠ
