# 九九瓦斯行 - 公司 MSSQL 同步工具

## 開機自動同步版 ✨

**特點：**
- ✅ 會計下班可以關機
- ✅ 開機後自動同步關機期間的所有數據
- ✅ 開機期間每 60 秒定期同步
- ✅ 記錄同步時間，不會重複同步

---

## 使用流程

```
上午 9:00 會計開機
    ↓
啟動同步工具（自動或手動）
    ↓
同步昨天下午 6:00 到今天的所有數據
    ↓
上班期間每 60 秒定期同步新數據
    ↓
下午 6:00 會計下班，關機
    ↓
明天開機，再自動同步...
```

---

## 安裝步驟

### 第一步：安裝 Node.js

1. 訪問 https://nodejs.org/
2. 下載並安裝 **LTS 版本**
3. 安裝完成後重啟電腦

### 第二步：部署同步工具

將 `company-sync` 資料夾複製到公司電腦，建議位置：
- `C:\JytGasSync\`

進入資料夾，雙擊 **`install.bat`** 安裝相依套件

### 第三步：配置資料庫

用記事本打開 **`config.json`**，修改以下內容：

```json
{
  "mssql": {
    "server": "localhost",              // 或內網 IP
    "port": 1433,
    "database": "JYT_GAS_DB",           // ← 改成你們的資料庫名稱
    ...
  },
  "tables": {
    "orders": "Orders",                 // ← 訂單表名稱
    "customers": "Customers",           // ← 客戶表名稱
    "inventory": "Inventory"            // ← 庫存表名稱
  }
}
```

---

## 啟動方式

### 方式 A：手動啟動（推薦）

每天會計上班後，雙擊 **`start-sync.bat`**

會看到：
```
╔══════════════════════════════════════════╗
║   九九瓦斯行 - MSSQL 開機自動同步工具   ║
╚══════════════════════════════════════════╝

✓ 已連接到 MSSQL 資料庫 (Windows 驗證)

🚀 開機首次同步（同步關機期間的數據）...

==================================================
2024/12/26 上午 09:00:00 - 開始同步
上次同步: 2024/12/25 下午 06:30:00
==================================================

📋 同步訂單...
  找到 15 筆訂單需要同步
  ✓ order.created
  ✓ order.created
  ...
  ✓ 訂單同步完成: 15/15 成功

👥 同步客戶...
  找到 3 筆客戶需要同步
  ✓ 客戶同步完成: 3/3 成功

📦 同步庫存...
  沒有庫存變動

==================================================
✓ 同步完成！
  訂單: 15 筆
  客戶: 3 筆
  庫存: 0 筆
  總計: 18 筆
  耗時: 3.5 秒
==================================================

⏰ 啟動定時同步（每 60 秒）...
```

### 方式 B：開機自動啟動

1. 按 `Win + R`
2. 輸入 `shell:startup`
3. 把 `start-sync.bat` 的捷徑複製到開啟的資料夾

這樣開機後會自動啟動同步工具！

---

## 關閉同步工具

### 方式 A：手動關閉

在同步工具視窗按 `Ctrl + C`

會顯示：
```
正在關閉服務...
✓ 已停止，可以安全關機
```

### 方式 B：直接關機

直接關機電腦也可以，同步工具會自動停止。

---

## 同步狀態文件

同步工具會自動建立 **`last-sync.json`** 記錄同步時間：

```json
{
  "lastSyncTime": "2024-12-26T09:05:00.000Z",
  "syncCount": 125
}
```

**不要刪除這個文件！** 它用於：
- 記錄上次同步時間
- 下次開機同步差异数據
- 避免重複同步

---

## 查看同步記錄

同步工具視窗會顯示：
- 每次同步的數量
- 同步成功或失敗
- 錯誤訊息（如果有）

---

## 測試步驟

### 1. 測試連線

```bash
# 在命令提示字元執行：
sqlcmd -S localhost -d 你的資料庫名稱 -E
```

如果能進入 `1>` 提示符，表示連線成功。

### 2. 測試同步

1. 在單機版軟件建立一個測試訂單
2. 雙擊 `start-sync.bat`
3. 看到「找到 1 筆訂單需要同步」
4. 訪問 https://bossai.jytian.it.com
5. 確認訂單出現

---

## 常見問題

### Q1：關機後數據會丟失嗎？

**A：不會！** 數據保存在 MSSQL 中，關機不會影響。下次開機會同步這期間的所有新數據。

### Q2：同步工具必須 24 小時開著嗎？

**A：不需要！** 會計下班關機就可以。第二天開機會自動同步差异数據。

### Q3：如果忘記開同步工具怎麼辦？

**A：沒關係！** 下次開啟時會同步累積的所有數據。

### Q4：同步失敗會怎樣？

**A：**
- 同步失敗不會影響 MSSQL 中的數據
- 下次同步會重試
- 可以在視窗看到錯誤訊息

### Q5：可以同步很久以前的數據嗎？

**A：** 首次運行會同步最近 7 天的數據。如果要同步更早的數據，請聯繫技術支援。

---

## 修改同步間隔

如果不想要 60 秒同步一次，可以修改 `config.json`：

```json
{
  "sync": {
    "intervalSeconds": 300,    // 改成 5 分鐘 (300秒)
    ...
  }
}
```

---

## 檔案說明

| 檔案 | 說明 | 不要刪除 |
|------|------|----------|
| `sync.js` | 主程式 | ❌ |
| `config.json` | 配置文件 | ❌ |
| `last-sync.json` | 同步狀態（自動生成） | ❌ |
| `package.json` | Node.js 配置 | ❌ |
| `install.bat` | 安裝腳本 | ✅ 可以刪除 |
| `start-sync.bat` | 啟動腳本 | ❌ |
| `node_modules/` | 相依套件（自動生成） | ✅ 可以重新安裝 |

---

## 需要協助？

如果遇到問題：

1. 檢查同步工具視窗的錯誤訊息
2. 確認網路連線正常
3. 確認 MSSQL 正在運行
4. 檢查 `config.json` 配置是否正確
