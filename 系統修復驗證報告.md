# ç³»çµ±ä¿®å¾©é©—è­‰å ±å‘Š

## ğŸ“Š é©—è­‰æ™‚é–“
2025-12-28 22:05

---

## âœ… å·²ç¢ºèªä¿®å¾©çš„é …ç›®

### 1. LINE Group IDs ç’°å¢ƒè®Šæ•¸ âœ…
**ç‹€æ…‹**ï¼šå·²ä¿®å¾©ä¸¦ç”Ÿæ•ˆ

**é©—è­‰çµæœ**ï¼š
- âœ… `docker-compose.yml` ä¸­å·²æ·»åŠ ï¼ˆç¬¬ 55-57 è¡Œï¼‰
- âœ… å®¹å™¨å…§ç’°å¢ƒè®Šæ•¸å­˜åœ¨ï¼š
  - `LINE_ADMIN_GROUP_ID=C986ae8b3208735b53872a6d609a7bbe7`
  - `LINE_DRIVER_GROUP_ID=C4bfd4b93d29f090fa2b18885d8ad7d12`
  - `LINE_SALES_GROUP_ID=PLACEHOLDER_REPLACE_WITH_ACTUAL_GROUP_ID`

---

### 2. å…¶ä»–ç’°å¢ƒè®Šæ•¸ âœ…
**ç‹€æ…‹**ï¼šå·²æ·»åŠ ä¸¦ç”Ÿæ•ˆ

**é©—è­‰çµæœ**ï¼š
- âœ… å®¹å™¨å…§å…±æœ‰ **77 å€‹ç’°å¢ƒè®Šæ•¸**
- âœ… æ‰€æœ‰é—œéµç’°å¢ƒè®Šæ•¸éƒ½å·²æ·»åŠ ï¼š
  - é…é€ç®¡ç†ï¼š`DISPATCH_AUTO_ASSIGN_ENABLED`, `DISPATCH_AUTO_ASSIGN_RADIUS`
  - å¸æ©Ÿä½ç½®è¿½è¹¤ï¼š`DRIVER_LOCATION_TRACKING_ENABLED`, `DRIVER_LOCATION_UPDATE_INTERVAL`, `DRIVER_LOCATION_RETENTION_DAYS`
  - è»Šè¨Šå¿«éï¼š`VEHICLE_EXPRESS_ENABLED`, `VEHICLE_EXPRESS_SMS_ENABLED` ç­‰ 10 å€‹è®Šæ•¸
  - æœƒè¨ˆåŒæ­¥ï¼š`ACCOUNTING_SYNC_ENABLED`, `ACCOUNTING_SYNC_API_KEY` ç­‰ 4 å€‹è®Šæ•¸
  - åº«å­˜ç®¡ç†ï¼š`MIN_STOCK_ALERT_LEVEL`
  - Webhookï¼š`WEBHOOK_TIMEOUT`, `WEBHOOK_RETRY_COUNT`, `WEBHOOK_SIGNATURE_SECRET`
  - GLM èªéŸ³ï¼š`GLM_STT_MODEL`, `GLM_TTS_MODEL`, `TTS_VOICE`, `TTS_SPEED`, `TTS_PITCH`

---

### 3. é‡å•Ÿç­–ç•¥çµ±ä¸€ âœ…
**ç‹€æ…‹**ï¼šå·²çµ±ä¸€ç‚º `always`

**é©—è­‰çµæœ**ï¼š
- âœ… `jyt-gas-app`: `always`
- âœ… `jyt-gas-postgres`: `always`
- âœ… `jyt-gas-nginx`: `always`
- âœ… `jyt-gas-cloudflared`: `always`
- âœ… `jyt-gas-backup`: `always`

---

### 4. Docker Compose é…ç½®èªæ³• âœ…
**ç‹€æ…‹**ï¼šé…ç½®æ­£ç¢º

**é©—è­‰çµæœ**ï¼š
- âœ… `docker compose config` ç„¡éŒ¯èª¤
- âœ… æ‰€æœ‰æœå‹™å®šç¾©æ­£ç¢º

---

## âš ï¸ ç™¼ç¾çš„å•é¡Œ

### å•é¡Œ 1ï¼šCloudflared å¥åº·æª¢æŸ¥é…ç½®éŒ¯èª¤ âŒ
**ä½ç½®**ï¼š`docker-compose.yml` ç¬¬ 311 è¡Œ

**å•é¡Œæè¿°**ï¼š
- ç•¶å‰å¥åº·æª¢æŸ¥å‘½ä»¤ï¼š`timeout 5s cloudflared tunnel info || exit 1`
- éŒ¯èª¤ï¼š`cloudflared tunnel info` éœ€è¦ä¸€å€‹åƒæ•¸ï¼ˆtunnel ID æˆ–åç¨±ï¼‰
- çµæœï¼šå®¹å™¨ç‹€æ…‹ç‚º `unhealthy`

**æ­£ç¢ºçš„ä¿®å¾©æ–¹æ³•**ï¼š
```yaml
healthcheck:
  test: ["CMD-SHELL", "curl -f http://127.0.0.1:2000/metrics || exit 1"]
  # æˆ–ä½¿ç”¨ï¼š
  # test: ["CMD-SHELL", "timeout 5s cloudflared tunnel info ${CF_TUNNEL_ID} || exit 1"]
```

**æ³¨æ„**ï¼šé›–ç„¶å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œä½† cloudflared å¯¦éš›é‹è¡Œæ­£å¸¸ï¼ˆæ—¥èªŒé¡¯ç¤ºé€£æ¥å·²å»ºç«‹ï¼‰

---

### å•é¡Œ 2ï¼šæ–°å¢æœå‹™æœªé‹è¡Œ âš ï¸
**ç™¼ç¾çš„æœå‹™**ï¼š
- `call-display-service`ï¼ˆç¬¬ 379 è¡Œï¼‰- ä¾†é›»é¡¯ç¤º WebSocket æœå‹™
- `sync-websocket-service`ï¼ˆç¬¬ 422 è¡Œï¼‰- å³æ™‚åŒæ­¥ WebSocket æœå‹™

**ç‹€æ…‹**ï¼š
- æœå‹™å·²åœ¨ `docker-compose.yml` ä¸­å®šç¾©
- ä½†å®¹å™¨æœªé‹è¡Œï¼ˆ`docker ps` ä¸­æœªé¡¯ç¤ºï¼‰

**å¯èƒ½åŸå› **ï¼š
1. æœå‹™æœªå•Ÿå‹•ï¼ˆéœ€è¦ `docker compose up -d`ï¼‰
2. æ§‹å»ºå¤±æ•—ï¼ˆç¼ºå°‘ Dockerfileï¼‰
3. ä¾è³´æœå‹™æœªå°±ç·’

**å»ºè­°æª¢æŸ¥**ï¼š
```bash
# æª¢æŸ¥æœå‹™ç‹€æ…‹
docker compose ps call-display-service sync-websocket-service

# æŸ¥çœ‹æ§‹å»ºæ—¥èªŒ
docker compose logs call-display-service
docker compose logs sync-websocket-service

# å˜—è©¦å•Ÿå‹•
docker compose up -d call-display-service sync-websocket-service
```

---

## ğŸ“‹ æœå‹™ç‹€æ…‹ç¸½è¦½

| æœå‹™åç¨± | ç‹€æ…‹ | å¥åº·æª¢æŸ¥ | é‡å•Ÿç­–ç•¥ |
|---------|------|---------|---------|
| jyt-gas-app | âœ… é‹è¡Œä¸­ | âœ… healthy | âœ… always |
| jyt-gas-postgres | âœ… é‹è¡Œä¸­ | âœ… healthy | âœ… always |
| jyt-gas-nginx | âœ… é‹è¡Œä¸­ | âœ… healthy | âœ… always |
| jyt-gas-cloudflared | âœ… é‹è¡Œä¸­ | âŒ unhealthy | âœ… always |
| jyt-gas-backup | âœ… é‹è¡Œä¸­ | - | âœ… always |
| jyt-gas-call-display | â“ æœªé‹è¡Œ | - | âœ… always |
| jyt-gas-sync-websocket | â“ æœªé‹è¡Œ | - | âœ… always |

---

## ğŸ”§ éœ€è¦ä¿®å¾©çš„å•é¡Œ

### å„ªå…ˆç´š 1ï¼šä¿®å¾© Cloudflared å¥åº·æª¢æŸ¥

**ä¿®å¾©æ­¥é©Ÿ**ï¼š
1. æ‰“é–‹ `docker-compose.yml`
2. æ‰¾åˆ° `cloudflared` æœå‹™çš„ `healthcheck` å€å¡Šï¼ˆç¬¬ 310-315 è¡Œï¼‰
3. å°‡å¥åº·æª¢æŸ¥å‘½ä»¤æ”¹ç‚ºï¼š
   ```yaml
   healthcheck:
     test: ["CMD-SHELL", "curl -f http://127.0.0.1:2000/metrics || exit 1"]
     interval: 30s
     timeout: 10s
     retries: 3
     start_period: 10s
   ```
4. ä¿å­˜ä¸¦é‡å•Ÿæœå‹™ï¼š
   ```bash
   docker compose up -d cloudflared
   ```

### å„ªå…ˆç´š 2ï¼šæª¢æŸ¥æ–°å¢æœå‹™

**æª¢æŸ¥æ­¥é©Ÿ**ï¼š
1. æª¢æŸ¥ `mini-services/call-display-service/Dockerfile` æ˜¯å¦å­˜åœ¨
2. æª¢æŸ¥ `mini-services/sync-websocket-service/Dockerfile` æ˜¯å¦å­˜åœ¨
3. å¦‚æœå­˜åœ¨ï¼Œå˜—è©¦æ§‹å»ºå’Œå•Ÿå‹•ï¼š
   ```bash
   docker compose build call-display-service sync-websocket-service
   docker compose up -d call-display-service sync-websocket-service
   ```
4. å¦‚æœä¸éœ€è¦é€™äº›æœå‹™ï¼Œå¯ä»¥å¾ `docker-compose.yml` ä¸­ç§»é™¤

---

## âœ… ç¸½çµ

### å·²å®Œæˆçš„ä¿®å¾©ï¼ˆ4/5ï¼‰
- âœ… LINE Group IDs ç’°å¢ƒè®Šæ•¸
- âœ… å…¶ä»–ç’°å¢ƒè®Šæ•¸ï¼ˆ30+ å€‹ï¼‰
- âœ… é‡å•Ÿç­–ç•¥çµ±ä¸€
- âœ… Docker Compose é…ç½®èªæ³•

### å¾…ä¿®å¾©çš„å•é¡Œï¼ˆ1/5ï¼‰
- âŒ Cloudflared å¥åº·æª¢æŸ¥é…ç½®éŒ¯èª¤

### éœ€è¦ç¢ºèªçš„äº‹é …ï¼ˆ1ï¼‰
- â“ æ–°å¢æœå‹™ï¼ˆcall-display-service, sync-websocket-serviceï¼‰æ˜¯å¦éœ€è¦é‹è¡Œ

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡Œå‹•

1. **ç«‹å³ä¿®å¾©**ï¼šCloudflared å¥åº·æª¢æŸ¥é…ç½®
2. **ç¢ºèª**ï¼šæ–°å¢æœå‹™æ˜¯å¦éœ€è¦é‹è¡Œ
3. **é©—è­‰**ï¼šä¿®å¾©å¾Œé‡æ–°æª¢æŸ¥æ‰€æœ‰æœå‹™ç‹€æ…‹

---

## ğŸ“ é©—è­‰å‘½ä»¤

```bash
# æª¢æŸ¥æ‰€æœ‰ç’°å¢ƒè®Šæ•¸
docker exec jyt-gas-app printenv | grep -E "LINE_|VEHICLE_|DISPATCH_|DRIVER_|ACCOUNTING_|WEBHOOK_|TTS_"

# æª¢æŸ¥é‡å•Ÿç­–ç•¥
docker inspect jyt-gas-app --format '{{.HostConfig.RestartPolicy.Name}}'
docker inspect jyt-gas-postgres --format '{{.HostConfig.RestartPolicy.Name}}'
docker inspect jyt-gas-nginx --format '{{.HostConfig.RestartPolicy.Name}}'
docker inspect jyt-gas-cloudflared --format '{{.HostConfig.RestartPolicy.Name}}'
docker inspect jyt-gas-backup --format '{{.HostConfig.RestartPolicy.Name}}'

# æª¢æŸ¥æœå‹™ç‹€æ…‹
docker compose ps

# æª¢æŸ¥é…ç½®èªæ³•
docker compose config
```
