# GLM-4.7 å•†æ¥­ç‰ˆå®Œæ•´åŠŸèƒ½æ•´åˆæŒ‡å—

## ğŸ“‹ ç›®éŒ„

1. [åŠŸèƒ½æ¦‚è¦½](#-åŠŸèƒ½æ¦‚è¦½)
2. [å¿«é€Ÿé–‹å§‹](#-å¿«é€Ÿé–‹å§‹)
3. [è©³ç´°èªªæ˜](#-è©³ç´°èªªæ˜)
4. [é…ç½®èªªæ˜](#-é…ç½®èªªæ˜)
5. [ä½¿ç”¨ç¤ºä¾‹](#-ä½¿ç”¨ç¤ºä¾‹)
6. [å¸¸è¦‹å•é¡Œ](#-å¸¸è¦‹å•é¡Œ)

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¦½

GLM-4.7 å•†æ¥­ç‰ˆï¼ˆCoding MAXï¼‰æ˜¯ GLM ç³»åˆ—ä¸­æœ€å¼·çš„**ç·¨ç¢¼å°ˆç”¨æ¨¡å‹**ï¼Œç‚ºæ‚¨æä¾›äº†ä»¥ä¸‹å•†æ¥­ç´šåŠŸèƒ½ï¼š

### ğŸš€ æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | èªªæ˜ | æ‡‰ç”¨å ´æ™¯ | å¯¦ç¾æ–‡ä»¶ |
|------|------|----------|----------|
| **æ€è€ƒæ¨¡å¼ï¼ˆThinkingï¼‰** | åœ¨å›ç­”å‰é¡¯ç¤º AI çš„æ¨ç†éç¨‹ | è¤‡é›œå•é¡Œ | `glm-enhanced.ts` |
| **æµå¼éŸ¿æ‡‰ï¼ˆStreamingï¼‰** | å¯¦æ™‚é¡¯ç¤ºå›æ‡‰å…§å®¹ï¼Œæå‡é«”é©— | æ‰€æœ‰èŠå¤©åŠŸèƒ½ | `glm-enhanced.ts` |
| **API Key è¼ªæ›** | æ”¯æŒå¤šå€‹ API Key è‡ªå‹•è¼ªè©¢å’Œæ•…éšœè½‰ç§» | é«˜å¯ç”¨æ€§ä¿éšœ | `glm-enhanced.ts` |
| **å‡½æ•¸èª¿ç”¨ï¼ˆFunction Callingï¼‰** | æ”¯æŒè‡ªå®šç¾©å·¥å…·/å‡½æ•¸èª¿ç”¨ | æŸ¥è©¢åº«å­˜ã€å‰µå»ºè¨‚å–® | `glm-enhanced.ts` |
| **Token ä½¿ç”¨é‡çµ±è¨ˆ** | è¿½è¹¤å’Œé¡¯ç¤º API èª¿ç”¨æƒ…æ³ | æˆæœ¬ç›£æ§ | `glm-enhanced.ts` |
| **æœ¬åœ°å›é€€æ©Ÿåˆ¶** | API ä¸å¯ç”¨æ™‚ä½¿ç”¨æœ¬åœ°æ™ºèƒ½å›æ‡‰ | ä¿éšœæœå‹™å¯ç”¨æ€§ | `route.ts` + `stt-fallback.ts` |

### ğŸ¨ äº®é»

- âœ… **æœ€å¼·ç·¨ç¢¼èƒ½åŠ›** - GLM-4.7-Coding-Max æ˜¯ GLM å®¶æ—ä¸­æœ€å¼·çš„ä»£ç¢¼ç†è§£æ¨¡å‹
- âœ… **æ€è€ƒæ¨¡å¼** - å¯ä»¥çœ‹åˆ° AI çš„æ¨ç†éç¨‹ï¼Œå¢å¼·å¯è§£é‡‹æ€§
- âœ… **æµå¼é«”é©—** - å›æ‡‰å³æ™‚é¡¯ç¤ºï¼Œç„¡éœ€ç­‰å¾…å®Œæ•´å›ç­”
- âœ… **æ™ºèƒ½å®¹éŒ¯** - è‡ªå‹•é‡è©¦ã€Key è¼ªæ›ã€æœ¬åœ°å›é€€
- âœ… **å•†å‹™ç´šç©©å®šæ€§** - å¤š Key è¼ªè©¢ã€é™ç´šæ©Ÿåˆ¶
- âœ… **å®Œæ•´ç”Ÿæ…‹æ”¯æŒ** - æ”¯æŒèŠå¤©ã€èªéŸ³ã€åŠ©æ‰‹ç­‰å¤šå€‹æ¨¡å¼

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### æ–¹å¼ 1ï¼šå‡ç´šç¾æœ‰ç³»çµ±ï¼ˆæ¨è–¦ï¼‰

**æ­¥é©Ÿ 1ï¼šå‚™ä»½ç¾æœ‰ä»£ç¢¼**
```powershell
# å‰µå»ºå‚™ä»½æ–‡ä»¶å¤¾
mkdir -p backups\glm-enhanced
Copy-Item src\lib\ai-provider.ts, src\app\api\ai\chat\route.ts backups\glm-enhanced\
```

**æ­¥é©Ÿ 2ï¼šæ‡‰ç”¨æ–°çš„å¢å¼·åŠŸèƒ½**
```typescript
// å°‡ route.ts ä¸­çš„ GLMProvider æ›¿æ›ç‚º GLMEnhancedProvider
import { GLMEnhancedProvider } from '@/lib/glm-enhanced';
```

**æ­¥é©Ÿ 3ï¼šæ›´æ–°ç’°å¢ƒè®Šé‡**
```env
# å•Ÿç”¨æ€è€ƒæ¨¡å¼ï¼ˆé»˜èªé–‹å•Ÿï¼‰
GLM_ENABLE_THINKING=true

# å•Ÿç”¨æµå¼éŸ¿æ‡‰ï¼ˆé»˜èªé–‹å•Ÿï¼‰
GLM_ENABLE_STREAMING=true

# é…ç½®å¤šå€‹ API Keyï¼ˆä½¿ç”¨è‹±æ–‡é€—è™Ÿåˆ†éš”ï¼‰
GLM_API_KEYS=key1,key2,key3

# å•Ÿç”¨å•†æ¥­ç‰ˆæ¨¡å‹ï¼ˆCoding Maxï¼‰
GLM_MODEL=glm-4.7-coding-max

# å¯é¸ï¼šé…ç½®è¶…æ™‚æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
GLM_TIMEOUT=60000
```

**æ­¥é©Ÿ 4ï¼šæ¸¬è©¦ç³»çµ±**
```powershell
# é‡å•Ÿé–‹ç™¼æœå‹™
npm run dev

# åœ¨ç€è¦½å™¨ä¸­æ¸¬è©¦ AI èŠå¤©åŠŸèƒ½
```

### æ–¹å¼ 2ï¼šå…¨æ–°éƒ¨ç½²

å¦‚æœå¾é ­é–‹å§‹éƒ¨ç½²ï¼Œç¢ºä¿æ‰€æœ‰æ–‡ä»¶å·²æ­£ç¢ºå‰µå»ºä¸¦é…ç½®ã€‚

---

## ğŸ“– è©³ç´°èªªæ˜

### 1. æ€è€ƒæ¨¡å¼ï¼ˆThinking Modeï¼‰

**ä»€éº¼æ˜¯æ€è€ƒæ¨¡å¼ï¼Ÿ**

æ€è€ƒæ¨¡å¼è®“ GLM-4.7 åœ¨çµ¦å‡ºæœ€çµ‚ç­”æ¡ˆä¹‹å‰ï¼Œå…ˆå±•ç¤ºå®ƒçš„**æ¨ç†éç¨‹**ã€‚é€™è®“ç”¨æˆ¶èƒ½å¤ ï¼š

- ğŸ¤” ç†è§£ AI çš„æ€è€ƒé‚è¼¯
- ğŸ“Š æª¢æŸ¥æ¨ç†çš„é‚è¼¯æ€§å’Œé‚è¼¯æ€§
- ğŸ” ç™¼ç¾å¯èƒ½çš„éŒ¯èª¤ä¸¦åœ¨çµ¦å‡ºæœ€çµ‚ç­”æ¡ˆå‰ä¿®æ­£
- ğŸ“ˆ å¢å¼·å°è¤‡é›œå•é¡Œçš„è™•ç†èƒ½åŠ›

**å¦‚ä½•ä½¿ç”¨ï¼Ÿ**

åœ¨è«‹æ±‚ä¸­å•Ÿç”¨æ€è€ƒæ¨¡å¼æ™‚ï¼š

```typescript
import { GLMEnhancedProvider } from '@/lib/glm-enhanced';

const aiProvider = new GLMEnhancedProvider({
  enableThinking: true,  // å•Ÿç”¨æ€è€ƒæ¨¡å¼
});

const response = await aiProvider.chat("è«‹å¹«æˆ‘åˆ†æé€™å€‹è¤‡é›œçš„å•†æ¥­å•é¡Œ", {
  conversationHistory: []
});
```

**æ€è€ƒè¼¸å‡ºæ ¼å¼ï¼š**

AI æœƒè¿”å›ä¸€å€‹ `thinking` å­—æ®µï¼ŒåŒ…å«æ¨ç†éç¨‹çš„æ–‡æœ¬æè¿°ã€‚

```json
{
  "content": "ç¶“éåˆ†æï¼Œæˆ‘å»ºè­°...",
  "thinking": "1. é¦–å…ˆï¼Œè®“æˆ‘åˆ†æé€™å€‹å•é¡Œçš„å„å€‹æ–¹é¢...\n2. å¾æˆæœ¬è§’åº¦ä¾†çœ‹ï¼Œæ–¹æ¡ˆA æ›´å…·å„ªå‹¢...\n3. è€ƒæ…®åˆ°å®¢æˆ¶çš„é•·æœŸåˆ©ç›Šï¼Œæ–¹æ¡ˆB ä¹Ÿå¯è¡Œ...\n4. ç¶œåˆåˆ†æå¾Œï¼Œæˆ‘èªç‚º..."
}
```

**é©ç”¨å ´æ™¯ï¼š**

- ğŸ§® **è¤‡é›œåˆ†æ** - éœ€è¦é€æ­¥æ¨ç†çš„æ•¸å­¸ã€é‚è¼¯ã€æ¥­å‹™åˆ†æ
- ğŸ“Š **æ•¸æ“šçµ±è¨ˆ** - éœ€è¦è™•ç†å¤§é‡æ•¸æ“šä¸¦ç”Ÿæˆå ±å‘Š
- ğŸ§© **ç®—æ³•è¨­è¨ˆ** - éœ€è¦è©•ä¼°ä¸åŒç­–ç•¥çš„å„ªåŠ£
- ğŸ’¼ **é¢¨éšªè©•ä¼°** - éœ€è¦åˆ†ææ½›åœ¨é¢¨éšªå’Œç·©è§£æªæ–½

---

### 2. æµå¼éŸ¿æ‡‰ï¼ˆStreamingï¼‰

**ä»€éº¼æ˜¯æµå¼éŸ¿æ‡‰ï¼Ÿ**

å‚³çµ±æ–¹å¼æ˜¯ç­‰å¾… AI å®Œæ•´å›ç­”å¾Œä¸€æ¬¡æ€§è¿”å›ã€‚æµå¼éŸ¿æ‡‰å‰‡è®“ AI **é‚Šç”Ÿæˆé‚Šå›æ‡‰**ï¼Œå³å¯¦æ™‚é¡¯ç¤ºå›ç­”å…§å®¹ã€‚

**å„ªå‹¢ï¼š**

- âš¡ **æ›´å¿«çš„é«”é©—** - ç”¨æˆ¶ä¸éœ€è¦ç­‰å¾…å®Œæ•´ç”Ÿæˆ
- ğŸ’¬ **æ›´é•·çš„æ–‡æœ¬ä¹Ÿå¯ä»¥æµå¼é¡¯ç¤º** - ä¸æœƒå› ç‚ºæ–‡æœ¬éé•·è¢«æˆªæ–·
- ğŸ¯ **æ›´è‡ªç„¶çš„å°è©±æ„Ÿè¦º** - å°±åƒå’ŒçœŸäººä¸€æ¨£ä¸€é‚Šèªªè©±
- ğŸ“Š **å¯ä»¥åŠæ™‚åœæ­¢ç”Ÿæˆ** - ç¯€çœ token å’Œæˆæœ¬

**å¦‚ä½•ä½¿ç”¨ï¼Ÿ**

```typescript
import { GLMEnhancedProvider } from '@/lib/glm-enhanced';

const aiProvider = new GLMEnhancedProvider({
  enableStreaming: true,  // å•Ÿç”¨æµå¼éŸ¿æ‡‰
});

// ä½¿ç”¨æµå¼èŠå¤©
const streamGenerator = await aiProvider.chatStream(
  "è«‹å¯«ä¸€é¦–é—œæ–¼ä¹ä¹ç“¦æ–¯è¡Œçš„è©©",
  { onChunk: (chunk) => {
    console.log('æ”¶åˆ°æ–°å…§å®¹:', chunk.content);
    // å¯¦æ™‚æ›´æ–° UI é¡¯ç¤º
  }}
);

for await (const chunk of streamGenerator) {
  // chunk.content åŒ…å«ç•¶å‰å›æ‡‰ç‰‡æ®µ
}
```

**æµå¼éŸ¿æ‡‰çš„å…§å®¹ï¼š**

```typescript
interface StreamChunk {
  content: string;    // å›æ‡‰å…§å®¹ç‰‡æ®µ
  thinking?: string;  // æ€è€ƒå…§å®¹ï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
  done: boolean;      // æ˜¯å¦æ˜¯æœ€å¾Œä¸€å€‹ç‰‡æ®µ
}
```

---

### 3. API Key è¼ªæ›ï¼ˆMulti-Key Rotationï¼‰

**ä»€éº¼æ˜¯ API Key è¼ªæ›ï¼Ÿ**

ç³»çµ±æ”¯æŒé…ç½®**å¤šå€‹ API Key**ï¼Œç•¶ä¸€å€‹ Key å¤±æ•—æˆ–é”åˆ°é…é¡æ™‚ï¼Œè‡ªå‹•åˆ‡æ›åˆ°ä¸‹ä¸€å€‹å¯ç”¨çš„ Keyã€‚

**å„ªå‹¢ï¼š**

- ğŸ”„ **é«˜å¯ç”¨æ€§** - å–®å€‹ Key æ•…éšœä¸æœƒå½±éŸ¿æ•´é«”æœå‹™
- ğŸ’° **æˆæœ¬å„ªåŒ–** - å¯ä»¥é…ç½®ä¸åŒç´šåˆ¥çš„ Key ç”¨æ–¼ä¸åŒå ´æ™¯
- ğŸ“Š **é…é¡ç®¡ç†** - è¨­ç½®æ¯å€‹ Key çš„ä½¿ç”¨é™é¡
- ğŸ›¡ï¸ **å®‰å…¨å®¹éŒ¯** - è‡ªå‹•å¤±æ•ˆçš„ Key æœƒè¢«è·³éï¼Œé˜²æ­¢æŒçºŒè«‹æ±‚å¤±æ•—

**å¦‚ä½•ä½¿ç”¨ï¼Ÿ**

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®å¤šå€‹ Keyï¼š

```env
# é…ç½®å¤šå€‹ GLM API Keyï¼ˆè‹±æ–‡é€—è™Ÿåˆ†éš”ï¼‰
GLM_API_KEYS=key1,key2,key3,key4

# ç³»çµ±æœƒè‡ªå‹•è¼ªè©¢ä½¿ç”¨ï¼Œç•¶å‰ Key å¤±æ•—æ™‚åˆ‡æ›åˆ°ä¸‹ä¸€å€‹
```

**è¼ªè©¢ç­–ç•¥ï¼š**

- âœ… **é †åºè¼ªè©¢** - å¾ key1 â†’ key2 â†’ key3 â†’ key4 â†’ key1
- âš ï¸ **æ™ºèƒ½é‡è©¦** - å¤±æ•—çš„ Key æœƒè¢«æ¨™è¨˜ï¼Œæš«æ™‚è·³é
- ğŸ”„ **è‡ªå‹•æ¢å¾©** - ç•¶ Key æ¨™è¨˜æˆåŠŸå¾Œè‡ªå‹•æ¢å¾©ä½¿ç”¨

**Key å¤±æ•—åˆ¤æ–·ï¼š**

- HTTP 401 - API Key ç„¡æ•ˆ
- HTTP 403 - API Key é•é‡è¶…é™
- HTTP 429 - è«‹æ±‚é »ç‡éé«˜
- ç¶²çµ¡éŒ¯èª¤ - ç„¡æ³•é€£æ¥åˆ° API

---

### 4. å‡½æ•¸èª¿ç”¨ï¼ˆFunction Callingï¼‰

**ä»€éº¼æ˜¯å‡½æ•¸èª¿ç”¨ï¼Ÿ**

å…è¨± AI ç›´æ¥èª¿ç”¨æ‚¨ç³»çµ±ä¸­å®šç¾©çš„å‡½æ•¸æˆ–å·¥å…·ï¼Œè€Œä¸åªæ˜¯ç”Ÿæˆæ–‡æœ¬ã€‚é€™è®“ AI èƒ½å¤ ï¼š

- ğŸ” æŸ¥è©¢æ•¸æ“šåº« - æŸ¥è©¢åº«å­˜ã€å®¢æˆ¶è³‡æ–™
- ğŸ“ å‰µå»ºè¨‚å–® - æ ¹æ“šå®¢æˆ¶éœ€æ±‚å‰µå»ºæ–°çš„è¨‚å–®
- ğŸ“Š è¨ˆç®—çµ±è¨ˆ - è¨ˆç®—ç‡Ÿæ”¶ã€åº«å­˜æƒ…æ³
- ğŸ”„ åŒæ­¥å¤–éƒ¨ç³»çµ± - èª¿ç”¨å·ç´€ API åŒæ­¥åº«å­˜

**å¦‚ä½•ä½¿ç”¨ï¼Ÿ**

åœ¨ `glm-enhanced.ts` ä¸­å·²é å®šç¾©äº†å·¥å…·å®šç¾©ï¼ˆTOOL_DEFINITIONSï¼‰ï¼š

```typescript
import { GLMEnhancedProvider, TOOL_DEFINITIONS } from '@/lib/glm-enhanced';

const aiProvider = new GLMEnhancedProvider({
  enableTools: true,  // å•Ÿç”¨å·¥å…·èª¿ç”¨
});

// ä½¿ç”¨å·¥å…·æŸ¥è©¢åº«å­˜
const response = await aiProvider.chatWithTools(
  "è«‹æŸ¥è©¢ç›®å‰çš„ç“¦æ–¯åº«å­˜ç‹€æ³ï¼Œç‰¹åˆ¥æ˜¯é‹¼ç“¶çš„æ•¸é‡",
  [TOOL_DEFINITIONS.query_inventory]
);
```

**å·¥å…·èª¿ç”¨éŸ¿æ‡‰æ ¼å¼ï¼š**

```json
{
  "content": "æ ¹æ“šæŸ¥è©¢çµæœï¼Œç›®å‰é‹¼ç“¶åº«å­˜ï¼š500 å€‹ï¼Œåº«å­˜å……è¶³...",
  "tool_calls": [
    {
      "name": "query_inventory",
      "arguments": "{\"item_type\": \"gas\", \"status\": \"all\"}",
      "output": "gas_cylinder_stock: 500"
    }
  ]
}
```

---

### 5. Token ä½¿ç”¨é‡çµ±è¨ˆ

**ä»€éº¼æ˜¯ Token çµ±è¨ˆï¼Ÿ**

ç³»çµ±æœƒè¿½è¹¤æ¯æ¬¡ API èª¿ç”¨æ¶ˆè€—çš„ token æ•¸é‡ï¼Œä¸¦åœ¨éŸ¿æ‡‰ä¸­è¿”å›ä½¿ç”¨æƒ…æ³ã€‚é€™è®“æ‚¨èƒ½å¤ ï¼š

- ğŸ“Š **ç›£æ§æˆæœ¬** - å¯¦æ™‚äº†è§£ API èª¿ç”¨æƒ…æ³
- ğŸ’° **è¨­ç½®é ç®—** - é¿å…è¶…é¡è²»ç”¨
- ğŸ“ˆ **è¶¨å‹¢åˆ†æ** - åˆ†æä½¿ç”¨é‡çš„å¢é•·è¶¨å‹¢
- ğŸ¯ **å„ªåŒ–ç­–ç•¥** - æ ¹æ“šä½¿ç”¨é‡èª¿æ•´æç¤ºå’Œé…ç½®

**çµ±è¨ˆæ•¸æ“šï¼š**

- `prompt_tokens` - æç¤ºæ¶ˆè€—çš„ token æ•¸é‡
- `completion_tokens` - å®Œæˆæ¶ˆè€—çš„ token æ•¸é‡
- `total_tokens` - ç¸½æ¶ˆè€— token æ•¸é‡ï¼ˆé€šå¸¸ = prompt + completionï¼‰

**å¦‚ä½•ä½¿ç”¨ï¼Ÿ**

æ¯å€‹ API éŸ¿æ‡‰éƒ½æœƒè¿”å› `usage` å°è±¡ï¼š

```json
{
  "content": "æ ¹æ“šæŸ¥è©¢çµæœ...",
  "usage": {
    "prompt_tokens": 150,
    "completion_tokens": 300,
    "total_tokens": 450
  }
}
```

---

## ğŸ“– é…ç½®èªªæ˜

### ç’°å¢ƒè®Šé‡é…ç½®

| è®Šé‡åç¨± | é»˜èªå€¼ | èªªæ˜ | å»ºè­°å€¼ |
|----------|--------|------|----------|
| `GLM_API_KEY` | - | å–®å€‹ API Keyï¼ˆèˆŠç‰ˆå…¼å®¹ï¼‰ | é…ç½®æ‚¨çš„ Key |
| `GLM_API_KEYS` | - | å¤šå€‹ API Keyï¼ˆæ–°ç‰ˆæ¨è–¦ï¼‰ | key1,key2,key3 |
| `GLM_MODEL` | `glm-4.7-coding-max` | æ¨¡å‹é¸æ“‡ | ä¿æŒå•†æ¥­ç‰ˆæ¨¡å‹ |
| `GLM_ENABLE_THINKING` | `true` | æ€è€ƒæ¨¡å¼é–‹é—œ | ä¿æŒé–‹å•Ÿä»¥ç²å¾—æ›´å¥½é«”é©— |
| `GLM_ENABLE_STREAMING` | `true` | æµå¼éŸ¿æ‡‰é–‹é—œ | ä¿æŒé–‹å•Ÿä»¥ç²å¾—æ›´å¿«éŸ¿æ‡‰ |
| `GLM_TIMEOUT` | `60000` | è¶…æ™‚æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰ | 60 ç§’è¶³å¤  |
| `GLM_MAX_RETRIES` | `3` | æœ€å¤§é‡è©¦æ¬¡æ•¸ | ä¿æŒé»˜èªå€¼ |
| `GLM_ENABLE_FALLBACK` | `true` | æœ¬åœ°å›é€€é–‹é—œ | ä¿æŒé–‹å•Ÿä»¥æé«˜å¯ç”¨æ€§ |

### é«˜ç´šé…ç½®

#### æ€è€ƒæ¨¡å¼é…ç½®

```env
GLM_THINKING_TEMPERATURE=0.9
```

#### æµå¼éŸ¿æ‡‰é…ç½®

```env
GLM_STREAM_BUFFER_SIZE=100
```

#### æ¨¡å‹é¸æ“‡

GLM æä¾›äº†å¤šå€‹æ¨¡å‹é¸æ“‡ï¼š

| æ¨¡å‹ | é©ç”¨å ´æ™¯ | ç‰¹é» | Token åƒ¹æ ¼ |
|------|----------|------|----------|
| `glm-4.7-coding-max` | **ç·¨ç¢¼å’Œæ¨ç†** | æœ€å¼·ç·¨ç¢¼èƒ½åŠ›ï¼Œæ¨è–¦ç”¨æ–¼è¤‡é›œåˆ†æ | - |
| `glm-4.7-flash` | **å¿«é€ŸéŸ¿æ‡‰** | é€Ÿåº¦å¿«ï¼Œé©åˆç°¡å–®å°è©± | - |
| `glm-4.7` | **é€šç”¨å°è©±** | å¹³è¡¡æ€§èƒ½å’Œæˆæœ¬ï¼Œæ¨è–¦æ—¥å¸¸ä½¿ç”¨ | - |

**æ¨è–¦é…ç½®ï¼š**

ç”Ÿç”¢ç’°å¢ƒä¿æŒä½¿ç”¨ `glm-4.7-coding-max` ä»¥ç²å¾—æœ€ä½³æ•ˆæœã€‚

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šä½¿ç”¨æ€è€ƒæ¨¡å¼è™•ç†è¤‡é›œæ¥­å‹™å•é¡Œ

```typescript
// src/app/api/ai/assistant/route.ts
import { GLMEnhancedProvider } from '@/lib/glm-enhanced';

export async function POST(request: Request) {
  const { message } = await request.json();
  
  // å‰µå»ºå¢å¼· AI æä¾›å•†ï¼ˆå•Ÿç”¨æ€è€ƒæ¨¡å¼ï¼‰
  const aiProvider = new GLMEnhancedProvider({
    enableThinking: true,  // å•Ÿç”¨æ€è€ƒæ¨¡å¼
    enableStreaming: true,  // åŒæ™‚å•Ÿç”¨æµå¼éŸ¿æ‡‰
  });
  
  // ç™¼é€è«‹æ±‚ï¼ˆæœƒå…ˆçœ‹åˆ°æ€è€ƒéç¨‹ï¼‰
  const response = await aiProvider.chatStream(
    "ä½œç‚ºä¹ä¹ç“¦æ–¯è¡Œçš„ AI åŠ©æ‰‹ï¼Œè«‹å¹«æˆ‘åˆ†æä»¥ä¸‹å•†æ¥­å•é¡Œï¼š\n\nå•é¡Œï¼šæˆ‘å€‘çš„é‹¼ç“¶åº«å­˜ç®¡ç†ç³»çµ±éœ€è¦é€²è¡Œå„ªåŒ–ï¼Œä»¥é™ä½åº«å­˜æˆæœ¬ä¸¦æé«˜è½‰åŒ–ç‡ã€‚ç›®å‰æˆ‘å€‘æœ‰ä¸‰å€‹å€‰åº«ï¼Œåº«å­˜æ•¸æ“šä¸çµ±ä¸€ã€‚è«‹åˆ†æå¯èƒ½çš„å„ªåŒ–æ–¹æ¡ˆã€‚",
    {
      conversationHistory: [],  // ç©ºå°è©±æ­·å²
    }
  );
  
  // è™•ç†æµå¼éŸ¿æ‡‰ï¼ˆåŒ…å«æ€è€ƒéç¨‹å’Œæœ€çµ‚ç­”æ¡ˆï¼‰
  for await (const chunk of response) {
    if (chunk.thinking) {
      // é¡¯ç¤º AI æ€è€ƒéç¨‹ï¼ˆæ¨ç†æ­¥é©Ÿï¼‰
      console.log('ğŸ¤” AI æ­£åœ¨æ€è€ƒ:', chunk.thinking);
      // æ›´æ–° UI é¡¯ç¤ºæ€è€ƒç‹€æ…‹
    } else if (chunk.content) {
      // é¡¯ç¤ºæœ€çµ‚ç­”æ¡ˆæˆ–å›æ‡‰ç‰‡æ®µ
      console.log('ğŸ’¬ AI å›æ‡‰:', chunk.content);
      // å¯¦æ™‚æ›´æ–°èŠå¤©ç•Œé¢
    }
  }
  
  return NextResponse.json({
    content: '',  // æµå¼æœ€çµ‚æœƒåŒ…å«æ‰€æœ‰å…§å®¹
    source: 'glm-enhanced-api',
  });
}
```

### ç¤ºä¾‹ 2ï¼šä½¿ç”¨å‡½æ•¸èª¿ç”¨æŸ¥è©¢åº«å­˜

```typescript
// ä½¿ç”¨ GLM çš„ Function Calling åŠŸèƒ½
import { GLMEnhancedProvider, TOOL_DEFINITIONS } from '@/lib/glm-enhanced';

export async function POST(request: Request) {
  const { message } = await request.json();
  
  // å‰µå»º AI æä¾›å•†
  const aiProvider = new GLMEnhancedProvider({
    enableTools: true,  // å•Ÿç”¨å·¥å…·èª¿ç”¨
  });
  
  // ä½¿ç”¨é å®šç¾©çš„å·¥å…·æŸ¥è©¢åº«å­˜
  const response = await aiProvider.chatWithTools(
    "è«‹å¹«æˆ‘æŸ¥è©¢é‹¼ç“¶çš„åº«å­˜ç‹€æ³ï¼Œç‰¹åˆ¥æ˜¯åº«å­˜ä½æ–¼å®‰å…¨åº«å­˜ï¼ˆ5000 ç“¶ï¼‰çš„æ•¸é‡ã€‚",
    [TOOL_DEFINITIONS.query_inventory]  // å‚³éæŸ¥è©¢åº«å­˜çš„å·¥å…·
    {
      conversationHistory: [],
    }
  );
  
  // è™•ç†å·¥å…·èª¿ç”¨çµæœ
  if (response.tool_calls && response.tool_calls.length > 0) {
    const inventoryCall = response.tool_calls.find(call => call.name === 'query_inventory');
    
    if (inventoryCall) {
      const args = JSON.parse(inventoryCall.arguments);
      console.log('ğŸ“Š åº«å­˜æŸ¥è©¢çµæœ:', args.output);
      
      // æ ¹æ“šæŸ¥è©¢çµæœæ¡å–è¡Œå‹•
      if (args.output.gas_cylinder_stock < 5000) {
        return NextResponse.json({
          content: `âš ï¸ è­¦å ±ï¼šé‹¼ç“¶åº«å­˜ä½æ–¼å®‰å…¨åº«å­˜ï¼ç›®å‰æ•¸é‡ï¼š${args.output.gas_cylinder_stock} ç“¶ï¼Œå»ºè­°è£œè²¨ã€‚`,
          tool_calls: response.tool_calls,
        });
      }
    }
  }
  
  return NextResponse.json({
    content: response.content || 'åº«å­˜æŸ¥è©¢å·²å®Œæˆï¼Œæ•¸é‡æ­£å¸¸ã€‚',
    source: 'glm-enhanced-api',
  });
}
```

### ç¤ºä¾‹ 3ï¼šå¤š API Key è¼ªæ›

```typescript
import { GLMEnhancedProvider } from '@/lib/glm-enhanced';

// å‰µå»ºå¤šå€‹ API Key çš„å¯¦ä¾‹
const aiProvider = new GLMEnhancedProvider({
  apiKeys: [
    process.env.GLM_API_KEY_1 || 'your_key_1',
    process.env.GLM_API_KEY_2 || 'your_key_2',
    process.env.GLM_API_KEY_3 || 'your_key_3',
  ],
  enableThinking: true,
  enableStreaming: true,
});

// ç³»çµ±æœƒè‡ªå‹•è¼ªè©¢ä½¿ç”¨é€™äº› Key
// ç•¶å‰ Key å¤±æ•—æˆ–è¶…é™æ™‚ï¼Œè‡ªå‹•åˆ‡æ›åˆ°ä¸‹ä¸€å€‹å¯ç”¨çš„ Key
```

---

## ğŸ› å¸¸è¦‹å•é¡Œ

### Q1: æ€è€ƒæ¨¡å¼å’Œæµå¼éŸ¿æ‡‰å¯ä»¥åŒæ™‚ä½¿ç”¨å—ï¼Ÿ

**A:** å¯ä»¥ï¼Œä½†ä¸æ¨è–¦ã€‚åŒæ™‚å•Ÿç”¨æœƒï¼š

- âš ï¸ å¢åŠ è¤‡é›œæ€§ - éœ€è¦åŒæ™‚è™•ç†æ€è€ƒè¼¸å‡ºå’Œæµå¼å…§å®¹
- ğŸ’° å¯èƒ½ç”¢ç”Ÿè¡çªçš„é¡¯ç¤ºé‚è¼¯
- ğŸ“Š é›£ä»¥é æ¸¬æº–ç¢ºçš„éŸ¿æ‡‰æ™‚é–“

**å»ºè­°ï¼š**
- å°æ–¼å¤§å¤šæ•¸æƒ…æ³ï¼Œé¸æ“‡**æµå¼éŸ¿æ‡‰** + **æ€è€ƒæ¨¡å¼** çµ„åˆ
- ç°¡å–®å°è©±å¯ä»¥ä½¿ç”¨æµå¼éŸ¿æ‡‰ï¼ˆä¸å•Ÿç”¨æ€è€ƒï¼‰
- è¤‡é›œå•é¡Œè™•ç†å•Ÿç”¨æ€è€ƒæ¨¡å¼ï¼Œç²å¾—æ›´æ¸…æ™°çš„åˆ†æ

### Q2: å¦‚ä½•è™•ç†æ€è€ƒæ¨¡å¼è¿”å›çš„éé•·æ€è€ƒå…§å®¹ï¼Ÿ

**A:** æ€è€ƒå…§å®¹å¯èƒ½å¾ˆé•·ï¼Œå»ºè­°ï¼š

1. **åˆ†é é¡¯ç¤º** - ä¸è¦ä¸€æ¬¡æ€§é¡¯ç¤ºæ‰€æœ‰æ€è€ƒå…§å®¹ï¼Œåˆ†é æˆ–æ‘ºç–Š
2. **å¯ç·¨è¼¯** - å…è¨±ç”¨æˆ¶å±•é–‹/æ‘ºç–Šè©³ç´°æ€è€ƒ
3. **æˆªæ–·é™åˆ¶** - æœ€å¤šé¡¯ç¤ºå‰ 2000 å­—ï¼Œè¶…ééƒ¨åˆ†ç”¨ã€Œ...ã€æ›¿æ›
4. **æ ¼å¼åŒ–** - ä½¿ç”¨åˆé©çš„æ›è¡Œå’Œç©ºæ ¼ï¼Œå¢å¼·å¯è®€æ€§

### Q3: API Key è¼ªæ›æ™‚æœƒä¸­æ–·ç•¶å‰è«‹æ±‚å—ï¼Ÿ

**A:** ä¸æœƒã€‚ç³»çµ±æœƒç­‰å¾…ç•¶å‰è«‹æ±‚å®Œæˆæˆ–å¤±æ•—å¾Œæ‰åˆ‡æ› Keyã€‚

- âœ… ç•¶å‰è«‹æ±‚æˆåŠŸï¼šä¸åˆ‡æ›
- âŒ ç•¶å‰è«‹æ±‚å¤±æ•—ï¼šåˆ‡æ›åˆ°ä¸‹ä¸€å€‹ Key ä¸¦é‡è©¦
- ğŸ”„ æ™ºèƒ½ Key æ¨™è¨˜ï¼šå¤±æ•—çš„ Key æœƒè¢«è·³éï¼Œé¿å…é‡è¤‡å¤±æ•—

### Q4: å¦‚ä½•èª¿æ•´æ€è€ƒæ¨¡å¼çš„è©³ç´°ç¨‹åº¦ï¼Ÿ

**A:** å¯ä»¥é€šéä¿®æ”¹ `THINKING_PROMPT` æˆ–èª¿æ•´ `GLM_THINKING_TEMPERATURE`ï¼š

- **æº«å’Œ**ï¼šé™ä½æº«åº¦è®“æ¨¡å‹æ›´å°ˆæ³¨ã€æ¸›å°‘å†—é¤˜
- **ç³»çµ±æ€§**ï¼šå¢åŠ çµæ§‹åŒ–æ¨ç†æ­¥é©Ÿï¼Œè®“æ¨¡å‹æŒ‰é †åºåˆ†æ

### Q5: æµå¼éŸ¿æ‡‰ä¸­çš„ `done` æ¨™è¨˜æ˜¯ä»€éº¼æ„æ€ï¼Ÿ

**A:** è¡¨ç¤ºç•¶å‰å›æ‡‰å·²å®Œå…¨ç”Ÿæˆï¼Œä¸å†æœ‰å¾ŒçºŒå…§å®¹ã€‚

- âœ… å¯ä»¥ç”¨æ–¼åˆ¤æ–·ä½•æ™‚åœæ­¢æµå¼éŸ¿æ‡‰
- âœ… å¯ä»¥ç”¨æ–¼è§¸ç™¼ UI çš„ã€Œå®Œæˆã€ç‹€æ…‹
- âš ï¸ ä¸æ˜¯æ‰€æœ‰æ¨¡å‹éƒ½æœƒæº–ç¢ºè¿”å› `done` æ¨™è¨˜ï¼Œéœ€è¦å®¹éŒ¯è™•ç†

### Q6: å¦‚ä½•ç›£æ§ Token ä½¿ç”¨æˆæœ¬ï¼Ÿ

**A:** æ¯å€‹ API éŸ¿æ‡‰éƒ½æœƒè¿”å› `usage` å°è±¡ï¼Œæ‚¨å¯ä»¥ï¼š

1. **ç´¯ç©çµ±è¨ˆ** - å°‡æ‰€æœ‰è«‹æ±‚çš„ token æ¶ˆè€—å­˜å…¥æ•¸æ“šåº«
2. **å¯¦æ™‚é¡¯ç¤º** - åœ¨ç”¨æˆ¶ç•Œé¢å¯¦æ™‚é¡¯ç¤ºç•¶å‰ token ä½¿ç”¨é‡
3. **é è­¦æ©Ÿåˆ¶** - è¨­ç½®é…é¡ï¼Œç•¶æ¥è¿‘æ™‚ç™¼é€è­¦å‘Š
4. **æˆæœ¬åˆ†æ** - æ ¹æ“š token æ¶ˆè€—è¨ˆç®— API è²»ç”¨æˆæœ¬

---

## ğŸ¯ å‡ç´šå»ºè­°å’Œæœ€ä½³å¯¦è¸

### éšæ®µ 1ï¼šæ¸¬è©¦éšæ®µï¼ˆ1-2 é€±ï¼‰

1. âœ… **é–‹ç™¼ç’°å¢ƒæ¸¬è©¦**
   - åœ¨æœ¬åœ°ç’°å¢ƒæ¸¬è©¦æ‰€æœ‰æ–°åŠŸèƒ½
   - ç¢ºä¿æ€è€ƒæ¨¡å¼æ­£å¸¸å·¥ä½œ
   - é©—è­‰æµå¼éŸ¿æ‡‰æ­£ç¢ºé¡¯ç¤º
   - æ¸¬è©¦ API Key è¼ªæ›é‚è¼¯

2. âœ… **å°æ‰¹é‡è©¦**
   - é¸è«‹ 10-20 å€‹å…§éƒ¨ç”¨æˆ¶æ¸¬è©¦
   - æ”¶é›†ä½¿ç”¨åé¥‹
   - è§€å¯Ÿå¯¦éš› token æ¶ˆè€—æƒ…æ³

3. âœ… **æ€§èƒ½ç›£æ§**
   - ç›£æ§ API éŸ¿æ‡‰æ™‚é–“
   - è¨˜éŒ„æˆåŠŸç‡ã€å¤±æ•—ç‡ã€å¹³å‡éŸ¿æ‡‰æ™‚é–“
   - å°æ¯”æ€è€ƒæ¨¡å¼å’Œæ™®é€šæ¨¡å¼çš„å·®ç•°

### éšæ®µ 2ï¼šç”Ÿç”¢éƒ¨ç½²ï¼ˆæ¨è–¦ï¼‰

1. âœ… **é…ç½®ç®¡ç†**
   - ç¢ºä¿æ‰€æœ‰ç’°å¢ƒè®Šé‡æ­£ç¢ºé…ç½®
   - åœ¨ `.env` ä¸­é…ç½®å¤šå€‹ API Key
   - è¨­ç½®åˆç†çš„è¶…æ™‚å’Œé‡è©¦æ¬¡æ•¸

2. âœ… **ç›£æ§å’Œæ—¥èªŒ**
   - å•Ÿç”¨ç›£æ§å®ˆè­·é€²ç¨‹ï¼ˆ`monitor-services.ps1`ï¼‰
   - å®šæœŸæª¢æŸ¥æ—¥èªŒï¼Œè¿½è¹¤ API Key ä½¿ç”¨æƒ…æ³
   - å»ºç«‹ Token ä½¿ç”¨é‡çµ±è¨ˆæ©Ÿåˆ¶

3. âœ… **å‚™ä»½å’Œå®¹ç½**
   - å®šæœŸå‚™ä»½æ•¸æ“šåº«
   - å»ºç«‹ç½é›£æ¢å¾©è¨ˆåŠƒ
   - ç¢ºä¿ç³»çµ±å…·å‚™æ•…éšœæ¢å¾©èƒ½åŠ›

4. âœ… **æˆæœ¬å„ªåŒ–**
   - æ ¹æ“šå¯¦éš›ä½¿ç”¨æƒ…æ³èª¿æ•´ API Key é…ç½®
   - å°æ–¼é«˜ç”¨é‡å ´æ™¯è€ƒæ…®ä½¿ç”¨å°ˆç”¨ Key
   - å¯¦æ–½è«‹æ±‚ç·©å­˜å’Œæ‰¹è™•ç†ç­–ç•¥

### éšæ®µ 3ï¼šå„ªåŒ–éšæ®µï¼ˆæŒçºŒï¼‰

1. âœ… **æ€§èƒ½èª¿å„ª**
   - æ ¹æ“šç›£æ§æ•¸æ“šå„ªåŒ–æ€è€ƒæç¤º
   - èª¿æ•´æµå¼éŸ¿æ‡‰çš„ç·©è¡å€å¤§å°
   - å¯¦æ–½æ™ºèƒ½çš„è«‹æ±‚è·¯ç”±

2. âœ… **åŠŸèƒ½æ”¹é€²**
   - æ ¹æ“šç”¨æˆ¶åé¥‹æŒçºŒæ”¹é€²æ€è€ƒæ¨¡å¼æç¤º
   - å„ªåŒ–å·¥å…·å®šç¾©ï¼Œä½¿å…¶æ›´ç¬¦åˆæ¥­å‹™éœ€æ±‚
   - æ¢ç´¢æ–°çš„ GLM æ¨¡å‹åŠŸèƒ½å’Œ API èƒ½åŠ›

3. âœ… **å®‰å…¨åŠ å›º**
   - å®šæœŸè¼ªæ› API Key
   - å¯¦æ–½è«‹æ±‚é »ç‡é™åˆ¶
   - æ·»åŠ é¡å¤–çš„å®‰å…¨é©—è­‰å±¤

---

## ğŸ“ æŠ€è¡“æ”¯æ´è³‡æº

### æ–‡æª”
- [GLM-4.7 å®˜æ–¹æ–‡æª”](https://open.bigmodel.cn/dev/docs)
- [GLM API åƒè€ƒæ–‡æª”](https://open.bigmodel.cn/docs/api)
- [æ€è€ƒæ¨¡å¼èªªæ˜](https://open.bigmodel.cn/docs/features/thinking_mode)
- [å‡½æ•¸èª¿ç”¨èªªæ˜](https://open.bigmodel.cn/docs/features/function_calling)

### å…§éƒ¨å¯¦ç¾æ–‡ä»¶
- `src/lib/glm-enhanced.ts` - å¢å¼· GLM æä¾›å•†å¯¦ç¾
- `src/lib/ai-provider.ts` - åŸå§‹ AI æä¾›å•†æ¥å£
- `src/app/api/ai/chat/route.ts` - AI èŠå¤©è·¯ç”±
- `src/components/ProfessionalChat.tsx` - å°ˆæ¥­ AI èŠå¤©çµ„ä»¶

### æ—¥èªŒå’Œç›£æ§
- `logs/monitor.log` - ç›£æ§å®ˆè­·é€²ç¨‹æ—¥èªŒ
- `docker compose logs` - Docker æœå‹™æ—¥èªŒ
- `diagnose-fix.ps1` - ç³»çµ±è¨ºæ–·å·¥å…·

---

## ğŸ‰ ç¸½çµ

GLM-4.7 å•†æ¥­ç‰ˆï¼ˆCoding MAXï¼‰ç‚ºæ‚¨çš„ä¹ä¹ç“¦æ–¯è¡Œç®¡ç†ç³»çµ±æä¾›äº†**ä¼æ¥­ç´šçš„ AI èƒ½åŠ›**ï¼š

### âœ… æ ¸å¿ƒå„ªå‹¢

1. ğŸš€ **æœ€å¼·ç·¨ç¢¼æ¨¡å‹** - å°ˆç‚ºä»£ç¢¼å’Œè¤‡é›œæ¨ç†å„ªåŒ–
2. ğŸ§  **æ€è€ƒæ¨¡å¼** - å¯è¦–åŒ–æ¨ç†éç¨‹ï¼Œå¢å¼·å¯è§£é‡‹æ€§
3. âš¡ **æµå¼éŸ¿æ‡‰** - å¯¦æ™‚é¡¯ç¤ºï¼Œæå‡ç”¨æˆ¶é«”é©—
4. ğŸ”„ **API Key è¼ªæ›** - é«˜å¯ç”¨æ€§ï¼Œæ™ºèƒ½æ•…éšœè½‰ç§»
5. ğŸ”§ **å‡½æ•¸èª¿ç”¨** - ç›´æ¥æ“ä½œæ¥­å‹™æ•¸æ“šï¼Œéˆæ´»æ“´å±•
6. ğŸ“Š **Token çµ±è¨ˆ** - ç²¾ç¢ºçš„æˆæœ¬ç›£æ§å’Œå„ªåŒ–
7. ğŸ›¡ï¸ **æœ¬åœ°å›é€€** - API ä¸å¯ç”¨æ™‚ä¿éšœæœå‹™ç©©å®š

### ğŸ¯ ä¸‹ä¸€æ­¥

1. **é–±è®€æœ¬æ–‡æª”** - å®Œå…¨äº†è§£æ‰€æœ‰æ–°åŠŸèƒ½
2. **æŸ¥çœ‹å¯¦ç¾æ–‡ä»¶** - ç ”ç©¶ `glm-enhanced.ts` çš„ä»£ç¢¼
3. **æº–å‚™å‡ç´š** - å‚™ä»½ç¾æœ‰ä»£ç¢¼
4. **æ¸¬è©¦æ–°åŠŸèƒ½** - åœ¨é–‹ç™¼ç’°å¢ƒé€æ­¥é©—è­‰
5. **é€æ­¥éƒ¨ç½²** - å…ˆå‡ç´šé–‹ç™¼ç’°å¢ƒï¼Œå†æ¨å»£åˆ°ç”Ÿç”¢

---

**æ›´æ–°æ—¥æœŸï¼š** 2025-12-29  
**ç‰ˆæœ¬ï¼š** 1.0  
**ç¶­è­·è€…ï¼š** JyæŠ€è¡“åœ˜éšŠ  
**æ–‡æª”åç¨±ï¼š** GLMå•†æ¥­ç‰ˆå®Œæ•´åŠŸèƒ½æ•´åˆæŒ‡å—.md

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼Œå……æ»¿ç™¼æ® GLM-4.7 çš„å¼·å¤§èƒ½åŠ›ï¼** ğŸš€âœ¨
